/*! wsc Built on: 2020-09-03 */
!function(){function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c||a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}return a}()({1:[function(a,b,c){"use strict";function d(a){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[a.type]||a.type}function e(a,b,c,d,e){var f=k.writeRtpDescription(a.kind,b);if(f+=k.writeIceParameters(a.iceGatherer.getLocalParameters()),f+=k.writeDtlsParameters(a.dtlsTransport.getLocalParameters(),"offer"===c?"actpass":e||"active"),f+="a=mid:"+a.mid+"\r\n",f+=a.rtpSender&&a.rtpReceiver?"a=sendrecv\r\n":a.rtpSender?"a=sendonly\r\n":a.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",a.rtpSender){var g=a.rtpSender._initialTrackId||a.rtpSender.track.id;a.rtpSender._initialTrackId=g;var h="msid:"+(d?d.id:"-")+" "+g+"\r\n";f+="a="+h,f+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" "+h,a.sendEncodingParameters[0].rtx&&(f+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" "+h,f+="a=ssrc-group:FID "+a.sendEncodingParameters[0].ssrc+" "+a.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return f+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" cname:"+k.localCName+"\r\n",a.rtpSender&&a.sendEncodingParameters[0].rtx&&(f+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" cname:"+k.localCName+"\r\n"),f}function f(a,b){var c=!1;return a=JSON.parse(JSON.stringify(a)),a.filter(function(a){if(a&&(a.urls||a.url)){var d=a.urls||a.url;a.url&&!a.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var e="string"==typeof d;return e&&(d=[d]),d=d.filter(function(a){var d=0===a.indexOf("turn:")&&-1!==a.indexOf("transport=udp")&&-1===a.indexOf("turn:[")&&!c;return d?(c=!0,!0):0===a.indexOf("stun:")&&b>=14393&&-1===a.indexOf("?transport=udp")}),delete a.url,a.urls=e?d[0]:d,!!d.length}})}function g(a,b){var c={codecs:[],headerExtensions:[],fecMechanisms:[]},d=function(a,b){a=parseInt(a,10);for(var c=0;c<b.length;c++)if(b[c].payloadType===a||b[c].preferredPayloadType===a)return b[c]},e=function(a,b,c,e){var f=d(a.parameters.apt,c),g=d(b.parameters.apt,e);return f&&g&&f.name.toLowerCase()===g.name.toLowerCase()};return a.codecs.forEach(function(d){for(var f=0;f<b.codecs.length;f++){var g=b.codecs[f];if(d.name.toLowerCase()===g.name.toLowerCase()&&d.clockRate===g.clockRate){if("rtx"===d.name.toLowerCase()&&d.parameters&&g.parameters.apt&&!e(d,g,a.codecs,b.codecs))continue;g=JSON.parse(JSON.stringify(g)),g.numChannels=Math.min(d.numChannels,g.numChannels),c.codecs.push(g),g.rtcpFeedback=g.rtcpFeedback.filter(function(a){for(var b=0;b<d.rtcpFeedback.length;b++)if(d.rtcpFeedback[b].type===a.type&&d.rtcpFeedback[b].parameter===a.parameter)return!0;return!1});break}}}),a.headerExtensions.forEach(function(a){for(var d=0;d<b.headerExtensions.length;d++){var e=b.headerExtensions[d];if(a.uri===e.uri){c.headerExtensions.push(e);break}}}),c}function h(a,b,c){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[b][a].indexOf(c)}function i(a,b){var c=a.getRemoteCandidates().find(function(a){return b.foundation===a.foundation&&b.ip===a.ip&&b.port===a.port&&b.priority===a.priority&&b.protocol===a.protocol&&b.type===a.type});return c||a.addRemoteCandidate(b),!c}function j(a,b){var c=new Error(b);return c.name=a,c.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[a],c}var k=a("sdp");b.exports=function(a,b){function c(b,c){c.addTrack(b),c.dispatchEvent(new a.MediaStreamTrackEvent("addtrack",{track:b}))}function l(b,c){c.removeTrack(b),c.dispatchEvent(new a.MediaStreamTrackEvent("removetrack",{track:b}))}function m(b,c,d,e){var f=new Event("track");f.track=c,f.receiver=d,f.transceiver={receiver:d},f.streams=e,a.setTimeout(function(){b._dispatchEvent("track",f)})}var n=function(c){var d=this,e=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(a){d[a]=e[a].bind(e)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",c=JSON.parse(JSON.stringify(c||{})),this.usingBundle="max-bundle"===c.bundlePolicy,"negotiate"===c.rtcpMuxPolicy)throw j("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(c.rtcpMuxPolicy||(c.rtcpMuxPolicy="require"),c.iceTransportPolicy){case"all":case"relay":break;default:c.iceTransportPolicy="all"}switch(c.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:c.bundlePolicy="balanced"}if(c.iceServers=f(c.iceServers||[],b),this._iceGatherers=[],c.iceCandidatePoolSize)for(var g=c.iceCandidatePoolSize;g>0;g--)this._iceGatherers.push(new a.RTCIceGatherer({iceServers:c.iceServers,gatherPolicy:c.iceTransportPolicy}));else c.iceCandidatePoolSize=0;this._config=c,this.transceivers=[],this._sdpSessionId=k.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(n.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(n.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),n.prototype.onicecandidate=null,n.prototype.onaddstream=null,n.prototype.ontrack=null,n.prototype.onremovestream=null,n.prototype.onsignalingstatechange=null,n.prototype.oniceconnectionstatechange=null,n.prototype.onconnectionstatechange=null,n.prototype.onicegatheringstatechange=null,n.prototype.onnegotiationneeded=null,n.prototype.ondatachannel=null,n.prototype._dispatchEvent=function(a,b){this._isClosed||(this.dispatchEvent(b),"function"==typeof this["on"+a]&&this["on"+a](b))},n.prototype._emitGatheringStateChange=function(){var a=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",a)},n.prototype.getConfiguration=function(){return this._config},n.prototype.getLocalStreams=function(){return this.localStreams},n.prototype.getRemoteStreams=function(){return this.remoteStreams},n.prototype._createTransceiver=function(a,b){var c=this.transceivers.length>0,d={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:a,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&c)d.iceTransport=this.transceivers[0].iceTransport,d.dtlsTransport=this.transceivers[0].dtlsTransport;else{var e=this._createIceAndDtlsTransports();d.iceTransport=e.iceTransport,d.dtlsTransport=e.dtlsTransport}return b||this.transceivers.push(d),d},n.prototype.addTrack=function(b,c){if(this._isClosed)throw j("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var d=this.transceivers.find(function(a){return a.track===b});if(d)throw j("InvalidAccessError","Track already exists.");for(var e,f=0;f<this.transceivers.length;f++)this.transceivers[f].track||this.transceivers[f].kind!==b.kind||(e=this.transceivers[f]);return e||(e=this._createTransceiver(b.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(c)&&this.localStreams.push(c),e.track=b,e.stream=c,e.rtpSender=new a.RTCRtpSender(b,e.dtlsTransport),e.rtpSender},n.prototype.addStream=function(a){var c=this;if(b>=15025)a.getTracks().forEach(function(b){c.addTrack(b,a)});else{var d=a.clone();a.getTracks().forEach(function(a,b){var c=d.getTracks()[b];a.addEventListener("enabled",function(a){c.enabled=a.enabled})}),d.getTracks().forEach(function(a){c.addTrack(a,d)})}},n.prototype.removeTrack=function(b){if(this._isClosed)throw j("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(b instanceof a.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var c=this.transceivers.find(function(a){return a.rtpSender===b});if(!c)throw j("InvalidAccessError","Sender was not created by this connection.");var d=c.stream;c.rtpSender.stop(),c.rtpSender=null,c.track=null,c.stream=null;var e=this.transceivers.map(function(a){return a.stream});-1===e.indexOf(d)&&this.localStreams.indexOf(d)>-1&&this.localStreams.splice(this.localStreams.indexOf(d),1),this._maybeFireNegotiationNeeded()},n.prototype.removeStream=function(a){var b=this;a.getTracks().forEach(function(a){var c=b.getSenders().find(function(b){return b.track===a});c&&b.removeTrack(c)})},n.prototype.getSenders=function(){return this.transceivers.filter(function(a){return!!a.rtpSender}).map(function(a){return a.rtpSender})},n.prototype.getReceivers=function(){return this.transceivers.filter(function(a){return!!a.rtpReceiver}).map(function(a){return a.rtpReceiver})},n.prototype._createIceGatherer=function(b,c){var d=this;if(c&&b>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var e=new a.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(e,"state",{value:"new",writable:!0}),this.transceivers[b].bufferedCandidateEvents=[],this.transceivers[b].bufferCandidates=function(a){var c=!a.candidate||0===Object.keys(a.candidate).length;e.state=c?"completed":"gathering",null!==d.transceivers[b].bufferedCandidateEvents&&d.transceivers[b].bufferedCandidateEvents.push(a)},e.addEventListener("localcandidate",this.transceivers[b].bufferCandidates),e},n.prototype._gather=function(b,c){var d=this,e=this.transceivers[c].iceGatherer;if(!e.onlocalcandidate){var f=this.transceivers[c].bufferedCandidateEvents;this.transceivers[c].bufferedCandidateEvents=null,e.removeEventListener("localcandidate",this.transceivers[c].bufferCandidates),e.onlocalcandidate=function(a){if(!(d.usingBundle&&c>0)){var f=new Event("icecandidate");f.candidate={sdpMid:b,sdpMLineIndex:c};var g=a.candidate,h=!g||0===Object.keys(g).length;if(h)("new"===e.state||"gathering"===e.state)&&(e.state="completed");else{"new"===e.state&&(e.state="gathering"),g.component=1,g.ufrag=e.getLocalParameters().usernameFragment;var i=k.writeCandidate(g);f.candidate=Object.assign(f.candidate,k.parseCandidate(i)),f.candidate.candidate=i,f.candidate.toJSON=function(){return{candidate:f.candidate.candidate,sdpMid:f.candidate.sdpMid,sdpMLineIndex:f.candidate.sdpMLineIndex,usernameFragment:f.candidate.usernameFragment}}}var j=k.getMediaSections(d._localDescription.sdp);h?j[f.candidate.sdpMLineIndex]+="a=end-of-candidates\r\n":j[f.candidate.sdpMLineIndex]+="a="+f.candidate.candidate+"\r\n",d._localDescription.sdp=k.getDescription(d._localDescription.sdp)+j.join("");var l=d.transceivers.every(function(a){return a.iceGatherer&&"completed"===a.iceGatherer.state});"gathering"!==d.iceGatheringState&&(d.iceGatheringState="gathering",d._emitGatheringStateChange()),h||d._dispatchEvent("icecandidate",f),l&&(d._dispatchEvent("icecandidate",new Event("icecandidate")),d.iceGatheringState="complete",d._emitGatheringStateChange())}},a.setTimeout(function(){f.forEach(function(a){e.onlocalcandidate(a)})},0)}},n.prototype._createIceAndDtlsTransports=function(){var b=this,c=new a.RTCIceTransport(null);c.onicestatechange=function(){b._updateIceConnectionState(),b._updateConnectionState()};var d=new a.RTCDtlsTransport(c);return d.ondtlsstatechange=function(){b._updateConnectionState()},d.onerror=function(){Object.defineProperty(d,"state",{value:"failed",writable:!0}),b._updateConnectionState()},{iceTransport:c,dtlsTransport:d}},n.prototype._disposeIceAndDtlsTransports=function(a){var b=this.transceivers[a].iceGatherer;b&&(delete b.onlocalcandidate,delete this.transceivers[a].iceGatherer);var c=this.transceivers[a].iceTransport;c&&(delete c.onicestatechange,delete this.transceivers[a].iceTransport);var d=this.transceivers[a].dtlsTransport;d&&(delete d.ondtlsstatechange,delete d.onerror,delete this.transceivers[a].dtlsTransport)},n.prototype._transceive=function(a,c,d){var e=g(a.localCapabilities,a.remoteCapabilities);c&&a.rtpSender&&(e.encodings=a.sendEncodingParameters,e.rtcp={cname:k.localCName,compound:a.rtcpParameters.compound},a.recvEncodingParameters.length&&(e.rtcp.ssrc=a.recvEncodingParameters[0].ssrc),a.rtpSender.send(e)),d&&a.rtpReceiver&&e.codecs.length>0&&("video"===a.kind&&a.recvEncodingParameters&&15019>b&&a.recvEncodingParameters.forEach(function(a){delete a.rtx}),a.recvEncodingParameters.length?e.encodings=a.recvEncodingParameters:e.encodings=[{}],e.rtcp={compound:a.rtcpParameters.compound},a.rtcpParameters.cname&&(e.rtcp.cname=a.rtcpParameters.cname),a.sendEncodingParameters.length&&(e.rtcp.ssrc=a.sendEncodingParameters[0].ssrc),a.rtpReceiver.receive(e))},n.prototype.setLocalDescription=function(a){var b=this;if(-1===["offer","answer"].indexOf(a.type))return Promise.reject(j("TypeError",'Unsupported type "'+a.type+'"'));if(!h("setLocalDescription",a.type,b.signalingState)||b._isClosed)return Promise.reject(j("InvalidStateError","Can not set local "+a.type+" in state "+b.signalingState));var c,d;if("offer"===a.type)c=k.splitSections(a.sdp),d=c.shift(),c.forEach(function(a,c){var d=k.parseRtpParameters(a);b.transceivers[c].localCapabilities=d}),b.transceivers.forEach(function(a,c){b._gather(a.mid,c)});else if("answer"===a.type){c=k.splitSections(b._remoteDescription.sdp),d=c.shift();var e=k.matchPrefix(d,"a=ice-lite").length>0;c.forEach(function(a,c){var f=b.transceivers[c],h=f.iceGatherer,i=f.iceTransport,j=f.dtlsTransport,l=f.localCapabilities,m=f.remoteCapabilities,n=k.isRejected(a)&&0===k.matchPrefix(a,"a=bundle-only").length;if(!n&&!f.rejected){var o=k.getIceParameters(a,d),p=k.getDtlsParameters(a,d);e&&(p.role="server"),b.usingBundle&&0!==c||(b._gather(f.mid,c),"new"===i.state&&i.start(h,o,e?"controlling":"controlled"),"new"===j.state&&j.start(p));var q=g(l,m);b._transceive(f,q.codecs.length>0,!1)}})}return b._localDescription={type:a.type,sdp:a.sdp},"offer"===a.type?b._updateSignalingState("have-local-offer"):b._updateSignalingState("stable"),Promise.resolve()},n.prototype.setRemoteDescription=function(d){var e=this;if(-1===["offer","answer"].indexOf(d.type))return Promise.reject(j("TypeError",'Unsupported type "'+d.type+'"'));if(!h("setRemoteDescription",d.type,e.signalingState)||e._isClosed)return Promise.reject(j("InvalidStateError","Can not set remote "+d.type+" in state "+e.signalingState));var f={};e.remoteStreams.forEach(function(a){f[a.id]=a});var n=[],o=k.splitSections(d.sdp),p=o.shift(),q=k.matchPrefix(p,"a=ice-lite").length>0,r=k.matchPrefix(p,"a=group:BUNDLE ").length>0;e.usingBundle=r;var s=k.matchPrefix(p,"a=ice-options:")[0];return s?e.canTrickleIceCandidates=s.substr(14).split(" ").indexOf("trickle")>=0:e.canTrickleIceCandidates=!1,o.forEach(function(h,j){var m=k.splitLines(h),o=k.getKind(h),s=k.isRejected(h)&&0===k.matchPrefix(h,"a=bundle-only").length,t=m[0].substr(2).split(" ")[2],u=k.getDirection(h,p),v=k.parseMsid(h),w=k.getMid(h)||k.generateIdentifier();if(s||"application"===o&&("DTLS/SCTP"===t||"UDP/DTLS/SCTP"===t))return void(e.transceivers[j]={mid:w,kind:o,protocol:t,rejected:!0});!s&&e.transceivers[j]&&e.transceivers[j].rejected&&(e.transceivers[j]=e._createTransceiver(o,!0));var x,y,z,A,B,C,D,E,F,G,H,I=k.parseRtpParameters(h);s||(G=k.getIceParameters(h,p),H=k.getDtlsParameters(h,p),H.role="client"),D=k.parseRtpEncodingParameters(h);var J=k.parseRtcpParameters(h),K=k.matchPrefix(h,"a=end-of-candidates",p).length>0,L=k.matchPrefix(h,"a=candidate:").map(function(a){return k.parseCandidate(a)}).filter(function(a){return 1===a.component});if(("offer"===d.type||"answer"===d.type)&&!s&&r&&j>0&&e.transceivers[j]&&(e._disposeIceAndDtlsTransports(j),e.transceivers[j].iceGatherer=e.transceivers[0].iceGatherer,e.transceivers[j].iceTransport=e.transceivers[0].iceTransport,e.transceivers[j].dtlsTransport=e.transceivers[0].dtlsTransport,e.transceivers[j].rtpSender&&e.transceivers[j].rtpSender.setTransport(e.transceivers[0].dtlsTransport),e.transceivers[j].rtpReceiver&&e.transceivers[j].rtpReceiver.setTransport(e.transceivers[0].dtlsTransport)),"offer"!==d.type||s){if("answer"===d.type&&!s){x=e.transceivers[j],y=x.iceGatherer,z=x.iceTransport,A=x.dtlsTransport,B=x.rtpReceiver,C=x.sendEncodingParameters,E=x.localCapabilities,e.transceivers[j].recvEncodingParameters=D,e.transceivers[j].remoteCapabilities=I,e.transceivers[j].rtcpParameters=J,L.length&&"new"===z.state&&(!q&&!K||r&&0!==j?L.forEach(function(a){i(x.iceTransport,a)}):z.setRemoteCandidates(L)),r&&0!==j||("new"===z.state&&z.start(y,G,"controlling"),"new"===A.state&&A.start(H));var M=g(x.localCapabilities,x.remoteCapabilities),N=M.codecs.filter(function(a){return"rtx"===a.name.toLowerCase()}).length;!N&&x.sendEncodingParameters[0].rtx&&delete x.sendEncodingParameters[0].rtx,e._transceive(x,"sendrecv"===u||"recvonly"===u,"sendrecv"===u||"sendonly"===u),!B||"sendrecv"!==u&&"sendonly"!==u?delete x.rtpReceiver:(F=B.track,v?(f[v.stream]||(f[v.stream]=new a.MediaStream),c(F,f[v.stream]),n.push([F,B,f[v.stream]])):(f["default"]||(f["default"]=new a.MediaStream),c(F,f["default"]),n.push([F,B,f["default"]])))}}else{x=e.transceivers[j]||e._createTransceiver(o),x.mid=w,x.iceGatherer||(x.iceGatherer=e._createIceGatherer(j,r)),L.length&&"new"===x.iceTransport.state&&(!K||r&&0!==j?L.forEach(function(a){i(x.iceTransport,a)}):x.iceTransport.setRemoteCandidates(L)),E=a.RTCRtpReceiver.getCapabilities(o),15019>b&&(E.codecs=E.codecs.filter(function(a){return"rtx"!==a.name})),C=x.sendEncodingParameters||[{ssrc:1001*(2*j+2)}];var O=!1;if("sendrecv"===u||"sendonly"===u){if(O=!x.rtpReceiver,B=x.rtpReceiver||new a.RTCRtpReceiver(x.dtlsTransport,o),O){var P;F=B.track,v&&"-"===v.stream||(v?(f[v.stream]||(f[v.stream]=new a.MediaStream,Object.defineProperty(f[v.stream],"id",{get:function(){return v.stream}})),Object.defineProperty(F,"id",{get:function(){return v.track}}),P=f[v.stream]):(f["default"]||(f["default"]=new a.MediaStream),P=f["default"])),P&&(c(F,P),x.associatedRemoteMediaStreams.push(P)),n.push([F,B,P])}}else x.rtpReceiver&&x.rtpReceiver.track&&(x.associatedRemoteMediaStreams.forEach(function(a){var b=a.getTracks().find(function(a){return a.id===x.rtpReceiver.track.id});b&&l(b,a)}),x.associatedRemoteMediaStreams=[]);x.localCapabilities=E,x.remoteCapabilities=I,x.rtpReceiver=B,x.rtcpParameters=J,x.sendEncodingParameters=C,x.recvEncodingParameters=D,e._transceive(e.transceivers[j],!1,O)}}),void 0===e._dtlsRole&&(e._dtlsRole="offer"===d.type?"active":"passive"),e._remoteDescription={type:d.type,sdp:d.sdp},"offer"===d.type?e._updateSignalingState("have-remote-offer"):e._updateSignalingState("stable"),Object.keys(f).forEach(function(b){var c=f[b];if(c.getTracks().length){if(-1===e.remoteStreams.indexOf(c)){e.remoteStreams.push(c);var d=new Event("addstream");d.stream=c,a.setTimeout(function(){e._dispatchEvent("addstream",d)})}n.forEach(function(a){var b=a[0],d=a[1];c.id===a[2].id&&m(e,b,d,[c])})}}),n.forEach(function(a){a[2]||m(e,a[0],a[1],[])}),a.setTimeout(function(){e&&e.transceivers&&e.transceivers.forEach(function(a){a.iceTransport&&"new"===a.iceTransport.state&&a.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),a.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},n.prototype.close=function(){this.transceivers.forEach(function(a){a.iceTransport&&a.iceTransport.stop(),a.dtlsTransport&&a.dtlsTransport.stop(),a.rtpSender&&a.rtpSender.stop(),a.rtpReceiver&&a.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},n.prototype._updateSignalingState=function(a){this.signalingState=a;var b=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",b)},n.prototype._maybeFireNegotiationNeeded=function(){var b=this;"stable"===this.signalingState&&this.needNegotiation!==!0&&(this.needNegotiation=!0,a.setTimeout(function(){if(b.needNegotiation){b.needNegotiation=!1;var a=new Event("negotiationneeded");b._dispatchEvent("negotiationneeded",a)}},0))},n.prototype._updateIceConnectionState=function(){var a,b={"new":0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(a){b[a.iceTransport.state]++}),a="new",b.failed>0?a="failed":b.checking>0?a="checking":b.disconnected>0?a="disconnected":b["new"]>0?a="new":b.connected>0?a="connected":b.completed>0&&(a="completed"),a!==this.iceConnectionState){this.iceConnectionState=a;var c=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",c)}},n.prototype._updateConnectionState=function(){var a,b={"new":0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(a){b[a.iceTransport.state]++,b[a.dtlsTransport.state]++}),b.connected+=b.completed,a="new",b.failed>0?a="failed":b.connecting>0?a="connecting":b.disconnected>0?a="disconnected":b["new"]>0?a="new":b.connected>0&&(a="connected"),a!==this.connectionState){this.connectionState=a;var c=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",c)}},n.prototype.createOffer=function(){var c=this;if(c._isClosed)return Promise.reject(j("InvalidStateError","Can not call createOffer after close"));var d=c.transceivers.filter(function(a){return"audio"===a.kind}).length,f=c.transceivers.filter(function(a){return"video"===a.kind}).length,g=arguments[0];if(g){if(g.mandatory||g.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==g.offerToReceiveAudio&&(d=g.offerToReceiveAudio===!0?1:g.offerToReceiveAudio===!1?0:g.offerToReceiveAudio),void 0!==g.offerToReceiveVideo&&(f=g.offerToReceiveVideo===!0?1:g.offerToReceiveVideo===!1?0:g.offerToReceiveVideo)}for(c.transceivers.forEach(function(a){"audio"===a.kind?(d--,0>d&&(a.wantReceive=!1)):"video"===a.kind&&(f--,0>f&&(a.wantReceive=!1))});d>0||f>0;)d>0&&(c._createTransceiver("audio"),d--),f>0&&(c._createTransceiver("video"),f--);var h=k.writeSessionBoilerplate(c._sdpSessionId,c._sdpSessionVersion++);c.transceivers.forEach(function(d,e){var f=d.track,g=d.kind,h=d.mid||k.generateIdentifier();d.mid=h,d.iceGatherer||(d.iceGatherer=c._createIceGatherer(e,c.usingBundle));var i=a.RTCRtpSender.getCapabilities(g);15019>b&&(i.codecs=i.codecs.filter(function(a){return"rtx"!==a.name})),i.codecs.forEach(function(a){"H264"===a.name&&void 0===a.parameters["level-asymmetry-allowed"]&&(a.parameters["level-asymmetry-allowed"]="1"),d.remoteCapabilities&&d.remoteCapabilities.codecs&&d.remoteCapabilities.codecs.forEach(function(b){a.name.toLowerCase()===b.name.toLowerCase()&&a.clockRate===b.clockRate&&(a.preferredPayloadType=b.payloadType)})}),i.headerExtensions.forEach(function(a){var b=d.remoteCapabilities&&d.remoteCapabilities.headerExtensions||[];b.forEach(function(b){a.uri===b.uri&&(a.id=b.id)})});var j=d.sendEncodingParameters||[{ssrc:1001*(2*e+1)}];f&&b>=15019&&"video"===g&&!j[0].rtx&&(j[0].rtx={ssrc:j[0].ssrc+1}),d.wantReceive&&(d.rtpReceiver=new a.RTCRtpReceiver(d.dtlsTransport,g)),d.localCapabilities=i,d.sendEncodingParameters=j}),"max-compat"!==c._config.bundlePolicy&&(h+="a=group:BUNDLE "+c.transceivers.map(function(a){return a.mid}).join(" ")+"\r\n"),h+="a=ice-options:trickle\r\n",c.transceivers.forEach(function(a,b){h+=e(a,a.localCapabilities,"offer",a.stream,c._dtlsRole),h+="a=rtcp-rsize\r\n",!a.iceGatherer||"new"===c.iceGatheringState||0!==b&&c.usingBundle||(a.iceGatherer.getLocalCandidates().forEach(function(a){a.component=1,h+="a="+k.writeCandidate(a)+"\r\n"}),"completed"===a.iceGatherer.state&&(h+="a=end-of-candidates\r\n"))});var i=new a.RTCSessionDescription({type:"offer",sdp:h});return Promise.resolve(i)},n.prototype.createAnswer=function(){var c=this;if(c._isClosed)return Promise.reject(j("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==c.signalingState&&"have-local-pranswer"!==c.signalingState)return Promise.reject(j("InvalidStateError","Can not call createAnswer in signalingState "+c.signalingState));var d=k.writeSessionBoilerplate(c._sdpSessionId,c._sdpSessionVersion++);c.usingBundle&&(d+="a=group:BUNDLE "+c.transceivers.map(function(a){return a.mid}).join(" ")+"\r\n"),d+="a=ice-options:trickle\r\n";var f=k.getMediaSections(c._remoteDescription.sdp).length;c.transceivers.forEach(function(a,h){if(!(h+1>f)){if(a.rejected)return"application"===a.kind?d+="DTLS/SCTP"===a.protocol?"m=application 0 DTLS/SCTP 5000\r\n":"m=application 0 "+a.protocol+" webrtc-datachannel\r\n":"audio"===a.kind?d+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===a.kind&&(d+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(d+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+a.mid+"\r\n");if(a.stream){var i;"audio"===a.kind?i=a.stream.getAudioTracks()[0]:"video"===a.kind&&(i=a.stream.getVideoTracks()[0]),i&&b>=15019&&"video"===a.kind&&!a.sendEncodingParameters[0].rtx&&(a.sendEncodingParameters[0].rtx={ssrc:a.sendEncodingParameters[0].ssrc+1})}var j=g(a.localCapabilities,a.remoteCapabilities),k=j.codecs.filter(function(a){return"rtx"===a.name.toLowerCase()}).length;!k&&a.sendEncodingParameters[0].rtx&&delete a.sendEncodingParameters[0].rtx,d+=e(a,j,"answer",a.stream,c._dtlsRole),a.rtcpParameters&&a.rtcpParameters.reducedSize&&(d+="a=rtcp-rsize\r\n")}});var h=new a.RTCSessionDescription({type:"answer",sdp:d});return Promise.resolve(h)},n.prototype.addIceCandidate=function(a){var b,c=this;return a&&void 0===a.sdpMLineIndex&&!a.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(d,e){if(!c._remoteDescription)return e(j("InvalidStateError","Can not add ICE candidate without a remote description"));if(a&&""!==a.candidate){var f=a.sdpMLineIndex;if(a.sdpMid)for(var g=0;g<c.transceivers.length;g++)if(c.transceivers[g].mid===a.sdpMid){f=g;break}var h=c.transceivers[f];if(!h)return e(j("OperationError","Can not add ICE candidate"));if(h.rejected)return d();var l=Object.keys(a.candidate).length>0?k.parseCandidate(a.candidate):{};if("tcp"===l.protocol&&(0===l.port||9===l.port))return d();if(l.component&&1!==l.component)return d();if((0===f||f>0&&h.iceTransport!==c.transceivers[0].iceTransport)&&!i(h.iceTransport,l))return e(j("OperationError","Can not add ICE candidate"));var m=a.candidate.trim();0===m.indexOf("a=")&&(m=m.substr(2)),b=k.getMediaSections(c._remoteDescription.sdp),b[f]+="a="+(l.type?m:"end-of-candidates")+"\r\n",c._remoteDescription.sdp=k.getDescription(c._remoteDescription.sdp)+b.join("")}else for(var n=0;n<c.transceivers.length&&(c.transceivers[n].rejected||(c.transceivers[n].iceTransport.addRemoteCandidate({}),b=k.getMediaSections(c._remoteDescription.sdp),b[n]+="a=end-of-candidates\r\n",c._remoteDescription.sdp=k.getDescription(c._remoteDescription.sdp)+b.join(""),!c.usingBundle));n++);d()})},n.prototype.getStats=function(b){if(b&&b instanceof a.MediaStreamTrack){var c=null;if(this.transceivers.forEach(function(a){a.rtpSender&&a.rtpSender.track===b?c=a.rtpSender:a.rtpReceiver&&a.rtpReceiver.track===b&&(c=a.rtpReceiver)}),!c)throw j("InvalidAccessError","Invalid selector.");return c.getStats()}var d=[];return this.transceivers.forEach(function(a){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(b){a[b]&&d.push(a[b].getStats())})}),Promise.all(d).then(function(a){var b=new Map;return a.forEach(function(a){a.forEach(function(a){b.set(a.id,a)})}),b})};var o=["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"];o.forEach(function(b){var c=a[b];if(c&&c.prototype&&c.prototype.getStats){var e=c.prototype.getStats;c.prototype.getStats=function(){return e.apply(this).then(function(a){var b=new Map;return Object.keys(a).forEach(function(c){a[c].type=d(a[c]),b.set(c,a[c])}),b})}}});var p=["createOffer","createAnswer"];return p.forEach(function(a){var b=n.prototype[a];n.prototype[a]=function(){var a=arguments;return"function"==typeof a[0]||"function"==typeof a[1]?b.apply(this,[arguments[2]]).then(function(b){"function"==typeof a[0]&&a[0].apply(null,[b])},function(b){"function"==typeof a[1]&&a[1].apply(null,[b])}):b.apply(this,arguments)}}),p=["setLocalDescription","setRemoteDescription","addIceCandidate"],p.forEach(function(a){var b=n.prototype[a];n.prototype[a]=function(){var a=arguments;return"function"==typeof a[1]||"function"==typeof a[2]?b.apply(this,arguments).then(function(){"function"==typeof a[1]&&a[1].apply(null)},function(b){"function"==typeof a[2]&&a[2].apply(null,[b])}):b.apply(this,arguments)}}),["getStats"].forEach(function(a){var b=n.prototype[a];n.prototype[a]=function(){var a=arguments;return"function"==typeof a[1]?b.apply(this,arguments).then(function(){"function"==typeof a[1]&&a[1].apply(null)}):b.apply(this,arguments)}}),n}},{sdp:2}],2:[function(a,b,c){"use strict";var d={};d.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},d.localCName=d.generateIdentifier(),d.splitLines=function(a){return a.trim().split("\n").map(function(a){return a.trim()})},d.splitSections=function(a){var b=a.split("\nm=");return b.map(function(a,b){return(b>0?"m="+a:a).trim()+"\r\n"})},d.getDescription=function(a){var b=d.splitSections(a);return b&&b[0]},d.getMediaSections=function(a){var b=d.splitSections(a);return b.shift(),b},d.matchPrefix=function(a,b){return d.splitLines(a).filter(function(a){return 0===a.indexOf(b)})},d.parseCandidate=function(a){var b;b=0===a.indexOf("a=candidate:")?a.substring(12).split(" "):a.substring(10).split(" ");for(var c={foundation:b[0],component:parseInt(b[1],10),protocol:b[2].toLowerCase(),priority:parseInt(b[3],10),ip:b[4],address:b[4],port:parseInt(b[5],10),type:b[7]},d=8;d<b.length;d+=2)switch(b[d]){case"raddr":c.relatedAddress=b[d+1];break;case"rport":c.relatedPort=parseInt(b[d+1],10);break;case"tcptype":c.tcpType=b[d+1];break;case"ufrag":c.ufrag=b[d+1],c.usernameFragment=b[d+1];break;default:c[b[d]]=b[d+1]}return c},d.writeCandidate=function(a){var b=[];b.push(a.foundation),b.push(a.component),b.push(a.protocol.toUpperCase()),b.push(a.priority),b.push(a.address||a.ip),b.push(a.port);var c=a.type;return b.push("typ"),b.push(c),"host"!==c&&a.relatedAddress&&a.relatedPort&&(b.push("raddr"),b.push(a.relatedAddress),b.push("rport"),b.push(a.relatedPort)),a.tcpType&&"tcp"===a.protocol.toLowerCase()&&(b.push("tcptype"),b.push(a.tcpType)),(a.usernameFragment||a.ufrag)&&(b.push("ufrag"),b.push(a.usernameFragment||a.ufrag)),"candidate:"+b.join(" ")},d.parseIceOptions=function(a){return a.substr(14).split(" ")},d.parseRtpMap=function(a){var b=a.substr(9).split(" "),c={payloadType:parseInt(b.shift(),10)};return b=b[0].split("/"),c.name=b[0],c.clockRate=parseInt(b[1],10),c.channels=3===b.length?parseInt(b[2],10):1,c.numChannels=c.channels,c},d.writeRtpMap=function(a){var b=a.payloadType;void 0!==a.preferredPayloadType&&(b=a.preferredPayloadType);var c=a.channels||a.numChannels||1;return"a=rtpmap:"+b+" "+a.name+"/"+a.clockRate+(1!==c?"/"+c:"")+"\r\n"},d.parseExtmap=function(a){var b=a.substr(9).split(" ");return{id:parseInt(b[0],10),direction:b[0].indexOf("/")>0?b[0].split("/")[1]:"sendrecv",uri:b[1]}},d.writeExtmap=function(a){return"a=extmap:"+(a.id||a.preferredId)+(a.direction&&"sendrecv"!==a.direction?"/"+a.direction:"")+" "+a.uri+"\r\n"},d.parseFmtp=function(a){for(var b,c={},d=a.substr(a.indexOf(" ")+1).split(";"),e=0;e<d.length;e++)b=d[e].trim().split("="),c[b[0].trim()]=b[1];return c},d.writeFmtp=function(a){
var b="",c=a.payloadType;if(void 0!==a.preferredPayloadType&&(c=a.preferredPayloadType),a.parameters&&Object.keys(a.parameters).length){var d=[];Object.keys(a.parameters).forEach(function(b){a.parameters[b]?d.push(b+"="+a.parameters[b]):d.push(b)}),b+="a=fmtp:"+c+" "+d.join(";")+"\r\n"}return b},d.parseRtcpFb=function(a){var b=a.substr(a.indexOf(" ")+1).split(" ");return{type:b.shift(),parameter:b.join(" ")}},d.writeRtcpFb=function(a){var b="",c=a.payloadType;return void 0!==a.preferredPayloadType&&(c=a.preferredPayloadType),a.rtcpFeedback&&a.rtcpFeedback.length&&a.rtcpFeedback.forEach(function(a){b+="a=rtcp-fb:"+c+" "+a.type+(a.parameter&&a.parameter.length?" "+a.parameter:"")+"\r\n"}),b},d.parseSsrcMedia=function(a){var b=a.indexOf(" "),c={ssrc:parseInt(a.substr(7,b-7),10)},d=a.indexOf(":",b);return d>-1?(c.attribute=a.substr(b+1,d-b-1),c.value=a.substr(d+1)):c.attribute=a.substr(b+1),c},d.parseSsrcGroup=function(a){var b=a.substr(13).split(" ");return{semantics:b.shift(),ssrcs:b.map(function(a){return parseInt(a,10)})}},d.getMid=function(a){var b=d.matchPrefix(a,"a=mid:")[0];return b?b.substr(6):void 0},d.parseFingerprint=function(a){var b=a.substr(14).split(" ");return{algorithm:b[0].toLowerCase(),value:b[1]}},d.getDtlsParameters=function(a,b){var c=d.matchPrefix(a+b,"a=fingerprint:");return{role:"auto",fingerprints:c.map(d.parseFingerprint)}},d.writeDtlsParameters=function(a,b){var c="a=setup:"+b+"\r\n";return a.fingerprints.forEach(function(a){c+="a=fingerprint:"+a.algorithm+" "+a.value+"\r\n"}),c},d.getIceParameters=function(a,b){var c=d.splitLines(a);c=c.concat(d.splitLines(b));var e={usernameFragment:c.filter(function(a){return 0===a.indexOf("a=ice-ufrag:")})[0].substr(12),password:c.filter(function(a){return 0===a.indexOf("a=ice-pwd:")})[0].substr(10)};return e},d.writeIceParameters=function(a){return"a=ice-ufrag:"+a.usernameFragment+"\r\na=ice-pwd:"+a.password+"\r\n"},d.parseRtpParameters=function(a){for(var b={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},c=d.splitLines(a),e=c[0].split(" "),f=3;f<e.length;f++){var g=e[f],h=d.matchPrefix(a,"a=rtpmap:"+g+" ")[0];if(h){var i=d.parseRtpMap(h),j=d.matchPrefix(a,"a=fmtp:"+g+" ");switch(i.parameters=j.length?d.parseFmtp(j[0]):{},i.rtcpFeedback=d.matchPrefix(a,"a=rtcp-fb:"+g+" ").map(d.parseRtcpFb),b.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":b.fecMechanisms.push(i.name.toUpperCase())}}}return d.matchPrefix(a,"a=extmap:").forEach(function(a){b.headerExtensions.push(d.parseExtmap(a))}),b},d.writeRtpDescription=function(a,b){var c="";c+="m="+a+" ",c+=b.codecs.length>0?"9":"0",c+=" UDP/TLS/RTP/SAVPF ",c+=b.codecs.map(function(a){return void 0!==a.preferredPayloadType?a.preferredPayloadType:a.payloadType}).join(" ")+"\r\n",c+="c=IN IP4 0.0.0.0\r\n",c+="a=rtcp:9 IN IP4 0.0.0.0\r\n",b.codecs.forEach(function(a){c+=d.writeRtpMap(a),c+=d.writeFmtp(a),c+=d.writeRtcpFb(a)});var e=0;return b.codecs.forEach(function(a){a.maxptime>e&&(e=a.maxptime)}),e>0&&(c+="a=maxptime:"+e+"\r\n"),c+="a=rtcp-mux\r\n",b.headerExtensions&&b.headerExtensions.forEach(function(a){c+=d.writeExtmap(a)}),c},d.parseRtpEncodingParameters=function(a){var b,c=[],e=d.parseRtpParameters(a),f=-1!==e.fecMechanisms.indexOf("RED"),g=-1!==e.fecMechanisms.indexOf("ULPFEC"),h=d.matchPrefix(a,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"cname"===a.attribute}),i=h.length>0&&h[0].ssrc,j=d.matchPrefix(a,"a=ssrc-group:FID").map(function(a){var b=a.substr(17).split(" ");return b.map(function(a){return parseInt(a,10)})});j.length>0&&j[0].length>1&&j[0][0]===i&&(b=j[0][1]),e.codecs.forEach(function(a){if("RTX"===a.name.toUpperCase()&&a.parameters.apt){var d={ssrc:i,codecPayloadType:parseInt(a.parameters.apt,10)};i&&b&&(d.rtx={ssrc:b}),c.push(d),f&&(d=JSON.parse(JSON.stringify(d)),d.fec={ssrc:i,mechanism:g?"red+ulpfec":"red"},c.push(d))}}),0===c.length&&i&&c.push({ssrc:i});var k=d.matchPrefix(a,"b=");return k.length&&(k=0===k[0].indexOf("b=TIAS:")?parseInt(k[0].substr(7),10):0===k[0].indexOf("b=AS:")?1e3*parseInt(k[0].substr(5),10)*.95-16e3:void 0,c.forEach(function(a){a.maxBitrate=k})),c},d.parseRtcpParameters=function(a){var b={},c=d.matchPrefix(a,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"cname"===a.attribute})[0];c&&(b.cname=c.value,b.ssrc=c.ssrc);var e=d.matchPrefix(a,"a=rtcp-rsize");b.reducedSize=e.length>0,b.compound=0===e.length;var f=d.matchPrefix(a,"a=rtcp-mux");return b.mux=f.length>0,b},d.parseMsid=function(a){var b,c=d.matchPrefix(a,"a=msid:");if(1===c.length)return b=c[0].substr(7).split(" "),{stream:b[0],track:b[1]};var e=d.matchPrefix(a,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"msid"===a.attribute});return e.length>0?(b=e[0].value.split(" "),{stream:b[0],track:b[1]}):void 0},d.generateSessionId=function(){return Math.random().toString().substr(2,21)},d.writeSessionBoilerplate=function(a,b,c){var e,f=void 0!==b?b:2;e=a?a:d.generateSessionId();var g=c||"thisisadapterortc";return"v=0\r\no="+g+" "+e+" "+f+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},d.writeMediaSection=function(a,b,c,e){var f=d.writeRtpDescription(a.kind,b);if(f+=d.writeIceParameters(a.iceGatherer.getLocalParameters()),f+=d.writeDtlsParameters(a.dtlsTransport.getLocalParameters(),"offer"===c?"actpass":"active"),f+="a=mid:"+a.mid+"\r\n",f+=a.direction?"a="+a.direction+"\r\n":a.rtpSender&&a.rtpReceiver?"a=sendrecv\r\n":a.rtpSender?"a=sendonly\r\n":a.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",a.rtpSender){var g="msid:"+e.id+" "+a.rtpSender.track.id+"\r\n";f+="a="+g,f+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" "+g,a.sendEncodingParameters[0].rtx&&(f+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" "+g,f+="a=ssrc-group:FID "+a.sendEncodingParameters[0].ssrc+" "+a.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return f+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" cname:"+d.localCName+"\r\n",a.rtpSender&&a.sendEncodingParameters[0].rtx&&(f+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" cname:"+d.localCName+"\r\n"),f},d.getDirection=function(a,b){for(var c=d.splitLines(a),e=0;e<c.length;e++)switch(c[e]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return c[e].substr(2)}return b?d.getDirection(b):"sendrecv"},d.getKind=function(a){var b=d.splitLines(a),c=b[0].split(" ");return c[0].substr(2)},d.isRejected=function(a){return"0"===a.split(" ",2)[1]},d.parseMLine=function(a){var b=d.splitLines(a),c=b[0].substr(2).split(" ");return{kind:c[0],port:parseInt(c[1],10),protocol:c[2],fmt:c.slice(3).join(" ")}},d.parseOLine=function(a){var b=d.matchPrefix(a,"o=")[0],c=b.substr(2).split(" ");return{username:c[0],sessionId:c[1],sessionVersion:parseInt(c[2],10),netType:c[3],addressType:c[4],address:c[5]}},d.isValidSDP=function(a){if("string"!=typeof a||0===a.length)return!1;for(var b=d.splitLines(a),c=0;c<b.length;c++)if(b[c].length<2||"="!==b[c].charAt(1))return!1;return!0},"object"==typeof b&&(b.exports=d)},{}],3:[function(a,b,c){(function(c){"use strict";var d=a("./adapter_factory.js");b.exports=d({window:c.window})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./adapter_factory.js":4}],4:[function(a,b,c){"use strict";var d=a("./utils");b.exports=function(b,c){var e=b&&b.window,f={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0};for(var g in c)hasOwnProperty.call(c,g)&&(f[g]=c[g]);var h=d.log,i=d.detectBrowser(e),j=a("./chrome/chrome_shim")||null,k=a("./edge/edge_shim")||null,l=a("./firefox/firefox_shim")||null,m=a("./safari/safari_shim")||null,n=a("./common_shim")||null,o={browserDetails:i,commonShim:n,extractVersion:d.extractVersion,disableLog:d.disableLog,disableWarnings:d.disableWarnings};switch(i.browser){case"chrome":if(!j||!j.shimPeerConnection||!f.shimChrome)return h("Chrome shim is not included in this adapter release."),o;h("adapter.js shimming chrome."),o.browserShim=j,n.shimCreateObjectURL(e),j.shimGetUserMedia(e),j.shimMediaStream(e),j.shimSourceObject(e),j.shimPeerConnection(e),j.shimOnTrack(e),j.shimAddTrackRemoveTrack(e),j.shimGetSendersWithDtmf(e),j.shimSenderReceiverGetStats(e),j.fixNegotiationNeeded(e),n.shimRTCIceCandidate(e),n.shimMaxMessageSize(e),n.shimSendThrowTypeError(e);break;case"firefox":if(!l||!l.shimPeerConnection||!f.shimFirefox)return h("Firefox shim is not included in this adapter release."),o;h("adapter.js shimming firefox."),o.browserShim=l,n.shimCreateObjectURL(e),l.shimGetUserMedia(e),l.shimSourceObject(e),l.shimPeerConnection(e),l.shimOnTrack(e),l.shimRemoveStream(e),l.shimSenderGetStats(e),l.shimReceiverGetStats(e),l.shimRTCDataChannel(e),n.shimRTCIceCandidate(e),n.shimMaxMessageSize(e),n.shimSendThrowTypeError(e);break;case"edge":if(!k||!k.shimPeerConnection||!f.shimEdge)return h("MS edge shim is not included in this adapter release."),o;h("adapter.js shimming edge."),o.browserShim=k,n.shimCreateObjectURL(e),k.shimGetUserMedia(e),k.shimPeerConnection(e),k.shimReplaceTrack(e),n.shimMaxMessageSize(e),n.shimSendThrowTypeError(e);break;case"safari":if(!m||!f.shimSafari)return h("Safari shim is not included in this adapter release."),o;h("adapter.js shimming safari."),o.browserShim=m,n.shimCreateObjectURL(e),m.shimRTCIceServerUrls(e),m.shimCreateOfferLegacy(e),m.shimCallbacksAPI(e),m.shimLocalStreamsAPI(e),m.shimRemoteStreamsAPI(e),m.shimTrackEventTransceiver(e),m.shimGetUserMedia(e),n.shimRTCIceCandidate(e),n.shimMaxMessageSize(e),n.shimSendThrowTypeError(e);break;default:h("Unsupported browser!")}return o}},{"./chrome/chrome_shim":5,"./common_shim":7,"./edge/edge_shim":8,"./firefox/firefox_shim":11,"./safari/safari_shim":13,"./utils":14}],5:[function(a,b,c){"use strict";function d(a,b,c){b&&!c.has(b.id)&&(c.set(b.id,b),Object.keys(b).forEach(function(e){e.endsWith("Id")?d(a,a.get(b[e]),c):e.endsWith("Ids")&&b[e].forEach(function(b){d(a,a.get(b),c)})}))}function e(a,b,c){var e=c?"outbound-rtp":"inbound-rtp",f=new Map;if(null===b)return f;var g=[];return a.forEach(function(a){"track"===a.type&&a.trackIdentifier===b.id&&g.push(a)}),g.forEach(function(b){a.forEach(function(c){c.type===e&&c.trackId===b.id&&d(a,c,f)})}),f}var f=a("../utils.js"),g=f.log;b.exports={shimGetUserMedia:a("./getusermedia"),shimMediaStream:function(a){a.MediaStream=a.MediaStream||a.webkitMediaStream},shimOnTrack:function(a){if("object"!=typeof a||!a.RTCPeerConnection||"ontrack"in a.RTCPeerConnection.prototype)f.wrapPeerConnectionEvent(a,"track",function(a){return a.transceiver||Object.defineProperty(a,"transceiver",{value:{receiver:a.receiver}}),a});else{Object.defineProperty(a.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(a){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=a)},enumerable:!0,configurable:!0});var b=a.RTCPeerConnection.prototype.setRemoteDescription;a.RTCPeerConnection.prototype.setRemoteDescription=function(){var c=this;return c._ontrackpoly||(c._ontrackpoly=function(b){b.stream.addEventListener("addtrack",function(d){var e;e=a.RTCPeerConnection.prototype.getReceivers?c.getReceivers().find(function(a){return a.track&&a.track.id===d.track.id}):{track:d.track};var f=new Event("track");f.track=d.track,f.receiver=e,f.transceiver={receiver:e},f.streams=[b.stream],c.dispatchEvent(f)}),b.stream.getTracks().forEach(function(d){var e;e=a.RTCPeerConnection.prototype.getReceivers?c.getReceivers().find(function(a){return a.track&&a.track.id===d.id}):{track:d};var f=new Event("track");f.track=d,f.receiver=e,f.transceiver={receiver:e},f.streams=[b.stream],c.dispatchEvent(f)})},c.addEventListener("addstream",c._ontrackpoly)),b.apply(c,arguments)}}},shimGetSendersWithDtmf:function(a){if("object"==typeof a&&a.RTCPeerConnection&&!("getSenders"in a.RTCPeerConnection.prototype)&&"createDTMFSender"in a.RTCPeerConnection.prototype){var b=function(a,b){return{track:b,get dtmf(){return void 0===this._dtmf&&("audio"===b.kind?this._dtmf=a.createDTMFSender(b):this._dtmf=null),this._dtmf},_pc:a}};if(!a.RTCPeerConnection.prototype.getSenders){a.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var c=a.RTCPeerConnection.prototype.addTrack;a.RTCPeerConnection.prototype.addTrack=function(a,d){var e=this,f=c.apply(e,arguments);return f||(f=b(e,a),e._senders.push(f)),f};var d=a.RTCPeerConnection.prototype.removeTrack;a.RTCPeerConnection.prototype.removeTrack=function(a){var b=this;d.apply(b,arguments);var c=b._senders.indexOf(a);-1!==c&&b._senders.splice(c,1)}}var e=a.RTCPeerConnection.prototype.addStream;a.RTCPeerConnection.prototype.addStream=function(a){var c=this;c._senders=c._senders||[],e.apply(c,[a]),a.getTracks().forEach(function(a){c._senders.push(b(c,a))})};var f=a.RTCPeerConnection.prototype.removeStream;a.RTCPeerConnection.prototype.removeStream=function(a){var b=this;b._senders=b._senders||[],f.apply(b,[a]),a.getTracks().forEach(function(a){var c=b._senders.find(function(b){return b.track===a});c&&b._senders.splice(b._senders.indexOf(c),1)})}}else if("object"==typeof a&&a.RTCPeerConnection&&"getSenders"in a.RTCPeerConnection.prototype&&"createDTMFSender"in a.RTCPeerConnection.prototype&&a.RTCRtpSender&&!("dtmf"in a.RTCRtpSender.prototype)){var g=a.RTCPeerConnection.prototype.getSenders;a.RTCPeerConnection.prototype.getSenders=function(){var a=this,b=g.apply(a,[]);return b.forEach(function(b){b._pc=a}),b},Object.defineProperty(a.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}},shimSenderReceiverGetStats:function(a){if("object"==typeof a&&a.RTCPeerConnection&&a.RTCRtpSender&&a.RTCRtpReceiver){if(!("getStats"in a.RTCRtpSender.prototype)){var b=a.RTCPeerConnection.prototype.getSenders;b&&(a.RTCPeerConnection.prototype.getSenders=function(){var a=this,c=b.apply(a,[]);return c.forEach(function(b){b._pc=a}),c});var c=a.RTCPeerConnection.prototype.addTrack;c&&(a.RTCPeerConnection.prototype.addTrack=function(){var a=c.apply(this,arguments);return a._pc=this,a}),a.RTCRtpSender.prototype.getStats=function(){var a=this;return this._pc.getStats().then(function(b){return e(b,a.track,!0)})}}if(!("getStats"in a.RTCRtpReceiver.prototype)){var d=a.RTCPeerConnection.prototype.getReceivers;d&&(a.RTCPeerConnection.prototype.getReceivers=function(){var a=this,b=d.apply(a,[]);return b.forEach(function(b){b._pc=a}),b}),f.wrapPeerConnectionEvent(a,"track",function(a){return a.receiver._pc=a.srcElement,a}),a.RTCRtpReceiver.prototype.getStats=function(){var a=this;return this._pc.getStats().then(function(b){return e(b,a.track,!1)})}}if("getStats"in a.RTCRtpSender.prototype&&"getStats"in a.RTCRtpReceiver.prototype){var g=a.RTCPeerConnection.prototype.getStats;a.RTCPeerConnection.prototype.getStats=function(){var b=this;if(arguments.length>0&&arguments[0]instanceof a.MediaStreamTrack){var c,d,e,f=arguments[0];return b.getSenders().forEach(function(a){a.track===f&&(c?e=!0:c=a)}),b.getReceivers().forEach(function(a){return a.track===f&&(d?e=!0:d=a),a.track===f}),e||c&&d?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):c?c.getStats():d?d.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return g.apply(b,arguments)}}}},shimSourceObject:function(a){var b=a&&a.URL;"object"==typeof a&&(!a.HTMLMediaElement||"srcObject"in a.HTMLMediaElement.prototype||Object.defineProperty(a.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(a){var c=this;return this._srcObject=a,this.src&&b.revokeObjectURL(this.src),a?(this.src=b.createObjectURL(a),a.addEventListener("addtrack",function(){c.src&&b.revokeObjectURL(c.src),c.src=b.createObjectURL(a)}),void a.addEventListener("removetrack",function(){c.src&&b.revokeObjectURL(c.src),c.src=b.createObjectURL(a)})):void(this.src="")}}))},shimAddTrackRemoveTrackWithNative:function(a){a.RTCPeerConnection.prototype.getLocalStreams=function(){var a=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(function(b){return a._shimmedLocalStreams[b][0]})};var b=a.RTCPeerConnection.prototype.addTrack;a.RTCPeerConnection.prototype.addTrack=function(a,c){if(!c)return b.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var d=b.apply(this,arguments);return this._shimmedLocalStreams[c.id]?-1===this._shimmedLocalStreams[c.id].indexOf(d)&&this._shimmedLocalStreams[c.id].push(d):this._shimmedLocalStreams[c.id]=[c,d],d};var c=a.RTCPeerConnection.prototype.addStream;a.RTCPeerConnection.prototype.addStream=function(a){var b=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},a.getTracks().forEach(function(a){var c=b.getSenders().find(function(b){return b.track===a});if(c)throw new DOMException("Track already exists.","InvalidAccessError")});var d=b.getSenders();c.apply(this,arguments);var e=b.getSenders().filter(function(a){return-1===d.indexOf(a)});this._shimmedLocalStreams[a.id]=[a].concat(e)};var d=a.RTCPeerConnection.prototype.removeStream;a.RTCPeerConnection.prototype.removeStream=function(a){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[a.id],d.apply(this,arguments)};var e=a.RTCPeerConnection.prototype.removeTrack;a.RTCPeerConnection.prototype.removeTrack=function(a){var b=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},a&&Object.keys(this._shimmedLocalStreams).forEach(function(c){var d=b._shimmedLocalStreams[c].indexOf(a);-1!==d&&b._shimmedLocalStreams[c].splice(d,1),1===b._shimmedLocalStreams[c].length&&delete b._shimmedLocalStreams[c]}),e.apply(this,arguments)}},shimAddTrackRemoveTrack:function(a){function b(a,b){var c=b.sdp;return Object.keys(a._reverseStreams||[]).forEach(function(b){var d=a._reverseStreams[b],e=a._streams[d.id];c=c.replace(new RegExp(e.id,"g"),d.id)}),new RTCSessionDescription({type:b.type,sdp:c})}function c(a,b){var c=b.sdp;return Object.keys(a._reverseStreams||[]).forEach(function(b){var d=a._reverseStreams[b],e=a._streams[d.id];c=c.replace(new RegExp(d.id,"g"),e.id)}),new RTCSessionDescription({type:b.type,sdp:c})}var d=f.detectBrowser(a);if(a.RTCPeerConnection.prototype.addTrack&&d.version>=65)return this.shimAddTrackRemoveTrackWithNative(a);var e=a.RTCPeerConnection.prototype.getLocalStreams;a.RTCPeerConnection.prototype.getLocalStreams=function(){var a=this,b=e.apply(this);return a._reverseStreams=a._reverseStreams||{},b.map(function(b){return a._reverseStreams[b.id]})};var g=a.RTCPeerConnection.prototype.addStream;a.RTCPeerConnection.prototype.addStream=function(b){var c=this;if(c._streams=c._streams||{},c._reverseStreams=c._reverseStreams||{},b.getTracks().forEach(function(a){var b=c.getSenders().find(function(b){return b.track===a});if(b)throw new DOMException("Track already exists.","InvalidAccessError")}),!c._reverseStreams[b.id]){var d=new a.MediaStream(b.getTracks());c._streams[b.id]=d,c._reverseStreams[d.id]=b,b=d}g.apply(c,[b])};var h=a.RTCPeerConnection.prototype.removeStream;a.RTCPeerConnection.prototype.removeStream=function(a){var b=this;b._streams=b._streams||{},b._reverseStreams=b._reverseStreams||{},h.apply(b,[b._streams[a.id]||a]),delete b._reverseStreams[b._streams[a.id]?b._streams[a.id].id:a.id],delete b._streams[a.id]},a.RTCPeerConnection.prototype.addTrack=function(b,c){var d=this;if("closed"===d.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var e=[].slice.call(arguments,1);if(1!==e.length||!e[0].getTracks().find(function(a){return a===b}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");var f=d.getSenders().find(function(a){return a.track===b});if(f)throw new DOMException("Track already exists.","InvalidAccessError");d._streams=d._streams||{},d._reverseStreams=d._reverseStreams||{};var g=d._streams[c.id];if(g)g.addTrack(b),Promise.resolve().then(function(){d.dispatchEvent(new Event("negotiationneeded"))});else{var h=new a.MediaStream([b]);d._streams[c.id]=h,d._reverseStreams[h.id]=c,d.addStream(h)}return d.getSenders().find(function(a){return a.track===b})},["createOffer","createAnswer"].forEach(function(c){var d=a.RTCPeerConnection.prototype[c];a.RTCPeerConnection.prototype[c]=function(){var a=this,c=arguments,e=arguments.length&&"function"==typeof arguments[0];return e?d.apply(a,[function(d){var e=b(a,d);c[0].apply(null,[e])},function(a){c[1]&&c[1].apply(null,a)},arguments[2]]):d.apply(a,arguments).then(function(c){return b(a,c)})}});var i=a.RTCPeerConnection.prototype.setLocalDescription;a.RTCPeerConnection.prototype.setLocalDescription=function(){var a=this;return arguments.length&&arguments[0].type?(arguments[0]=c(a,arguments[0]),i.apply(a,arguments)):i.apply(a,arguments)};var j=Object.getOwnPropertyDescriptor(a.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(a.RTCPeerConnection.prototype,"localDescription",{get:function(){var a=this,c=j.get.apply(this);return""===c.type?c:b(a,c)}}),a.RTCPeerConnection.prototype.removeTrack=function(a){var b=this;if("closed"===b.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!a._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");var c=a._pc===b;if(!c)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");b._streams=b._streams||{};var d;Object.keys(b._streams).forEach(function(c){var e=b._streams[c].getTracks().find(function(b){return a.track===b});e&&(d=b._streams[c])}),d&&(1===d.getTracks().length?b.removeStream(b._reverseStreams[d.id]):d.removeTrack(a.track),b.dispatchEvent(new Event("negotiationneeded")))}},shimPeerConnection:function(a){var b=f.detectBrowser(a);!a.RTCPeerConnection&&a.webkitRTCPeerConnection&&(a.RTCPeerConnection=function(b,c){return g("PeerConnection"),b&&b.iceTransportPolicy&&(b.iceTransports=b.iceTransportPolicy),new a.webkitRTCPeerConnection(b,c)},a.RTCPeerConnection.prototype=a.webkitRTCPeerConnection.prototype,a.webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(a.RTCPeerConnection,"generateCertificate",{get:function(){return a.webkitRTCPeerConnection.generateCertificate}}));var c=a.RTCPeerConnection.prototype.getStats;a.RTCPeerConnection.prototype.getStats=function(a,b,d){var e=this,f=arguments;if(arguments.length>0&&"function"==typeof a)return c.apply(this,arguments);if(0===c.length&&(0===arguments.length||"function"!=typeof arguments[0]))return c.apply(this,[]);var g=function(a){var b={},c=a.result();return c.forEach(function(a){var c={id:a.id,timestamp:a.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[a.type]||a.type};a.names().forEach(function(b){c[b]=a.stat(b)}),b[c.id]=c}),b},h=function(a){return new Map(Object.keys(a).map(function(b){return[b,a[b]]}))};if(arguments.length>=2){var i=function(a){f[1](h(g(a)))};return c.apply(this,[i,arguments[0]])}return new Promise(function(a,b){c.apply(e,[function(b){a(h(g(b)))},b])}).then(b,d)},b.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(b){var c=a.RTCPeerConnection.prototype[b];a.RTCPeerConnection.prototype[b]=function(){var a=arguments,b=this,d=new Promise(function(d,e){c.apply(b,[a[0],d,e])});return a.length<2?d:d.then(function(){a[1].apply(null,[])},function(b){a.length>=3&&a[2].apply(null,[b])})}}),b.version<52&&["createOffer","createAnswer"].forEach(function(b){var c=a.RTCPeerConnection.prototype[b];a.RTCPeerConnection.prototype[b]=function(){var a=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var b=1===arguments.length?arguments[0]:void 0;return new Promise(function(d,e){c.apply(a,[d,e,b])})}return c.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(b){var c=a.RTCPeerConnection.prototype[b];a.RTCPeerConnection.prototype[b]=function(){return arguments[0]=new("addIceCandidate"===b?a.RTCIceCandidate:a.RTCSessionDescription)(arguments[0]),c.apply(this,arguments)}});var d=a.RTCPeerConnection.prototype.addIceCandidate;a.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?d.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}},fixNegotiationNeeded:function(a){f.wrapPeerConnectionEvent(a,"negotiationneeded",function(a){var b=a.target;if("stable"===b.signalingState)return a})},shimGetDisplayMedia:function(a,b){return"getDisplayMedia"in a.navigator?void 0:"function"!=typeof b?void console.error("shimGetDisplayMedia: getSourceId argument is not a function"):void(navigator.getDisplayMedia=function(a){return b(a).then(function(b){return a.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:b,maxFrameRate:a.video.frameRate||3}},navigator.mediaDevices.getUserMedia(a)})})}}},{"../utils.js":14,"./getusermedia":6}],6:[function(a,b,c){"use strict";var d=a("../utils.js"),e=d.log;b.exports=function(a){var b=d.detectBrowser(a),c=a&&a.navigator,f=function(a){if("object"!=typeof a||a.mandatory||a.optional)return a;var b={};return Object.keys(a).forEach(function(c){if("require"!==c&&"advanced"!==c&&"mediaSource"!==c){var d="object"==typeof a[c]?a[c]:{ideal:a[c]};void 0!==d.exact&&"number"==typeof d.exact&&(d.min=d.max=d.exact);var e=function(a,b){return a?a+b.charAt(0).toUpperCase()+b.slice(1):"deviceId"===b?"sourceId":b};if(void 0!==d.ideal){b.optional=b.optional||[];var f={};"number"==typeof d.ideal?(f[e("min",c)]=d.ideal,b.optional.push(f),f={},f[e("max",c)]=d.ideal,b.optional.push(f)):(f[e("",c)]=d.ideal,b.optional.push(f))}void 0!==d.exact&&"number"!=typeof d.exact?(b.mandatory=b.mandatory||{},b.mandatory[e("",c)]=d.exact):["min","max"].forEach(function(a){void 0!==d[a]&&(b.mandatory=b.mandatory||{},b.mandatory[e(a,c)]=d[a])})}}),a.advanced&&(b.optional=(b.optional||[]).concat(a.advanced)),b},g=function(a,d){if(b.version>=61)return d(a);if(a=JSON.parse(JSON.stringify(a)),a&&"object"==typeof a.audio){var g=function(a,b,c){b in a&&!(c in a)&&(a[c]=a[b],delete a[b])};a=JSON.parse(JSON.stringify(a)),g(a.audio,"autoGainControl","googAutoGainControl"),g(a.audio,"noiseSuppression","googNoiseSuppression"),a.audio=f(a.audio)}if(a&&"object"==typeof a.video){var h=a.video.facingMode;h=h&&("object"==typeof h?h:{ideal:h});var i=b.version<66;if(h&&("user"===h.exact||"environment"===h.exact||"user"===h.ideal||"environment"===h.ideal)&&(!c.mediaDevices.getSupportedConstraints||!c.mediaDevices.getSupportedConstraints().facingMode||i)){delete a.video.facingMode;var j;if("environment"===h.exact||"environment"===h.ideal?j=["back","rear"]:("user"===h.exact||"user"===h.ideal)&&(j=["front"]),j)return c.mediaDevices.enumerateDevices().then(function(b){b=b.filter(function(a){return"videoinput"===a.kind});var c=b.find(function(a){return j.some(function(b){return-1!==a.label.toLowerCase().indexOf(b)})});return!c&&b.length&&-1!==j.indexOf("back")&&(c=b[b.length-1]),c&&(a.video.deviceId=h.exact?{exact:c.deviceId}:{ideal:c.deviceId}),a.video=f(a.video),e("chrome: "+JSON.stringify(a)),d(a)})}a.video=f(a.video)}return e("chrome: "+JSON.stringify(a)),d(a)},h=function(a){return b.version>=64?a:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[a.name]||a.name,message:a.message,constraint:a.constraint||a.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},i=function(a,b,d){g(a,function(a){c.webkitGetUserMedia(a,b,function(a){d&&d(h(a))})})};c.getUserMedia=i;var j=function(a){return new Promise(function(b,d){c.getUserMedia(a,b,d)})};if(c.mediaDevices||(c.mediaDevices={getUserMedia:j,enumerateDevices:function(){return new Promise(function(b){var c={audio:"audioinput",video:"videoinput"};return a.MediaStreamTrack.getSources(function(a){b(a.map(function(a){return{label:a.label,kind:c[a.kind],deviceId:a.id,groupId:""}}))})})},getSupportedConstraints:function(){return{deviceId:!0,echoCancellation:!0,facingMode:!0,frameRate:!0,height:!0,width:!0}}}),c.mediaDevices.getUserMedia){var k=c.mediaDevices.getUserMedia.bind(c.mediaDevices);c.mediaDevices.getUserMedia=function(a){return g(a,function(a){return k(a).then(function(b){if(a.audio&&!b.getAudioTracks().length||a.video&&!b.getVideoTracks().length)throw b.getTracks().forEach(function(a){a.stop()}),new DOMException("","NotFoundError");return b},function(a){return Promise.reject(h(a))})})}}else c.mediaDevices.getUserMedia=function(a){return j(a)};"undefined"==typeof c.mediaDevices.addEventListener&&(c.mediaDevices.addEventListener=function(){e("Dummy mediaDevices.addEventListener called.")}),"undefined"==typeof c.mediaDevices.removeEventListener&&(c.mediaDevices.removeEventListener=function(){e("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":14}],7:[function(a,b,c){"use strict";var d=a("sdp"),e=a("./utils");b.exports={shimRTCIceCandidate:function(a){if(a.RTCIceCandidate&&!(a.RTCIceCandidate&&"foundation"in a.RTCIceCandidate.prototype)){var b=a.RTCIceCandidate;a.RTCIceCandidate=function(a){if("object"==typeof a&&a.candidate&&0===a.candidate.indexOf("a=")&&(a=JSON.parse(JSON.stringify(a)),a.candidate=a.candidate.substr(2)),a.candidate&&a.candidate.length){var c=new b(a),e=d.parseCandidate(a.candidate),f=Object.assign(c,e);return f.toJSON=function(){return{candidate:f.candidate,sdpMid:f.sdpMid,sdpMLineIndex:f.sdpMLineIndex,usernameFragment:f.usernameFragment}},f}return new b(a)},a.RTCIceCandidate.prototype=b.prototype,e.wrapPeerConnectionEvent(a,"icecandidate",function(b){return b.candidate&&Object.defineProperty(b,"candidate",{value:new a.RTCIceCandidate(b.candidate),writable:"false"}),b})}},shimCreateObjectURL:function(a){var b=a&&a.URL;if(!("object"==typeof a&&a.HTMLMediaElement&&"srcObject"in a.HTMLMediaElement.prototype&&b.createObjectURL&&b.revokeObjectURL))return void 0;var c=b.createObjectURL.bind(b),d=b.revokeObjectURL.bind(b),f=new Map,g=0;b.createObjectURL=function(a){if("getTracks"in a){var b="polyblob:"+ ++g;return f.set(b,a),e.deprecated("URL.createObjectURL(stream)","elem.srcObject = stream"),b}return c(a)},b.revokeObjectURL=function(a){d(a),f["delete"](a)};var h=Object.getOwnPropertyDescriptor(a.HTMLMediaElement.prototype,"src");Object.defineProperty(a.HTMLMediaElement.prototype,"src",{get:function(){return h.get.apply(this)},set:function(a){return this.srcObject=f.get(a)||null,h.set.apply(this,[a])}});var i=a.HTMLMediaElement.prototype.setAttribute;a.HTMLMediaElement.prototype.setAttribute=function(){return 2===arguments.length&&"src"===(""+arguments[0]).toLowerCase()&&(this.srcObject=f.get(arguments[1])||null),i.apply(this,arguments)}},shimMaxMessageSize:function(a){if(!a.RTCSctpTransport&&a.RTCPeerConnection){var b=e.detectBrowser(a);"sctp"in a.RTCPeerConnection.prototype||Object.defineProperty(a.RTCPeerConnection.prototype,"sctp",{get:function(){return"undefined"==typeof this._sctp?null:this._sctp}});var c=function(a){var b=d.splitSections(a.sdp);return b.shift(),b.some(function(a){var b=d.parseMLine(a);return b&&"application"===b.kind&&-1!==b.protocol.indexOf("SCTP")})},f=function(a){var b=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===b||b.length<2)return-1;var c=parseInt(b[1],10);return c!==c?-1:c},g=function(a){var c=65536;return"firefox"===b.browser&&(c=b.version<57?-1===a?16384:2147483637:b.version<60?57===b.version?65535:65536:2147483637),c;
},h=function(a,c){var e=65536;"firefox"===b.browser&&57===b.version&&(e=65535);var f=d.matchPrefix(a.sdp,"a=max-message-size:");return f.length>0?e=parseInt(f[0].substr(19),10):"firefox"===b.browser&&-1!==c&&(e=2147483637),e},i=a.RTCPeerConnection.prototype.setRemoteDescription;a.RTCPeerConnection.prototype.setRemoteDescription=function(){var a=this;if(a._sctp=null,c(arguments[0])){var b,d=f(arguments[0]),e=g(d),j=h(arguments[0],d);b=0===e&&0===j?Number.POSITIVE_INFINITY:0===e||0===j?Math.max(e,j):Math.min(e,j);var k={};Object.defineProperty(k,"maxMessageSize",{get:function(){return b}}),a._sctp=k}return i.apply(a,arguments)}}},shimSendThrowTypeError:function(a){function b(a,b){var c=a.send;a.send=function(){var d=arguments[0],e=d.length||d.size||d.byteLength;if("open"===a.readyState&&b.sctp&&e>b.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+b.sctp.maxMessageSize+" bytes)");return c.apply(a,arguments)}}if(a.RTCPeerConnection&&"createDataChannel"in a.RTCPeerConnection.prototype){var c=a.RTCPeerConnection.prototype.createDataChannel;a.RTCPeerConnection.prototype.createDataChannel=function(){var a=this,d=c.apply(a,arguments);return b(d,a),d},e.wrapPeerConnectionEvent(a,"datachannel",function(a){return b(a.channel,a.target),a})}}}},{"./utils":14,sdp:2}],8:[function(a,b,c){"use strict";var d=a("../utils"),e=a("./filtericeservers"),f=a("rtcpeerconnection-shim");b.exports={shimGetUserMedia:a("./getusermedia"),shimPeerConnection:function(a){var b=d.detectBrowser(a);if(a.RTCIceGatherer&&(a.RTCIceCandidate||(a.RTCIceCandidate=function(a){return a}),a.RTCSessionDescription||(a.RTCSessionDescription=function(a){return a}),b.version<15025)){var c=Object.getOwnPropertyDescriptor(a.MediaStreamTrack.prototype,"enabled");Object.defineProperty(a.MediaStreamTrack.prototype,"enabled",{set:function(a){c.set.call(this,a);var b=new Event("enabled");b.enabled=a,this.dispatchEvent(b)}})}!a.RTCRtpSender||"dtmf"in a.RTCRtpSender.prototype||Object.defineProperty(a.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new a.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),a.RTCDtmfSender&&!a.RTCDTMFSender&&(a.RTCDTMFSender=a.RTCDtmfSender);var g=f(a,b.version);a.RTCPeerConnection=function(a){return a&&a.iceServers&&(a.iceServers=e(a.iceServers)),new g(a)},a.RTCPeerConnection.prototype=g.prototype},shimReplaceTrack:function(a){!a.RTCRtpSender||"replaceTrack"in a.RTCRtpSender.prototype||(a.RTCRtpSender.prototype.replaceTrack=a.RTCRtpSender.prototype.setTrack)}}},{"../utils":14,"./filtericeservers":9,"./getusermedia":10,"rtcpeerconnection-shim":1}],9:[function(a,b,c){"use strict";var d=a("../utils");b.exports=function(a,b){var c=!1;return a=JSON.parse(JSON.stringify(a)),a.filter(function(a){if(a&&(a.urls||a.url)){var e=a.urls||a.url;a.url&&!a.urls&&d.deprecated("RTCIceServer.url","RTCIceServer.urls");var f="string"==typeof e;return f&&(e=[e]),e=e.filter(function(a){var d=0===a.indexOf("turn:")&&-1!==a.indexOf("transport=udp")&&-1===a.indexOf("turn:[")&&!c;return d?(c=!0,!0):0===a.indexOf("stun:")&&b>=14393&&-1===a.indexOf("?transport=udp")}),delete a.url,a.urls=f?e[0]:e,!!e.length}})}},{"../utils":14}],10:[function(a,b,c){"use strict";b.exports=function(a){var b=a&&a.navigator,c=function(a){return{name:{PermissionDeniedError:"NotAllowedError"}[a.name]||a.name,message:a.message,constraint:a.constraint,toString:function(){return this.name}}},d=b.mediaDevices.getUserMedia.bind(b.mediaDevices);b.mediaDevices.getUserMedia=function(a){return d(a)["catch"](function(a){return Promise.reject(c(a))})}}},{}],11:[function(a,b,c){"use strict";var d=a("../utils");b.exports={shimGetUserMedia:a("./getusermedia"),shimOnTrack:function(a){"object"!=typeof a||!a.RTCPeerConnection||"ontrack"in a.RTCPeerConnection.prototype||Object.defineProperty(a.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(a){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=a),this.addEventListener("addstream",this._ontrackpoly=function(a){a.stream.getTracks().forEach(function(b){var c=new Event("track");c.track=b,c.receiver={track:b},c.transceiver={receiver:c.receiver},c.streams=[a.stream],this.dispatchEvent(c)}.bind(this))}.bind(this))},enumerable:!0,configurable:!0}),"object"==typeof a&&a.RTCTrackEvent&&"receiver"in a.RTCTrackEvent.prototype&&!("transceiver"in a.RTCTrackEvent.prototype)&&Object.defineProperty(a.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimSourceObject:function(a){"object"==typeof a&&(!a.HTMLMediaElement||"srcObject"in a.HTMLMediaElement.prototype||Object.defineProperty(a.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(a){this.mozSrcObject=a}}))},shimPeerConnection:function(a){var b=d.detectBrowser(a);if("object"==typeof a&&(a.RTCPeerConnection||a.mozRTCPeerConnection)){a.RTCPeerConnection||(a.RTCPeerConnection=function(c,d){if(b.version<38&&c&&c.iceServers){for(var e=[],f=0;f<c.iceServers.length;f++){var g=c.iceServers[f];if(g.hasOwnProperty("urls"))for(var h=0;h<g.urls.length;h++){var i={url:g.urls[h]};0===g.urls[h].indexOf("turn")&&(i.username=g.username,i.credential=g.credential),e.push(i)}else e.push(c.iceServers[f])}c.iceServers=e}return new a.mozRTCPeerConnection(c,d)},a.RTCPeerConnection.prototype=a.mozRTCPeerConnection.prototype,a.mozRTCPeerConnection.generateCertificate&&Object.defineProperty(a.RTCPeerConnection,"generateCertificate",{get:function(){return a.mozRTCPeerConnection.generateCertificate}}),a.RTCSessionDescription=a.mozRTCSessionDescription,a.RTCIceCandidate=a.mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(b){var c=a.RTCPeerConnection.prototype[b];a.RTCPeerConnection.prototype[b]=function(){return arguments[0]=new("addIceCandidate"===b?a.RTCIceCandidate:a.RTCSessionDescription)(arguments[0]),c.apply(this,arguments)}});var c=a.RTCPeerConnection.prototype.addIceCandidate;a.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?c.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var e=function(a){var b=new Map;return Object.keys(a).forEach(function(c){b.set(c,a[c]),b[c]=a[c]}),b},f={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},g=a.RTCPeerConnection.prototype.getStats;a.RTCPeerConnection.prototype.getStats=function(a,c,d){return g.apply(this,[a||null]).then(function(a){if(b.version<48&&(a=e(a)),b.version<53&&!c)try{a.forEach(function(a){a.type=f[a.type]||a.type})}catch(d){if("TypeError"!==d.name)throw d;a.forEach(function(b,c){a.set(c,Object.assign({},b,{type:f[b.type]||b.type}))})}return a}).then(c,d)}}},shimSenderGetStats:function(a){if("object"==typeof a&&a.RTCPeerConnection&&a.RTCRtpSender&&!(a.RTCRtpSender&&"getStats"in a.RTCRtpSender.prototype)){var b=a.RTCPeerConnection.prototype.getSenders;b&&(a.RTCPeerConnection.prototype.getSenders=function(){var a=this,c=b.apply(a,[]);return c.forEach(function(b){b._pc=a}),c});var c=a.RTCPeerConnection.prototype.addTrack;c&&(a.RTCPeerConnection.prototype.addTrack=function(){var a=c.apply(this,arguments);return a._pc=this,a}),a.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}},shimReceiverGetStats:function(a){if("object"==typeof a&&a.RTCPeerConnection&&a.RTCRtpSender&&!(a.RTCRtpSender&&"getStats"in a.RTCRtpReceiver.prototype)){var b=a.RTCPeerConnection.prototype.getReceivers;b&&(a.RTCPeerConnection.prototype.getReceivers=function(){var a=this,c=b.apply(a,[]);return c.forEach(function(b){b._pc=a}),c}),d.wrapPeerConnectionEvent(a,"track",function(a){return a.receiver._pc=a.srcElement,a}),a.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}},shimRemoveStream:function(a){!a.RTCPeerConnection||"removeStream"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.removeStream=function(a){var b=this;d.deprecated("removeStream","removeTrack"),this.getSenders().forEach(function(c){c.track&&-1!==a.getTracks().indexOf(c.track)&&b.removeTrack(c)})})},shimRTCDataChannel:function(a){a.DataChannel&&!a.RTCDataChannel&&(a.RTCDataChannel=a.DataChannel)},shimGetDisplayMedia:function(a,b){"getDisplayMedia"in a.navigator||(navigator.getDisplayMedia=function(a){if(!a||!a.video){var c=new DOMException("getDisplayMedia without video constraints is undefined");return c.name="NotFoundError",c.code=8,Promise.reject(c)}return a.video===!0?a.video={mediaSource:b}:a.video.mediaSource=b,navigator.mediaDevices.getUserMedia(a)})}}},{"../utils":14,"./getusermedia":12}],12:[function(a,b,c){"use strict";var d=a("../utils"),e=d.log;b.exports=function(a){var b=d.detectBrowser(a),c=a&&a.navigator,f=a&&a.MediaStreamTrack,g=function(a){return{name:{InternalError:"NotReadableError",NotSupportedError:"TypeError",PermissionDeniedError:"NotAllowedError",SecurityError:"NotAllowedError"}[a.name]||a.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[a.message]||a.message,constraint:a.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},h=function(a,d,f){var h=function(a){if("object"!=typeof a||a.require)return a;var b=[];return Object.keys(a).forEach(function(c){if("require"!==c&&"advanced"!==c&&"mediaSource"!==c){var d=a[c]="object"==typeof a[c]?a[c]:{ideal:a[c]};if((void 0!==d.min||void 0!==d.max||void 0!==d.exact)&&b.push(c),void 0!==d.exact&&("number"==typeof d.exact?d.min=d.max=d.exact:a[c]=d.exact,delete d.exact),void 0!==d.ideal){a.advanced=a.advanced||[];var e={};"number"==typeof d.ideal?e[c]={min:d.ideal,max:d.ideal}:e[c]=d.ideal,a.advanced.push(e),delete d.ideal,Object.keys(d).length||delete a[c]}}}),b.length&&(a.require=b),a};return a=JSON.parse(JSON.stringify(a)),b.version<38&&(e("spec: "+JSON.stringify(a)),a.audio&&(a.audio=h(a.audio)),a.video&&(a.video=h(a.video)),e("ff37: "+JSON.stringify(a))),c.mozGetUserMedia(a,d,function(a){f(g(a))})},i=function(a){return new Promise(function(b,c){h(a,b,c)})};if(c.mediaDevices||(c.mediaDevices={getUserMedia:i,addEventListener:function(){},removeEventListener:function(){}}),c.mediaDevices.enumerateDevices=c.mediaDevices.enumerateDevices||function(){return new Promise(function(a){var b=[{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}];a(b)})},b.version<41){var j=c.mediaDevices.enumerateDevices.bind(c.mediaDevices);c.mediaDevices.enumerateDevices=function(){return j().then(void 0,function(a){if("NotFoundError"===a.name)return[];throw a})}}if(b.version<49){var k=c.mediaDevices.getUserMedia.bind(c.mediaDevices);c.mediaDevices.getUserMedia=function(a){return k(a).then(function(b){if(a.audio&&!b.getAudioTracks().length||a.video&&!b.getVideoTracks().length)throw b.getTracks().forEach(function(a){a.stop()}),new DOMException("The object can not be found here.","NotFoundError");return b},function(a){return Promise.reject(g(a))})}}if(!(b.version>55&&"autoGainControl"in c.mediaDevices.getSupportedConstraints())){var l=function(a,b,c){b in a&&!(c in a)&&(a[c]=a[b],delete a[b])},m=c.mediaDevices.getUserMedia.bind(c.mediaDevices);if(c.mediaDevices.getUserMedia=function(a){return"object"==typeof a&&"object"==typeof a.audio&&(a=JSON.parse(JSON.stringify(a)),l(a.audio,"autoGainControl","mozAutoGainControl"),l(a.audio,"noiseSuppression","mozNoiseSuppression")),m(a)},f&&f.prototype.getSettings){var n=f.prototype.getSettings;f.prototype.getSettings=function(){var a=n.apply(this,arguments);return l(a,"mozAutoGainControl","autoGainControl"),l(a,"mozNoiseSuppression","noiseSuppression"),a}}if(f&&f.prototype.applyConstraints){var o=f.prototype.applyConstraints;f.prototype.applyConstraints=function(a){return"audio"===this.kind&&"object"==typeof a&&(a=JSON.parse(JSON.stringify(a)),l(a,"autoGainControl","mozAutoGainControl"),l(a,"noiseSuppression","mozNoiseSuppression")),o.apply(this,[a])}}}c.getUserMedia=function(a,e,f){return b.version<44?h(a,e,f):(d.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),void c.mediaDevices.getUserMedia(a).then(e,f))}}},{"../utils":14}],13:[function(a,b,c){"use strict";var d=a("../utils");b.exports={shimLocalStreamsAPI:function(a){if("object"==typeof a&&a.RTCPeerConnection){if("getLocalStreams"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),"getStreamById"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.getStreamById=function(a){var b=null;return this._localStreams&&this._localStreams.forEach(function(c){c.id===a&&(b=c)}),this._remoteStreams&&this._remoteStreams.forEach(function(c){c.id===a&&(b=c)}),b}),!("addStream"in a.RTCPeerConnection.prototype)){var b=a.RTCPeerConnection.prototype.addTrack;a.RTCPeerConnection.prototype.addStream=function(a){this._localStreams||(this._localStreams=[]),-1===this._localStreams.indexOf(a)&&this._localStreams.push(a);var c=this;a.getTracks().forEach(function(d){b.call(c,d,a)})},a.RTCPeerConnection.prototype.addTrack=function(a,c){return c&&(this._localStreams?-1===this._localStreams.indexOf(c)&&this._localStreams.push(c):this._localStreams=[c]),b.call(this,a,c)}}"removeStream"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.removeStream=function(a){this._localStreams||(this._localStreams=[]);var b=this._localStreams.indexOf(a);if(-1!==b){this._localStreams.splice(b,1);var c=this,d=a.getTracks();this.getSenders().forEach(function(a){-1!==d.indexOf(a.track)&&c.removeTrack(a)})}})}},shimRemoteStreamsAPI:function(a){if("object"==typeof a&&a.RTCPeerConnection&&("getRemoteStreams"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in a.RTCPeerConnection.prototype))){Object.defineProperty(a.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(a){this._onaddstream&&this.removeEventListener("addstream",this._onaddstream),this.addEventListener("addstream",this._onaddstream=a)}});var b=a.RTCPeerConnection.prototype.setRemoteDescription;a.RTCPeerConnection.prototype.setRemoteDescription=function(){var a=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(b){b.streams.forEach(function(b){if(a._remoteStreams||(a._remoteStreams=[]),!(a._remoteStreams.indexOf(b)>=0)){a._remoteStreams.push(b);var c=new Event("addstream");c.stream=b,a.dispatchEvent(c)}})}),b.apply(a,arguments)}}},shimCallbacksAPI:function(a){if("object"==typeof a&&a.RTCPeerConnection){var b=a.RTCPeerConnection.prototype,c=b.createOffer,d=b.createAnswer,e=b.setLocalDescription,f=b.setRemoteDescription,g=b.addIceCandidate;b.createOffer=function(a,b){var d=arguments.length>=2?arguments[2]:arguments[0],e=c.apply(this,[d]);return b?(e.then(a,b),Promise.resolve()):e},b.createAnswer=function(a,b){var c=arguments.length>=2?arguments[2]:arguments[0],e=d.apply(this,[c]);return b?(e.then(a,b),Promise.resolve()):e};var h=function(a,b,c){var d=e.apply(this,[a]);return c?(d.then(b,c),Promise.resolve()):d};b.setLocalDescription=h,h=function(a,b,c){var d=f.apply(this,[a]);return c?(d.then(b,c),Promise.resolve()):d},b.setRemoteDescription=h,h=function(a,b,c){var d=g.apply(this,[a]);return c?(d.then(b,c),Promise.resolve()):d},b.addIceCandidate=h}},shimGetUserMedia:function(a){var b=a&&a.navigator;b.getUserMedia||(b.webkitGetUserMedia?b.getUserMedia=b.webkitGetUserMedia.bind(b):b.mediaDevices&&b.mediaDevices.getUserMedia&&(b.getUserMedia=function(a,c,d){b.mediaDevices.getUserMedia(a).then(c,d)}.bind(b)))},shimRTCIceServerUrls:function(a){var b=a.RTCPeerConnection;a.RTCPeerConnection=function(a,c){if(a&&a.iceServers){for(var e=[],f=0;f<a.iceServers.length;f++){var g=a.iceServers[f];!g.hasOwnProperty("urls")&&g.hasOwnProperty("url")?(d.deprecated("RTCIceServer.url","RTCIceServer.urls"),g=JSON.parse(JSON.stringify(g)),g.urls=g.url,delete g.url,e.push(g)):e.push(a.iceServers[f])}a.iceServers=e}return new b(a,c)},a.RTCPeerConnection.prototype=b.prototype,"generateCertificate"in a.RTCPeerConnection&&Object.defineProperty(a.RTCPeerConnection,"generateCertificate",{get:function(){return b.generateCertificate}})},shimTrackEventTransceiver:function(a){"object"==typeof a&&a.RTCPeerConnection&&"receiver"in a.RTCTrackEvent.prototype&&!a.RTCTransceiver&&Object.defineProperty(a.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimCreateOfferLegacy:function(a){var b=a.RTCPeerConnection.prototype.createOffer;a.RTCPeerConnection.prototype.createOffer=function(a){var c=this;if(a){"undefined"!=typeof a.offerToReceiveAudio&&(a.offerToReceiveAudio=!!a.offerToReceiveAudio);var d=c.getTransceivers().find(function(a){return a.sender.track&&"audio"===a.sender.track.kind});a.offerToReceiveAudio===!1&&d?"sendrecv"===d.direction?d.setDirection?d.setDirection("sendonly"):d.direction="sendonly":"recvonly"===d.direction&&(d.setDirection?d.setDirection("inactive"):d.direction="inactive"):a.offerToReceiveAudio!==!0||d||c.addTransceiver("audio"),"undefined"!=typeof a.offerToReceiveVideo&&(a.offerToReceiveVideo=!!a.offerToReceiveVideo);var e=c.getTransceivers().find(function(a){return a.sender.track&&"video"===a.sender.track.kind});a.offerToReceiveVideo===!1&&e?"sendrecv"===e.direction?e.setDirection("sendonly"):"recvonly"===e.direction&&e.setDirection("inactive"):a.offerToReceiveVideo!==!0||e||c.addTransceiver("video")}return b.apply(c,arguments)}}}},{"../utils":14}],14:[function(a,b,c){"use strict";function d(a,b,c){var d=a.match(b);return d&&d.length>=c&&parseInt(d[c],10)}function e(a,b,c){if(a.RTCPeerConnection){var d=a.RTCPeerConnection.prototype,e=d.addEventListener;d.addEventListener=function(a,d){if(a!==b)return e.apply(this,arguments);var f=function(a){var b=c(a);b&&d(b)};return this._eventMap=this._eventMap||{},this._eventMap[d]=f,e.apply(this,[a,f])};var f=d.removeEventListener;d.removeEventListener=function(a,c){if(a!==b||!this._eventMap||!this._eventMap[c])return f.apply(this,arguments);var d=this._eventMap[c];return delete this._eventMap[c],f.apply(this,[a,d])},Object.defineProperty(d,"on"+b,{get:function(){return this["_on"+b]},set:function(a){this["_on"+b]&&(this.removeEventListener(b,this["_on"+b]),delete this["_on"+b]),a&&this.addEventListener(b,this["_on"+b]=a)},enumerable:!0,configurable:!0})}}var f=!0,g=!0;b.exports={extractVersion:d,wrapPeerConnectionEvent:e,disableLog:function(a){return"boolean"!=typeof a?new Error("Argument type: "+typeof a+". Please use a boolean."):(f=a,a?"adapter.js logging disabled":"adapter.js logging enabled")},disableWarnings:function(a){return"boolean"!=typeof a?new Error("Argument type: "+typeof a+". Please use a boolean."):(g=!a,"adapter.js deprecation warnings "+(a?"disabled":"enabled"))},log:function(){if("object"==typeof window){if(f)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},deprecated:function(a,b){g&&console.warn(a+" is deprecated, please use "+b+" instead.")},detectBrowser:function(a){var b=a&&a.navigator,c={};if(c.browser=null,c.version=null,"undefined"==typeof a||!a.navigator)return c.browser="Not a browser.",c;if(b.mozGetUserMedia)c.browser="firefox",c.version=d(b.userAgent,/Firefox\/(\d+)\./,1);else if(b.webkitGetUserMedia)c.browser="chrome",c.version=d(b.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(b.mediaDevices&&b.userAgent.match(/Edge\/(\d+).(\d+)$/))c.browser="edge",c.version=d(b.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!a.RTCPeerConnection||!b.userAgent.match(/AppleWebKit\/(\d+)\./))return c.browser="Not a supported browser.",c;c.browser="safari",c.version=d(b.userAgent,/AppleWebKit\/(\d+)\./,1)}return c}}},{}]},{},[3]);var wsc=function(a){function b(){var a={};if(a.browser=null,a.version=null,"undefined"==typeof window||!window.navigator)return a.browser="Not a browser.",a;if(navigator.mozGetUserMedia)a.browser="firefox",a.version=c(navigator.userAgent,/Firefox\/([0-9]+)\./,1);else if(navigator.webkitGetUserMedia)if(window.webkitRTCPeerConnection)a.browser="chrome",a.version=c(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2);else{if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return a.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",a;a.browser="safari",a.version=c(navigator.userAgent,/AppleWebKit\/([0-9]+)\./,1)}else{if(!navigator.mediaDevices||!navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))return a.browser="Not a supported browser.",a;a.browser="edge",a.version=c(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2)}return a}function c(a,b,c){var d=a.match(b);return d&&d.length>=c&&parseInt(d[c],10)}var d=a._private=a._private||{},e=b(),f={};f.isFirefox="firefox"===e.browser,f.isChrome="chrome"===e.browser,f.isEdge="edge"===e.browser,f.isIE=!1,f.isSafari=!1,f.version=e.version,f.supportSessionStorage=!1;try{f.supportSessionStorage="sessionStorage"in window&&null!=window.sessionStorage}catch(g){}if(-1!=navigator.userAgent.indexOf("MSIE"))var h=/MSIE (\d+\.\d+);/;else var h=/Trident.*rv[ :]*(\d+\.\d+)/;return h.test(navigator.userAgent)&&(f.isIE=!0,f.version=new Number(RegExp.$1)),-1==navigator.userAgent.indexOf("Safari")||f.isChrome||f.isFirefox||(f.isSafari=!0),d.browser=f,a}(wsc||{}),wsc=function(a){var b=a._private=a._private||{},c={};return c.LOGLEVEL={DEBUG:2,INFO:4,WARN:6,ERROR:8,OFF:10},c.SESSIONSTATE={NONE:"NONE",CONNECTED:"CONNECTED",RECONNECTING:"RECONNECTING",RELOADING:"RELOADING",HIBERNATED:"HIBERNATED",SUSPENDED:"SUSPENDED",FAILED:"FAILED",CLOSED:"CLOSED"},c.CALLSTATE={NONE:"NONE",STARTED:"STARTED",RESPONDED:"RESPONDED",ESTABLISHED:"ESTABLISHED",UPDATING:"UPDATING",UPDATE_FAILED:"UPDATE_FAILED",UPDATED:"UPDATED",FAILED:"FAILED",ERROR:"ERROR",ENDED:"ENDED"},c.MEDIASTREAMEVENT={LOCAL_STREAM_ADDED:"LOCAL_STREAM_ADDED",LOCAL_STREAM_REMOVED:"LOCAL_STREAM_REMOVED",LOCAL_STREAM_ERROR:"LOCAL_STREAM_ERROR",REMOTE_STREAM_ADDED:"REMOTE_STREAM_ADDED",REMOTE_STREAM_REMOVED:"REMOTE_STREAM_REMOVED",REMOTE_STREAM_ERROR:"REMOTE_STREAM_ERROR"},c.MEDIADIRECTION={SENDONLY:"SENDONLY",RECVONLY:"RECVONLY",SENDRECV:"SENDRECV",NONE:"NONE"},c.ERRORCODE={UNAUTHORIZED:401,FORBIDDEN:403,RESOURCE_UNAVAILABLE:404,PROXYAUTH_REQUIRED:407,TEMPORARILY_UNAVAILABLE:480,BUSY_HERE:486,REQUEST_TERMINATED:487,SYSTEM_ERROR:500,BUSY_EVERYWHERE:600,DECLINED:603,WEBSOCKET_ERROR:1001,PEERCONNECTION_ERROR:1101,MEDIA_ERROR:1201,RESTORE_FAILED:1301,SAVE_FAILED:1302},c.AUTHTYPE={SERVICE:"SERVICE",TURN:"TURN"},c.ConnectionStateEnum={INIT:"init",ESTABLISHED:"established",ERROR:"error",CLOSED:"closed"},c.PACKAGE={ALL:"all",REGISTER:"register",CALL:"call",MESSAGE_NOTIFICATION:"message_notification",MESSAGING:"messaging",CAPABILITY:"capability",CHAT:"chat",FILE_TRANSFER:"file_transfer"},c.CONSTCS={SERVER:"s",CLIENT:"c"},c.RESUME_STATE={waittingFinalResp:"waittingFinalResp",reStartingCall:"reStartingCall"},c.OFFER_ANSWER_STATE={INITIAL:"Initial state",OFFER_SENT:"Offer sent",OFFER_GOT:"Offer received",OFFER_REJECTED:"My offer was rejected by the other peer",OFFER_REJECT:"I Rejected the other peer's offer",ANSWER_SENT:"Answer sent",ANSWER_GOT:"Answer received",ACK_SENT:"Ack sent",ACK_GOT:"Ack received",GLARE:"Glare state"},c.TYPE={REQUEST:"request",ACK:"acknowledgement",RESPONSE:"response",MESSAGE:"message",ERROR:"error"},c.ACTION={CONNECT:"connect",START:"start",SHUTDOWN:"shutdown",COMPLETE:"complete",NOTIFY:"notify",TRICKLE:"trickle",PRACK:"prack",ENQUIRY:"enquiry",HIBERNATE:"hibernate",ICE_ENQUIRY:"iceEnquiry",RELAY_FAILED:"relayFailed"},c.MESSAGESTATE={INITIAL:"initial",SUBSEQUENT:"subsequent",FINAL:"final"},c.ICE_CHECK_PERIOD=2e3,c.PROTOCOL_VERSION="3.0",b.wscConst=c,a.MEDIADIRECTION=c.MEDIADIRECTION,a.SESSIONSTATE=c.SESSIONSTATE,a.CALLSTATE=c.CALLSTATE,a.MEDIASTREAMEVENT=c.MEDIASTREAMEVENT,a.ERRORCODE=c.ERRORCODE,a.AUTHTYPE=c.AUTHTYPE,a.ConnectionStateEnum=c.ConnectionStateEnum,a.LOGLEVEL=c.LOGLEVEL,a.MSSAGETYPE=c.TYPE,a.ACTION=c.ACTION,a}(wsc||{}),wsc=function(a){var b=a._private=a._private||{},c=b.wscUtils=b.wscUtils||{};return c.Map=function(){"use strict";this.mapSize=0,this.entry={}},c.Map.prototype={put:function(a,b){this.containsKey(a)||(this.mapSize=this.mapSize+1),this.entry[a]=b},get:function(a){var b=null;return this.containsKey(a)&&(b=this.entry[a]),b},remove:function(a){this.containsKey(a)&&delete this.entry[a]&&(this.mapSize=this.mapSize-1)},clear:function(){for(var a in this.entry)delete this.entry[a];this.mapSize=0},containsKey:function(a){var b=!1;return a in this.entry&&(b=!0),b},containsValue:function(a){for(var b in this.entry)if(this.entry[b]==a)return!0;return!1},values:function(){var a=[];for(var b in this.entry)a.push(this.entry[b]);return a},keys:function(){var a=[];for(var b in this.entry)a.push(b);return a},size:function(){return this.mapSize}},c.Queue=function(){var a=[],b=0;this.toJSON=function(){var c={array:a,offset:b};return c},this.length=function(){return a.length-b},this.enqueue=function(b){a.push(b)},this.dequeue=function(){if(0===a.length)return null;var c=a[b];return 2*++b>=a.length&&(a=a.slice(b),b=0),c},this.peek=function(){return a.length>0?a[b]:null}},a.Map=c.Map,a}(wsc||{}),wsc=function(a){var b=a._private=a._private||{},c=b.wscUtils=b.wscUtils||{},d=b.wscConst,e=console,f=null,g=d.LOGLEVEL.WARN,h="";return c.setLogger=function(a){e=a,c.AspectConfig.aspectClassMap.clear(),c.initAspectConfig()},c.getLogger=function(){return f},c.setLogLevel=function(a){g=a},c.getLogLevel=function(){return g},c.setsessionid=function(a){h=a},c.printTimeStr=function(a){var b,c=new Date;return b=a?c.getDateStr(a):c.getDateStr(),b+" "},Date.prototype.getDateStr=function(a){var b={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};a||(a="yyyy-MM-dd hh:mm:ss"),/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var c in b)new RegExp("("+c+")").test(a)&&(a=a.replace(RegExp.$1,1==RegExp.$1.length?b[c]:("00"+b[c]).substr((""+b[c]).length)));return a},c.waveFunc=function(a,b){if(b){if(b.prototype){var d=function(){};d.prototype=b.prototype;var e=a.prototype;a.prototype=new d,e&&c.deepCopy(e,a.prototype),a.prototype.constructor=a}if(b.prototype)a.superclass=b.prototype,a.superclass.constructor=b;else{for(var f in b)"object"==typeof b&&"error"!=f&&"warn"!=f&&"log"!=f&&"info"!=f&&"debug"!=f?a[f]=function(a){return function(){b[a](arguments[0])}}(f):a[f]=b[f];a.superclass=b,a.prototype=void 0}}},c.AspectConfig={},c.getCaller_line=function(){var a=null;try{a=(new Error).stack.split("\n")[4],a.indexOf("Error")>=0&&(a=null)}catch(b){}return a},c.isDebugEnabled=function(){var a=!1;if(g===d.LOGLEVEL.DEBUG&&(a=!0),a&&e){var b=c.getCaller_line();if(b=b?"Debug line:"+b:"Debug:",b.indexOf("tmpProxyClass")>0)return!0;e.debug(c.printTimeStr()+"[wsc "+b+"]")}return a},c.isInfoEnabled=function(){var a=!1;return g<=d.LOGLEVEL.INFO&&(a=!0),a&&e&&e.info(c.printTimeStr()+"[wsc Info]:"),a},c.isWarnEnabled=function(){var a=!1;if(g<=d.LOGLEVEL.WARN&&(a=!0),a&&e){var b=c.getCaller_line();if(b=b?"Warn line:"+b:"Warn:",b.indexOf("tmpProxyClass")>0)return!0;e.warn(c.printTimeStr()+"[wsc "+b+"]")}return a},c.isErrorEnabled=function(){var a=!1;if(g<=d.LOGLEVEL.ERROR&&(a=!0),a&&e){var b=null;if(b=c.getCaller_line(),b=b?"Error line:"+b:"Error:",b.indexOf("tmpProxyClass")>0)return!0}return a},c.AspectConfig.aspectClassMap=new c.Map,d.WAVETYPE={BEFORE:"before",AFTER:"after",AFTERRETURN:"afterReturn",AFTERTHROW:"afterThrow"},c.AspectConfig.wavePointcut=function(a,b,g,h){var i,j,k=c.AspectConfig.aspectClassMap.get(a);null==k?(k=function(){k.superclass&&k.superclass.prototype&&k.superclass.constructor.apply(this,arguments)},c.waveFunc(k,a),j=k):(i=function(){i.superclass&&i.superclass.prototype&&i.superclass.constructor.apply(this,arguments)},c.waveFunc(i,k),j=i);var l,m=b.indexOf("*"),n=!1;m>=0&&(l=m>0?new RegExp("^"+b.substr(0,m)):new RegExp(b.substr(1)+"$"));var o=function(c){var d=null,e=j;f.superclass&&(e=f.superclass);try{for(;e.superclass;)e=e.superclass;d=e[b]?e[b].apply(e,c):a[b].apply(a,c)}catch(g){f.warn(g)}return d};if(a.prototype){if(a.prototype[b]){switch(h){case d.WAVETYPE.BEFORE:j.prototype[b]=function(){var a=!1,c=null;try{a=g(arguments)}catch(d){throw d}return a&&(c=j.superclass[b].apply(this,arguments),null!==c&&void 0!==c)?c:void 0};break;case d.WAVETYPE.AFTER:j.prototype[b]=function(){var a=null;try{a=j.superclass[b].apply(this,arguments)}catch(c){throw e.error(b+" exception:"+c),c}return g(arguments),null!==a&&void 0!==a?a:void 0};break;case d.WAVETYPE.AFTERRETURN:j.prototype[b]=function(){var a=null;return a=j.superclass[b].apply(this,arguments),g(arguments),null!==a&&void 0!==a?a:void 0};break;case d.WAVETYPE.AFTERTHROW:j.prototype[b]=function(){var a=null;try{if(a=j.superclass[b].apply(this,arguments),null!==a&&void 0!==a)return a}catch(c){g(b,c)}}}n=!0}else if(m>=0)for(var p in a.prototype)if(l.test(p)){switch(h){case d.WAVETYPE.BEFORE:j.prototype[p]=function(){var a=!1,b=null;try{a=g(arguments)}catch(c){throw c}return a&&(b=j.superclass[p].apply(this,arguments),null!==b&&void 0!==b)?b:void 0};break;case d.WAVETYPE.AFTER:j.prototype[p]=function(){var a=null;try{a=j.superclass[p].apply(this,arguments)}catch(b){throw e.error(p+" exception:"+b),b}return g(arguments),null!==a&&void 0!==a?a:void 0};break;case d.WAVETYPE.AFTERRETURN:j.prototype[p]=function(){var a=null;return a=j.superclass[p].apply(this,arguments),g(arguments),null!==a&&void 0!==a?a:void 0};break;case d.WAVETYPE.AFTERTHROW:j.prototype[p]=function(){var a=null;try{if(a=j.superclass[p].apply(this,arguments),null!==a&&void 0!==a)return a}catch(b){g(p,b)}}}n=!0}}else if(a[b]){switch(h){case d.WAVETYPE.BEFORE:j[b]=function(){var a=g(arguments);if(a){var b=o(arguments);if(null!==b&&void 0!==b)return b}};break;case d.WAVETYPE.AFTER:j[b]=function(){try{var a=o(arguments)}catch(c){e.error(b+" exception:"+c)}return g(arguments),null!==a&&void 0!==a?a:void 0};break;case d.WAVETYPE.AFTERRETURN:j[b]=function(){var a=o(arguments);return g(arguments),null!==a&&void 0!==a?a:void 0};break;case d.WAVETYPE.AFTERTHROW:j[b]=function(){try{var a=o(arguments);if(null!==a&&void 0!==a)return a}catch(c){g(b,c)}}}n=!0}else if(m>=0)for(var p in a)if(l.test(p)){switch(h){case d.WAVETYPE.BEFORE:j[p]=function(){var a=g(arguments);if(a){var b=o(arguments);if(null!==b&&void 0!==b)return b}};break;case d.WAVETYPE.AFTER:j[p]=function(){try{var a=o(arguments);if(null!==a&&void 0!==a)return a}catch(b){e.error(p+" exception:"+b)}return g(arguments),a};break;case d.WAVETYPE.AFTERRETURN:j[p]=function(){var a=o(arguments);return g(arguments),null!==a&&void 0!==a?a:void 0};break;case d.WAVETYPE.AFTERTHROW:j[p]=function(){try{var a=o(arguments);if(null!==a&&void 0!==a)return a}catch(b){g(p,b)}}}n=!0}n&&c.AspectConfig.aspectClassMap.put(a,j)},c.AspectConfig.before=function(a,b,e){c.AspectConfig.wavePointcut(a,b,e,d.WAVETYPE.BEFORE)},c.AspectConfig.after=function(a,b,e){c.AspectConfig.wavePointcut(a,b,e,d.WAVETYPE.AFTER)},c.AspectConfig.afterReturn=function(a,b,e){c.AspectConfig.wavePointcut(a,b,e,d.WAVETYPE.AFTERRETURN)},c.AspectConfig.afterThrow=function(a,b,e){c.AspectConfig.wavePointcut(a,b,e,d.WAVETYPE.AFTERTHROW)},c.AspectConfig.getWavedObject=function(a){var b=c.AspectConfig.aspectClassMap.get(a),d=null;return b||(b=a),d=new b},c.AspectConfig.getWavedClass=function(a){var b=c.AspectConfig.aspectClassMap.get(a);return b||(b=a),b},c.initAspectConfig=function(){e?(c.AspectConfig.before(e,"info",c.isInfoEnabled),c.AspectConfig.before(e,"debug",c.isDebugEnabled),
c.AspectConfig.before(e,"warn",c.isWarnEnabled),c.AspectConfig.before(e,"error",c.isErrorEnabled),c.AspectConfig.before(e,"log",c.isInfoEnabled),f=c.AspectConfig.getWavedClass(e)):(e={},f=e),f.info||(f.info=function(){},e.info=function(){}),f.debug||(f.debug=function(){},e.debug=function(){}),f.warn||(f.warn=function(){},e.warn=function(){}),f.error||(f.error=function(){},e.error=function(){}),f.log||(f.log=function(){},e.log=function(){})},c.initAspectConfig(),a.setLogLevel=c.setLogLevel,a.getLogLevel=c.getLogLevel,a.setLogger=c.setLogger,a.getLogger=c.getLogger,a}(wsc||{}),wsc=function(a){function b(a){return d(c(e(a)))}function c(a){return g(h(f(a),8*a.length))}function d(a){try{}catch(b){p=0}for(var c,d=p?"0123456789ABCDEF":"0123456789abcdef",e="",f=0;f<a.length;f++)c=a.charCodeAt(f),e+=d.charAt(c>>>4&15)+d.charAt(15&c);return e}function e(a){for(var b,c,d="",e=-1;++e<a.length;)b=a.charCodeAt(e),c=e+1<a.length?a.charCodeAt(e+1):0,b>=55296&&56319>=b&&c>=56320&&57343>=c&&(b=65536+((1023&b)<<10)+(1023&c),e++),127>=b?d+=String.fromCharCode(b):2047>=b?d+=String.fromCharCode(192|b>>>6&31,128|63&b):65535>=b?d+=String.fromCharCode(224|b>>>12&15,128|b>>>6&63,128|63&b):2097151>=b&&(d+=String.fromCharCode(240|b>>>18&7,128|b>>>12&63,128|b>>>6&63,128|63&b));return d}function f(a){for(var b=Array(a.length>>2),c=0;c<b.length;c++)b[c]=0;for(var c=0;c<8*a.length;c+=8)b[c>>5]|=(255&a.charCodeAt(c/8))<<c%32;return b}function g(a){for(var b="",c=0;c<32*a.length;c+=8)b+=String.fromCharCode(a[c>>5]>>>c%32&255);return b}function h(a,b){a[b>>5]|=128<<b%32,a[(b+64>>>9<<4)+14]=b;for(var c=1732584193,d=-271733879,e=-1732584194,f=271733878,g=0;g<a.length;g+=16){var h=c,i=d,o=e,p=f;c=j(c,d,e,f,a[g+0],7,-680876936),f=j(f,c,d,e,a[g+1],12,-389564586),e=j(e,f,c,d,a[g+2],17,606105819),d=j(d,e,f,c,a[g+3],22,-1044525330),c=j(c,d,e,f,a[g+4],7,-176418897),f=j(f,c,d,e,a[g+5],12,1200080426),e=j(e,f,c,d,a[g+6],17,-1473231341),d=j(d,e,f,c,a[g+7],22,-45705983),c=j(c,d,e,f,a[g+8],7,1770035416),f=j(f,c,d,e,a[g+9],12,-1958414417),e=j(e,f,c,d,a[g+10],17,-42063),d=j(d,e,f,c,a[g+11],22,-1990404162),c=j(c,d,e,f,a[g+12],7,1804603682),f=j(f,c,d,e,a[g+13],12,-40341101),e=j(e,f,c,d,a[g+14],17,-1502002290),d=j(d,e,f,c,a[g+15],22,1236535329),c=k(c,d,e,f,a[g+1],5,-165796510),f=k(f,c,d,e,a[g+6],9,-1069501632),e=k(e,f,c,d,a[g+11],14,643717713),d=k(d,e,f,c,a[g+0],20,-373897302),c=k(c,d,e,f,a[g+5],5,-701558691),f=k(f,c,d,e,a[g+10],9,38016083),e=k(e,f,c,d,a[g+15],14,-660478335),d=k(d,e,f,c,a[g+4],20,-405537848),c=k(c,d,e,f,a[g+9],5,568446438),f=k(f,c,d,e,a[g+14],9,-1019803690),e=k(e,f,c,d,a[g+3],14,-187363961),d=k(d,e,f,c,a[g+8],20,1163531501),c=k(c,d,e,f,a[g+13],5,-1444681467),f=k(f,c,d,e,a[g+2],9,-51403784),e=k(e,f,c,d,a[g+7],14,1735328473),d=k(d,e,f,c,a[g+12],20,-1926607734),c=l(c,d,e,f,a[g+5],4,-378558),f=l(f,c,d,e,a[g+8],11,-2022574463),e=l(e,f,c,d,a[g+11],16,1839030562),d=l(d,e,f,c,a[g+14],23,-35309556),c=l(c,d,e,f,a[g+1],4,-1530992060),f=l(f,c,d,e,a[g+4],11,1272893353),e=l(e,f,c,d,a[g+7],16,-155497632),d=l(d,e,f,c,a[g+10],23,-1094730640),c=l(c,d,e,f,a[g+13],4,681279174),f=l(f,c,d,e,a[g+0],11,-358537222),e=l(e,f,c,d,a[g+3],16,-722521979),d=l(d,e,f,c,a[g+6],23,76029189),c=l(c,d,e,f,a[g+9],4,-640364487),f=l(f,c,d,e,a[g+12],11,-421815835),e=l(e,f,c,d,a[g+15],16,530742520),d=l(d,e,f,c,a[g+2],23,-995338651),c=m(c,d,e,f,a[g+0],6,-198630844),f=m(f,c,d,e,a[g+7],10,1126891415),e=m(e,f,c,d,a[g+14],15,-1416354905),d=m(d,e,f,c,a[g+5],21,-57434055),c=m(c,d,e,f,a[g+12],6,1700485571),f=m(f,c,d,e,a[g+3],10,-1894986606),e=m(e,f,c,d,a[g+10],15,-1051523),d=m(d,e,f,c,a[g+1],21,-2054922799),c=m(c,d,e,f,a[g+8],6,1873313359),f=m(f,c,d,e,a[g+15],10,-30611744),e=m(e,f,c,d,a[g+6],15,-1560198380),d=m(d,e,f,c,a[g+13],21,1309151649),c=m(c,d,e,f,a[g+4],6,-145523070),f=m(f,c,d,e,a[g+11],10,-1120210379),e=m(e,f,c,d,a[g+2],15,718787259),d=m(d,e,f,c,a[g+9],21,-343485551),c=n(c,h),d=n(d,i),e=n(e,o),f=n(f,p)}return Array(c,d,e,f)}function i(a,b,c,d,e,f){return n(o(n(n(b,a),n(d,f)),e),c)}function j(a,b,c,d,e,f,g){return i(b&c|~b&d,a,b,e,f,g)}function k(a,b,c,d,e,f,g){return i(b&d|c&~d,a,b,e,f,g)}function l(a,b,c,d,e,f,g){return i(b^c^d,a,b,e,f,g)}function m(a,b,c,d,e,f,g){return i(c^(b|~d),a,b,e,f,g)}function n(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c}function o(a,b){return a<<b|a>>>32-b}var p=0,q=a._private=a._private||{};q.DigestUtils=q.DigestUtils||{},q.DigestUtils.getHA1=function(a,c,d){var e=a+":"+c+":"+d;return b(e)},q.DigestUtils.getDigest8=function(a,c,d,e,f,g,h,i){var j="";"auth-int"===f?(j=j+g+":",j=j+h+":",j+=b(i)):(j=j+g+":",j+=h);var k=b(j);return q.DigestUtils.getDigest6(a,c,d,e,f,k)},q.DigestUtils.getDigest7=function(a,c,d,e,f,g,h){var i="";i=i+g+":",i+=h;var j=b(i);return q.DigestUtils.getDigest6(a,c,d,e,f,j)},q.DigestUtils.getDigest6=function(a,c,d,e,f,g){var h="";return"auth"===f||"auth-int"===f?(h=h+a+":",h=h+c+":",h=h+d+":",h=h+e+":",h=h+f+":",h+=g):(h=h+a+":",h=h+c+":",h+=g),b(h)};var r=function(a){var b=a.charCodeAt(0);return 9===b||10===b||11===b||12===b||13===b||32===b||5760===b||8192===b||8193===b||8194===b||8195===b||8196===b||8197===b||8198===b||8200===b||8201===b||8202===b||8232===b||8233===b||8287===b||12288===b?!0:!1},s=function(a,b){for(var c=b.length()-1;r(b.charAt(c));)c--;var d=b.indexOf("=");if(-1!==d){var e=b.slice(0,d).trim(),f='"'===b.charAt(d+1)?d+2:d+1,g='"'===b.charAt(c)?c-1:c,h=b.slice(f,g+1).trim();a[e]=h}};return q.DigestUtils.parseDigestChallenge=function(a){var b,c,d;for(a.startsWith("Digest ")&&(a=a.slice("Digest ".length)),c={},b=a.split(","),d=0;d<b.length;d++)s(c,b[d]);return c},q.DigestUtils.createDigestResponseWithHA1=function(a,b,c,d,e,f,g,h,i){var j=c.realm,k=c.nonce,l=c.algorithm;(null==l||0===l.trim().length)&&(l="MD5");var m=c.opaque;null==i&&(i="");var n=q.DigestUtils.getDigest8(b,k,g,h,f,d,e,i),o="";return o=o+'Digest username="'+a+'",realm="'+j+'",',null!=f&&(o=o+'cnonce="'+h+'",nc='+g+",qop="+f+","),null!=m&&(o=o+'opaque="'+m+'",'),o=o+'uri="'+e+'",nonce="'+k+'",response="'+n+'",algorithm='+l,o.toString()},a}(wsc||{}),wsc=function(a){function b(a){this.sourceInfo=a;var b,c,d,e,f={},g=6,h=10,i=[],j=0,k=this;for(c=g;c--;)i[c]=[];this.test=function(){f.sourceId=this.sourceInfo.deviceId,f.label=this.sourceInfo.label;var a;return a=new Promise(function(a,c){k.resolve=a,k.reject=c;var h={audio:{optional:[{echoCancellation:!1},{sourceId:k.sourceInfo.deviceId}]}};window.navigator.getUserMedia(h,function(c){var h=2,i=0;return b=c,c.getAudioTracks().length<1?(p.warn("There is not audio track in the stream."),f.available=!1,void a(f)):(d=r.createMediaStreamSource(c),e=r.createScriptProcessor(i,g,h),d&&e?(d.connect(e),e.connect(r.destination),e.onaudioprocess=l,void 0):(p.warn("AudioStreamSource or ScriptProcessor is invalid."),f.available=!1,void a(f)))},c)})};var l=function(a){var g,h,l,n=a.inputBuffer.length,o=a.inputBuffer.numberOfChannels,p=a.inputBuffer.sampleRate,q=2;for(g=0;o>g;g++)h=a.inputBuffer.getChannelData(g),l=new Float32Array(n),l.set(h),i[g].push(l);if(j+=n,j/p>=q){var s=b.getAudioTracks();for(c=s.length;c--;)s[c].stop();d.disconnect(e),e.disconnect(r.destination),m(i),k.resolve(f)}},m=function(a){var b=[];if(a.forEach(function(a,c){n(a)&&b.push(c)}),b.length>0?(f.available=!0,p.debug(b.length+" active audio input channels are found")):(f.available=!1,p.warn("Can not detect any active input channels. Please check if microphone is valid.")),f.channelNumber=b.length,2===b.length){for(var c=a[b[0]],d=a[b[1]],e=1/65536,g=0,h=c.length;h>g;g++){var i=c[g],j=d[g];if(i.length!==j.length)return f.isStereo=!0,void p.info("Microphone might be stero.");for(var k=0;k<i.length;k++)if(Math.abs(i[k]-j[k])>e)return f.isStereo=!0,void p.info("Microphone might be stero.")}f.isStereo=!1,p.info("Microphone might be mono.")}},n=function(a){for(var b=1/32767,c=0,d=a.length;d>c;c++){var e=a[c];if(e.length>0)for(var f=0,g=0;g<e.length;g++)if(Math.abs(e[g])>b){if(f+=1,f>h)return!0}else f=0}return!1}}function c(a){this.sourceInfo=a;var b={};this.test=function(){var a=[],d=this;return b.sourceId=this.sourceInfo.deviceId,b.label=this.sourceInfo.label,t(v,function(e){var f={audio:!1,video:{mandatory:{minWidth:e.width,minHeight:e.height,maxWidth:e.width,maxHeight:e.height},optional:[{sourceId:d.sourceInfo.deviceId}]}};return c(f).then(function(c){return c&&(c.getVideoTracks()[0].stop(),a.push(e.width+"x"+e.height)),b.availableResolutions=a,a.length>0&&(b.available=!0),b})})["catch"](function(a){p.debug(a)})};var c=function(a){return new Promise(function(b,c){window.navigator.getUserMedia(a,b,function(a){p.warn("getUserMedia error when check resolution of camera",a),b()})})}}function d(a,b,c,d){this.turnURI=a,this.username=b,this.password=c,this.protocol=d;var e=function(){};this.test=function(){if(!this.turnURI||!this.username||!this.password)return Promise.reject("TURN URI, username and password are required");if("string"!=typeof this.turnURI||"string"!=typeof this.username||"string"!=typeof this.password)return Promise.reject("TURN URI, username and password must be string type");var a={username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")};f(a,d);var b={iceServers:[a]};return new Promise(function(a,c){var d;try{d=new RTCPeerConnection(b,null)}catch(f){return p.error("Fail to create peer connection: "+f),void c(f)}d.onicecandidate=function(b){if("closed"===d.signalingState)return void a(!1);if(!b.candidate)return d.close(),p.warn("No relay candidate is got before end of candidates"),void a(!1);var c=u(b.candidate.candidate);return"relay"===c.type?(p.info("Got a relay candidate",b.candidate),d.close(),void a(!0)):void 0};var g={offerToReceiveAudio:1};d.createOffer(function(a){d.setLocalDescription(a,e,e)},e,g)})};var f=function(a,b){for(var c="transport="+b,d=[],e=0;e<a.urls.length;e++){var f=a.urls[e];-1!==f.indexOf(c)?d.push(f):-1===f.indexOf("?transport=")&&"turn"===f.slice(0,4)&&d.push(f+"?"+c)}a.urls=d}}function e(a,b,c){this.turnURI=a,this.username=b,this.password=c,this.test=function(){var a={username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")},b={iceServers:[a]};return new Promise(function(a,c){var d,e=function(b){p.warn("No relay candidate is got before end of candidates"),b.end(),a(0)},f=new l(b,e),g=3,h=null,i=0,j=0,k=!1,m="",n=100,o=null,q=null;m="12345";for(var r=5,s=0;r>s;s++)m+=m+m;d=m.length*n,q=f.pc1.createDataChannel(null),q.onopen=function(){h||(h=new Date);var a=function(){for(var b=0;b!==n&&!(q.bufferedAmount>=d);++b)i+=m.length,q.send(m);new Date-h>=1e3*g?k=!0:setTimeout(a,1)};a()},f.pc2.ondatachannel=function(b){o=b.channel,o.onmessage=function(b){if(j+=b.data.length,k&&i===j){f.end();var c=j/(new Date-h);c=Math.round(1e3*c*8)/1e3,f.end(),a(c)}}},f.start()})}}function f(a,b,c){this.turnURI=a,this.username=b,this.password=c,this.testResult={}}function g(a){this.sourceInfo=a;var b,c,d,e,f={},g=6,h=10,i=[],j=0;for(c=g;c--;)i[c]=[];this.test=function(a){f.sourceId=this.sourceInfo.deviceId,f.label=this.sourceInfo.label;var c={audio:{optional:[{echoCancellation:!1},{sourceId:this.sourceInfo.deviceId}]}};window.navigator.getUserMedia(c,function(c){var h=2,i=0;return b=c,c.getAudioTracks().length<1?(p.warn("There is not audio track in the stream."),f.available=!1,void a(f)):(d=r.createMediaStreamSource(c),e=r.createScriptProcessor(i,g,h),d&&e?(d.connect(e),e.connect(r.destination),e.onaudioprocess=k.bind(null,a),void 0):(p.warn("AudioStreamSource or ScriptProcessor is invalid."),f.available=!1,void a(f)))},function(){f.available=!1,a(f)})};var k=function(a,g){var h,k,m,n=g.inputBuffer.length,o=g.inputBuffer.numberOfChannels,p=g.inputBuffer.sampleRate,q=2;for(h=0;o>h;h++)k=g.inputBuffer.getChannelData(h),m=new Float32Array(n),m.set(k),i[h].push(m);if(j+=n,j/p>=q){var s=b.getAudioTracks();for(c=s.length;c--;)s[c].stop();d.disconnect(e),e.disconnect(r.destination),l(i),a(f)}},l=function(a){var b=[];if(a.forEach(function(a,c){m(a)&&b.push(c)}),b.length>0?(f.available=!0,p.debug(b.length+" active audio input channels are found")):(f.available=!1,p.warn("Can not detect any active input channels. Please check if microphone is valid.")),f.channelNumber=b.length,2===b.length){for(var c=a[b[0]],d=a[b[1]],e=1/65536,g=0,h=c.length;h>g;g++){var i=c[g],j=d[g];if(i.length!==j.length)return f.isStereo=!0,void p.info("Microphone might be stero.");for(var k=0;k<i.length;k++)if(Math.abs(i[k]-j[k])>e)return f.isStereo=!0,void p.info("Microphone might be stero.")}f.isStereo=!1,p.info("Microphone might be mono.")}},m=function(a){for(var b=1/32767,c=0,d=a.length;d>c;c++){var e=a[c];if(e.length>0)for(var f=0,g=0;g<e.length;g++)if(Math.abs(e[g])>b){if(f+=1,f>h)return!0}else f=0}return!1}}function h(a){this.sourceInfo=a;var b={};this.test=function(a){b.sourceId=this.sourceInfo.deviceId,b.label=this.sourceInfo.label,b.availableResolutions=[];var c=function(c,d,e){e&&(e.getVideoTracks()[0].stop(),b.availableResolutions.push(c.video.mandatory.minWidth+"x"+c.video.mandatory.minHeight)),d?d():(b.available=b.availableResolutions.length>0,a(b))},d=function(c,d){p.warn("getUserMedia error when check resolution of camera",d),c?c():(b.available=b.availableResolutions.length>0,a(b))},e=v.map(function(a){return{audio:!1,video:{mandatory:{minWidth:a.width,minHeight:a.height,maxWidth:a.width,maxHeight:a.height},optional:[{sourceId:b.sourceId}]}}}),f=e.reverse().shift(),g=e.reduce(function(a,b){return window.navigator.getUserMedia.bind(null,b,c.bind(null,b,a),d.bind(null,a))},window.navigator.getUserMedia.bind(null,f,c.bind(null,f,null),d.bind(null,null)));g()}}function i(a,b,c,d){this.turnURI=a,this.username=b,this.password=c,this.protocol=d;var e=function(){};this.test=function(a){var b={username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")};f(b,d);var c,g={iceServers:[b]};try{c=new RTCPeerConnection(g,null)}catch(h){return p.error("Fail to create peer connection: "+h),void a(!1)}c.onicecandidate=function(b){if("closed"===c.signalingState)return void a(!1);if(!b.candidate)return c.close(),p.warn("No relay candidate is got before end of candidates"),void a(!1);var d=u(b.candidate.candidate);return"relay"===d.type?(p.info("Got a relay candidate",b.candidate),c.close(),void a(!0)):void 0};var i={offerToReceiveAudio:1};c.createOffer(function(a){c.setLocalDescription(a,e,e)},e,i)};var f=function(a,b){for(var c="transport="+b,d=[],e=0;e<a.urls.length;e++){var f=a.urls[e];-1!==f.indexOf(c)?d.push(f):-1===f.indexOf("?transport=")&&"turn"===f.slice(0,4)&&d.push(f+"?"+c)}a.urls=d}}function j(a,b,c){this.turnURI=a,this.username=b,this.password=c,this.test=function(a){var b,c={username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")},d={iceServers:[c]},e=function(b){p.warn("No relay candidate is got before end of candidates"),b.end(),a(0)},f=new l(d,e),g=3,h=null,i=0,j=0,k=!1,m="",n=100,o=null,q=null;m="12345";for(var r=5,s=0;r>s;s++)m+=m+m;b=m.length*n,q=f.pc1.createDataChannel(null),q.onopen=function(){h||(h=new Date);var a=function(){for(var c=0;c!==n&&!(q.bufferedAmount>=b);++c)i+=m.length,q.send(m);new Date-h>=1e3*g?k=!0:setTimeout(a,1)};a()},f.pc2.ondatachannel=function(b){o=b.channel,o.onmessage=function(b){if(j+=b.data.length,k&&i===j){var c=j/(new Date-h);c=Math.round(1e3*c*8)/1e3,f.end(),a(c)}}},f.start()}}function k(a,b,c){this.turnURI=a,this.username=b,this.password=c,this.testResult={}}function l(a,b){this.pc1=new RTCPeerConnection(a),this.pc2=new RTCPeerConnection(a);var c,d=this.pc1,e=this.pc2,f=!1,g=!1,h=this,i=function(a,c){a.candidate?"relay"===u(a.candidate.candidate).type&&(c.addIceCandidate(a.candidate),g=!0):g||b(h)};d.onicecandidate=function(a){i(a,e)},e.onicecandidate=function(a){i(a,d)};var j=function(a){p.debug("offer answer",a)};this.start=function(){d.createOffer(function(a){if(f){var b=a.sdp;b=b.replace(/(m=video 1 [^\r]+) 116 117\r\n/g,function(a,b){return b.trim()+"\r\n"}),b=b.split(/a=rtpmap:116 red\/90000\r\n/g).join(""),b=b.split(/a=rtpmap:117 ulpfec\/90000\r\n/g).join(""),a.sdp=b}d.setLocalDescription(a,function(){e.setRemoteDescription(a,function(){e.createAnswer(function(a){f&&(a.sdp=a.sdp.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+c+"\r\n")),e.setLocalDescription(a,function(){d.setRemoteDescription(a)},j)},j)},j)},j)},j)},this.end=function(){"closed"!=this.pc1.signalingState&&this.pc1.close(),"closed"!=this.pc2.signalingState&&this.pc2.close()},this.setMaxVideoBitRate=function(a){c=a},this.disableVideoFec=function(){f=!0}}var m=a._private=a._private||{},n=m.wscUtils=m.wscUtils||{},o=m.wscConst,p=a.getLogger();try{var q=window.AudioContext||window.webkitAudioContext,r=new q}catch(s){p.debug("Failed to instantiate an audio context, error: "+s)}window.msCrypto&&(window.crypto=window.msCrypto);var t=function(a,b){return a.reduce(function(a,c){return a.then(function(){return b(c)})},Promise.resolve())},u=function(a){var b=a.split(/\s+/);return b.length>7?{type:b[7],protocol:b[2],address:b[4]}:{}};const v=[{label:"720p",width:1280,height:720,ratio:"16:9"},{label:"SVGA",width:800,height:600,ratio:"4:3"},{label:"VGA",width:640,height:480,ratio:"4:3"},{label:"360p",width:640,height:360,ratio:"16:9"}];if(n.Message=function(a){"use strict";if(this.control={type:void 0,package_type:void 0,session_id:void 0,subsession_id:void 0,sequence:void 0,message_state:void 0,correlation_id:void 0,ack_sequence:void 0,version:void 0},this.header={action:void 0,initiator:void 0,target:void 0,error_code:void 0},this.payload={},a){"string"==typeof a&&(a=JSON.parse(a));for(var b in a)this[b]=a[b]}},n.Message.systemHeaders={action:"action",initiator:"initiator",target:"target",cslr:"cslr",cslw:"cslw",csuw:"csuw",sslr:"sslr",error_code:"error_code",response_code:"response_code",reason:"reason",enquiry_data:"enquiry_data",authorization:"authorization",authenticate:"authenticate",expiry:"expiry",participants:"participants"},n.Message.prototype={isRequest:function(){var a=this.control.type;return a===o.TYPE.REQUEST?!0:!1},isResponse:function(){var a=this.control.type;return a===o.TYPE.RESPONSE?!0:!1},isEnquiry:function(){var a=this.header.action;return a===o.ACTION.ENQUIRY?!0:!1},isFinalResponse:function(){var a=this.control.type,b=this.control.message_state;return a===o.TYPE.RESPONSE&&b===o.MESSAGESTATE.FINAL?!0:!1},isError:function(){var a=this.control.type;return a===o.TYPE.ERROR?!0:!1},isMessage:function(){var a=this.control.type;return a===o.TYPE.MESSAGE?!0:!1},isACK:function(){var a=this.control.type;return a===o.TYPE.ACK?!0:!1},isReconnect:function(){var a=this.control.package_type,b=this.control.session_id,c=this.header.action;return a===o.PACKAGE.REGISTER&&b&&c===o.ACTION.CONNECT?!0:!1},ack:function(a){var b=new n.Message;b.control.session_id=this.control.session_id,b.control.subsession_id=this.control.subsession_id,b.control.type=o.TYPE.ACK,b.control.package_type=this.control.package_type,b.control.sequence=this.control.sequence,a.sendMessage(b)},complete:function(a){var b=new n.Message;b.control.session_id=this.control.session_id,b.control.subsession_id=this.control.subsession_id,b.control.correlation_id=this.control.correlation_id,b.control.type=o.TYPE.MESSAGE,b.control.package_type=this.control.package_type,b.header.action=o.ACTION.COMPLETE,a.sendMessage(b)},addExtHeaders:function(a){for(var b in a){var c=a[b];this.header[b]||(this.header[b]=c)}},getExtHeaders:function(){var a;if(this.header)for(var b in this.header)n.Message.systemHeaders[b]||(a||(a={}),a[b]=this.header[b]);return a},addExtPayloads:function(a){for(var b in a){var c=a[b];this.payload[b]||(this.payload[b]=c)}}},n.ErrorInfo=function(a,b){this.code=a,this.reason=b},n.wscLoginWithOAuthToken=function(a,b,c,d,e){var f=d+"?oauth_token="+a+"&final_redirect_uri="+b+"&wsc_app_uri="+e;if(p.debug("Login WebRTC Session Controller by OAuth token to destination -> "+f),!c){var g="The parameter loginWindowType is required.";throw p.error(g),g}"current_window"===c?window.location.href=f:"new_window"===c&&window.open(f,"Wsc Login","width=500,height=500,left=200,top=100")},n.AuthHandler=function(a){"use strict";this.session=a,a.authHandler=this,this.refresh=null,this.toJSON=function(){var a={session:""};return n.toJSON(a,this)}},n.checkAuthInfo=function(a,b){var c=!1;if(a===o.AUTHTYPE.SERVICE){if(!b)return!1;c=!0}else if(a===o.AUTHTYPE.TURN){if(!b)return!0;null!=b.iceServers&&(c=!0)}return c},n.calcHa1=function(a,b){var c="";return b.algorithm&&"md5"!==b.algorithm.toLowerCase()||(c=m.DigestUtils.getHA1(a.username,b.realm,a.password)),c},n.extend=function(a,b){var c=function(){};c.prototype=b.prototype;var d=a.prototype;a.prototype=new c,d&&n.deepCopy(d,a.prototype),a.prototype.constructor=a,a.superclass=b.prototype,a.superclass&&(a.superclass.constructor=b)},n.deepCopy=function(a,b){b=b||{};for(var c in a)"object"==typeof a[c]?(b[c]=a[c].constructor===Array?[]:{},n.deepCopy(a[c],b[c])):b[c]=a[c];return b},n.toJSON=function(a,b){var c={};for(var d in b)d in a||(c[d]=b[d]);return c},n.testBrowser=function(){var a,b,c,d,e=!1,f=!1,g=!1,h=!1,e=!1;m.browser;return m.browser.isChrome&&(a="Chrome",f=!0,b=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10),c=void 0,d=void 0),m.browser.isFirefox&&(a="Firefox",f=!0,b=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),c=void 0,d=void 0),navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)&&(a="Edge",f=!0,b=parseInt(navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)[2],10),c=void 0,d=void 0),m.browser.isIE&&(a="IE",f=!1,b=parseInt(navigator.userAgent.match(/rv\:([0-9]+)\./)[1],10),c=void 0,d=void 0),m.browser.isSafari&&(a="Safari",f=!1,b=parseInt(navigator.userAgent.match(/Safari\/([0-9]+)\./)[1],10),c=void 0,d=void 0),h=m.browser.supportSessionStorage,g="WebSocket"in window,e=f&&g&&h,{compatible:e,details:{browserName:a,browserVersion:b,supportedMinimumVersion:c,supportedMaximumVersion:d,supportWebRTC:f,supportWebSocket:g,supportSessionStorage:h}}},n.testMicrophone=function(){var a=!1;if("undefined"==typeof r)return Promise.reject("Audio context is not supported.");var c=function(c){var d=[],e=[];return c.forEach(function(a){"audioinput"===a.kind&&d.push(a)}),0==d.length?Promise.resolve({available:!1,details:e}):t(d,function(c){return new b(c).test().then(function(b){return e.push(b),a=a||b.available,{available:a,details:e}})})["catch"](function(a){return p.debug(a),Promise.resolve({available:!1,details:[]})})};return navigator.mediaDevices.enumerateDevices().then(c)["catch"](function(a){return p.debug("Device selection is not supported",a),Promise.resolve({available:!1,details:[]})})},n.testCamera=function(){var a=!1,b=function(b){var d=[],e=[];return b.forEach(function(a){"videoinput"===a.kind&&d.push(a)}),0==d.length?Promise.resolve({available:!1,details:e}):t(d,function(b){return new c(b).test().then(function(b){return e.push(b),a=a||b.available,{available:a,details:e}})})["catch"](function(a){return p.debug(a),Promise.resolve({available:!1,details:[]})})};return navigator.mediaDevices.enumerateDevices().then(b)["catch"](function(a){return p.debug("Device selection is not supported",a),Promise.resolve({available:!1,details:[]})})},n.testNetwork=function(a,b,c){var g={};return g.details={},new d(a,b,c,"udp").test().then(function(e){return p.debug("udp connectivity test..."),g.details.udpConnectivity=e,new d(a,b,c,"tcp").test()}).then(function(d){return p.debug("tcp connectivity test..."),g.details.tcpConnectivity=d,new e(a,b,c).test()}).then(function(d){return p.debug("data channel connectivity test..."),g.details.dataThroughput=d,new f(a,b,c).test()}).then(function(a){return p.debug("video bandwidth connectivity test..."),g.details.videoBandwidth=a,g.connectivity=(g.details.udpConnectivity||g.details.tcpConnectivity)&&g.details.dataThroughput>0&&g.details.videoBandwidth>0,g})["catch"](function(a){return p.error("Error happens when test network. ",a),Promise.reject(a)})},f.prototype={test:function(){var a={username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")},b={iceServers:[a]};return new Promise(function(a,c){function d(b){return m.browser.isChrome?(b.getTracks().forEach(function(a){h.pc1.addTrack(a,b)}),h.start(),e=new Date,void setTimeout(function(){h.pc1.getStats(function(b){var c;for(var d in b.result()){var e=b.result()[d];if("bweforvideo"===e.id){c=parseInt(e.stat("googAvailableSendBandwidth"))/1e3;break}}var f=new MediaStream;h.pc1.getSenders().forEach(function(a){f.addTrack(a.track)}),f.getVideoTracks()[0].stop(),h.end(),a(c)})},1e3*g)):void a(-1)}var e,f=2e3,g=5,h=new l(b);h.setMaxVideoBitRate(f),h.disableVideoFec();var i={audio:!1,video:{optional:[{minWidth:1280},{minHeight:720}]}};window.navigator.getUserMedia(i,d,function(b){p.warn("getUserMedia error when testing video bandwidth",b),a(-1)})})}},n.testMicrophoneCallback=function(a,b){("undefined"==typeof r||"undefined"==typeof r.createScriptProcessor)&&b&&b("Audio context is not supported.");var c=function(b){var c,d={available:!1,details:[]};c=b.filter(function(a){return"audioinput"===a.kind}),0==c.length&&a(d);var e=function(b,c,d){this.available=this.available||d.available,this.details.push(d),b&&c?b.test(c):a(this)},f=c.map(function(a){return new g(a)}),h=f.shift(),i=f.reverse().reduce(function(a,b){return e.bind(d,b,a)},e.bind(d,null,null));h.test(i)};"undefined"!=typeof navigator.mediaDevices&&"undefined"!=typeof navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(c)["catch"](function(b){p.debug("Device selection is not supported",b),a&&a({available:!1,details:[]})}):"undefined"!=typeof MediaStreamTrack&&"undefined"!=typeof MediaStreamTrack.getSources?MediaStreamTrack.getSources(function(a){c(a.map(function(a){return{label:a.label,kind:kinds[a.kind],deviceId:a.id,groupId:""}}))}):b("Devices cannot be enumerated.")},n.testCameraCallback=function(a,b){var c=function(b){var c,d={available:!1,details:[]};c=b.filter(function(a){return"videoinput"===a.kind}),0==c.length&&a(d);var e=function(b,c,d){this.available=this.available||d.available,this.details.push(d),b&&c?b.test(c):a(this)},f=c.map(function(a){return new h(a)}),g=f.shift(),i=f.reverse().reduce(function(a,b){return e.bind(d,b,a)},e.bind(d,null,null));g.test(i)};"undefined"!=typeof navigator.mediaDevices&&"undefined"!=typeof navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(c)["catch"](function(b){p.debug("Device selection is not supported",b),a&&a({available:!1,details:[]})}):"undefined"!=typeof MediaStreamTrack&&"undefined"!=typeof MediaStreamTrack.getSources?MediaStreamTrack.getSources(function(a){c(a.map(function(a){return{label:a.label,kind:kinds[a.kind],deviceId:a.id,groupId:""}}))}):b("Devices cannot be enumerated.")},n.testNetworkCallback=function(a,b,c,d,e){a&&b&&c||e("TURN URI, username and password are required"),("string"!=typeof a||"string"!=typeof b||"string"!=typeof c)&&e("TURN URI, username and password must be string type");var f={};f.connectivity=!1,f.details={},new i(a,b,c,"udp").test(function(e){p.debug("udp connectivity test...Done"),f.details.udpConnectivity=e,new i(a,b,c,"tcp").test(function(e){p.debug("tcp connectivity test...Done"),f.details.tcpConnectivity=e,new j(a,b,c).test(function(e){p.debug("data channel connectivity test...Done"),f.details.dataThroughput=e,new k(a,b,c).test(function(a){p.debug("video bandwidth connectivity test...Done"),f.details.videoBandwidth=a,f.connectivity=(f.details.udpConnectivity||f.details.tcpConnectivity)&&f.details.dataThroughput>0&&f.details.videoBandwidth>0,d(f)})})})})},k.prototype={test:function(a){function b(b){return m.browser.isChrome?(b.getTracks().forEach(function(a){h.pc1.addTrack(a,b)}),h.start(),c=new Date,void setTimeout(function(){h.pc1.getStats(function(b){var c;for(var d in b.result()){var e=b.result()[d];if("bweforvideo"===e.id){c=parseInt(e.stat("googAvailableSendBandwidth"))/1e3;break}}var f=new MediaStream;h.pc1.getSenders().forEach(function(a){f.addTrack(a.track)}),f.getVideoTracks()[0].stop(),h.end(),a(c)})},1e3*g)):void a(-1)}var c,d={username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")},e={iceServers:[d]},f=2e3,g=5,h=new l(e);h.setMaxVideoBitRate(f),h.disableVideoFec();var i={audio:!1,video:{optional:[{minWidth:1280},{minHeight:720}]}};window.navigator.getUserMedia(i,b,function(b){p.warn("getUserMedia error when testing video bandwidth",b),a(-1)})}},m.browser.isIE){var w=JSON.stringify;JSON.stringify=function(){var a=Array.prototype.slice.call(arguments);return(1===a.length||a.length>1&&(null===a[1]||void 0===a[1]))&&(a[1]=function(a,b){return b&&b.call&&b.apply?void 0:b}),w.apply(this,a)}}return a.extend=n.extend,a.wscLoginWithOAuthToken=n.wscLoginWithOAuthToken,a.Message=n.Message,a.ErrorInfo=n.ErrorInfo,a.AuthHandler=n.AuthHandler,a.testBrowser=n.testBrowser,a.testMicrophone=n.testMicrophone,a.testCamera=n.testCamera,a.testNetwork=n.testNetwork,a.testMicrophoneCallback=n.testMicrophoneCallback,a.testCameraCallback=n.testCameraCallback,a.testNetworkCallback=n.testNetworkCallback,a}(wsc||{}),wsc=function(a){var b=a._private=a._private||{},c={},d=b.wscConst,e=(b.browser,a.getLogger());return c.collectHostIPsByPc=function(a,b){function c(a){if(a.candidate);else if(i&&i.localDescription){var c=i.localDescription.sdp,d=g(c);f(d)}else b()}function d(a){e.error("Create offer error while collect Host IP, "+a);var b=[];f(b)}function f(c){try{void 0!=i&&(i.close(),i=null),c.length>0?a&&a(c):b()}catch(d){e.error(d)}}function g(a){for(var b=[],c=a.split("\r\n"),d=0;d<c.length;d++){var e=c[d],f=null;if(e.match(/^c=/i)){var g=e.split(/\s+/);f=g[2]}else if(e.match(/^a=candidate:.*typ host/i)){var h=e.split(/\s+/);f=h[4]}f&&-1===b.indexOf(f)&&b.push(f)}return b}if(!RTCPeerConnection.prototype.createDataChannel)return e.error("Edge browser doesn't support data channel so we can't get host ips"),void b();var h=null,i=new window.RTCPeerConnection(h);try{i.onicecandidate=c,i.createDataChannel("");var j=function(a){i&&i.setLocalDescription(a)},k=function(a){d(a)};i.createOffer(j,k)}catch(l){e.error("Got exception when trying to get host IPs: "+l);var m=[];f(m)}},c.addCandidatesFromSdp=function(a,b){var d,e=c.getMediaFromSDP(b),f=[],g={},h=e.length,i=0,j=0;for(i=0;h>i;i++)for(f=e[i].candidates,d=f.length,j=0;d>j;j++)g=new RTCIceCandidate({sdpMLineIndex:i,candidate:f[j]}),a.addIceCandidate(g)},c.createPeerConnection=function(f,g){"use strict";var h,i,j=null,k=!0,l=b.wscUtils;try{var m=f.session.authHandler,n=0;if(m&&m.refresh)for(;k&&3>n;){n++;try{if(j=m.refresh(d.AUTHTYPE.TURN),l.checkAuthInfo(d.AUTHTYPE.TURN,j))break;if(j===!1){i="No correct information was returned from the callback function 'AuthHandler.refresh()', or the user canceled the operation.",k=!1;break}i="No correct information was return from the callback function 'AuthHandler.refresh()'. Please try again.",e.warn(i)}catch(o){e.error("Handle unauthenticated message error: "+o),k=!1}}else e.warn("No AuthHandler object created for this Session, or this AuthHandler does not have the callback function 'AuthHandler.refresh()'."),k=!1;if(k===!1&&(j=null),j||(j={iceServers:[]}),f.session.iceServerListFromServer){var p=f.session.iceServerListFromServer.concat(j.iceServers);j.iceServers=p}var q={};q.optional=[{googIPv6:f.pkgInstance.ipv6},{googDscp:f.pkgInstance.dscp}],e.debug("Constraints used for peerConnection: "+JSON.stringify(q)),h=new window.RTCPeerConnection(j,q);var r=function(a){e.info("Session connecting.")},s=function(a){e.info("Session opened.")},t=function(a){e.info("Remote stream removed."),f.fireMediaStreamEvent(d.MEDIASTREAMEVENT.REMOTE_STREAM_REMOVED,a.stream)},u=function(a){e.info("Remote stream added."),a.streams.forEach(function(a){f.fireMediaStreamEvent(d.MEDIASTREAMEVENT.REMOTE_STREAM_ADDED,a)}),h.___wsc_onaddstream_called=!0};h.onremovestream=t,h.ontrack=u,h.onconnecting=r,h.onopen=s,f.peerConnection=h,g?c.addLocalStreams(f,g):c.addLocalStream(f),h.onstatechange=function(a){e.debug("iceConnectionState : "+a.currentTarget.iceConnectionState+"\niceGatheringState : "+a.currentTarget.iceGatheringState+"\n");
}}catch(o){c.invokeCallError(f,a.ERRORCODE.PEERCONNECTION_ERROR,o),e.error("Create peer connection: "+o)}},c.createNewPeerConnection=function(a){if(a.peerConnection){var b=c.getLocalStreams(a.peerConnection);if(a.temporarySavedStreams=b,b)for(var d=0;d<b.length;d++){var e=b[d];c.removeLocalStream(a,e)}a.peerConnection.close(),a.peerConnection=null}c.createPeerConnection(a)},c.clearPeerConnection=function(a){var d=a.peerConnection;if(d){var f=c.getLocalStreams(d),g=c.getRemoteStreams(d);if(f)for(var h=0;h<f.length;h++){var i=f[h];c.removeLocalStream(a,i)}if(g)for(var h=0;h<g.length;h++)b.browser.isFirefox||g[h].getTracks().forEach(function(a){var b=d.getSenders().find?d.getSenders().find(function(b){return b.track===a}):null;b&&(d.removeTrack(b),e.debug("removeTrack is done successfully!"))}),g[h];d.close(),a.peerConnection=null}},c.setLocalDescription=function(b,d,f,g){var h=null;if(b&&b.peerConnection&&d){f||(f=function(){e.debug("Set localDescription succeed!")}),h=g?function(d){g(d),c.invokeCallError(b,a.ERRORCODE.PEERCONNECTION_ERROR,d)}:function(d){e.warn("Set local description failed: ",d),c.invokeCallError(b,a.ERRORCODE.PEERCONNECTION_ERROR,d)},e.debug("Set local description now.");var i=b.peerConnection.localDescription;e.debug("iceConnectionState/iceGatheringState is: "+b.peerConnection.iceConnectionState+"/"+b.peerConnection.iceGatheringState),b.peerConnection.setLocalDescription(d,f,h),b.peerConnection.__wscLastLocalSdp=i}},c.setRemoteDescription=function(b,d,f,g){b&&b.peerConnection&&d&&(f||(f=function(){e.debug("Set remote description succeed!")}),g||(g=function(d){e.warn("Set remote description failed!",d),c.invokeCallError(b,a.ERRORCODE.PEERCONNECTION_ERROR,d)}),b.peerConnection.setRemoteDescription(d,f,g))},c.removeLocalStream=function(a,c){c&&(c.peerConnectionNum&&c.peerConnectionNum--,e.debug("removeLocalStream, peerConnectionNum: "+c.peerConnectionNum),b.browser.isFirefox||c.getTracks().forEach(function(b){var c=a.peerConnection.getSenders().find?a.peerConnection.getSenders().find(function(a){return a.track===b}):null;c&&(a.peerConnection.removeTrack(c),e.debug("removeTrack is done successfully!!"))}),a.fireMediaStreamEvent(d.MEDIASTREAMEVENT.LOCAL_STREAM_REMOVED,c))},c.addLocalStream=function(a,b){var f=a.peerConnection;if(b){b.peerConnectionNum?b.peerConnectionNum++:b.peerConnectionNum=1,b.getTracks().forEach(function(a){f.addTrack(a,b)}),e.debug("addLocalStream, peerConnectionNum: "+b.peerConnectionNum);for(var g=!0,h=a.localMediaStreams,i=0;i<h.length;i++){var j=h[i];if(j===b){g=!1;break}}g&&a.localMediaStreams.push(b),f.__wscIsAudioStreamAdded||(f.__wscIsAudioStreamAdded=c.streamHasMediaTracks([b],"audio")),f.__wscIsVideoStreamAdded||(f.__wscIsVideoStreamAdded=c.streamHasMediaTracks([b],"video")),a.fireMediaStreamEvent(d.MEDIASTREAMEVENT.LOCAL_STREAM_ADDED,b)}else{for(var i=0;i<a.temporarySavedStreams.length;i++){var k=a.temporarySavedStreams[i];k.peerConnectionNum?k.peerConnectionNum++:k.peerConnectionNum=1,k.getTracks().forEach(function(a){f.addTrack(a,k)}),a.fireMediaStreamEvent(d.MEDIASTREAMEVENT.LOCAL_STREAM_ADDED,k),e.debug("addLocalStream, peerConnectionNum: "+k.peerConnectionNum)}f.__wscIsAudioStreamAdded||(f.__wscIsAudioStreamAdded=c.streamHasMediaTracks(a.localMediaStreams,"audio")),f.__wscIsVideoStreamAdded||(f.__wscIsVideoStreamAdded=c.streamHasMediaTracks(a.localMediaStreams,"video"))}e.debug("call local media streams length : "+a.localMediaStreams.length)},c.addLocalStreams=function(a,b){if(b)for(var d=0;d<b.length;d++){var e=b[d];c.addLocalStream(a,e)}},c.calculateMediaChange=function(a,b){var c=!1,d=[],e=[];if(a.forEach(function(a){"inactive"!=a.mode&&0!=a.port&&d.push(a)}),b.forEach(function(a){"inactive"!=a.mode&&0!=a.port&&e.push(a)}),d.length<e.length)c=!0;else if(d.length>e.length)c=!0;else for(var f=0;f<e.length;f++){for(var g=e[f],h=!1,i=0;i<d.length;i++)if(g.equals(d[i])){h=!0;break}if(!h){c=!0;break}}return c},c.isMediaChanged=function(a,b){var d=c.calculateMediaChange(a,b);return d},c.getMediaFromSDP=function(a){var b,c,d,e,f,g,h,i,j,k=a.split("\r\n"),l=0,m="sendrecv",n=[],o=k.length;for(b=0;o>b;b++)switch(c=k[b].split("="),c[0]){case"a":d=c[1],"sendonly"===d||"sendrecv"===d||"recvonly"===d||"inactive"===d?0===l?m=c[1]:n[l-1].mode=c[1]:0===d.indexOf("candidate:")?n[l-1].candidates.push(k[b]):0===d.indexOf("mid:")&&(n[l-1].mid=k[b]);break;case"m":e=c[1],f=e.split(" "),g=f[0],h=f[1],i=new Media(g,m,h),n[l++]=i;break;case"o":d=c[1],j=d.split(" ")[1],n.sessionId=j}return n},Media=function(a,b,c){this.type=a,this.mode=b,this.port=c,this.candidates=[],this.mid="",this.toJSON=function(){var a={type:this.type,mode:this.mode,port:this.port};return a},this.equals=function(a){return 0===this.port&&(this.mode="inactive"),0===a.port&&(a.mode="inactive"),this.type===a.type&&this.mode===a.mode?!0:!1}},c.getCallConfigFromRemoteSDP=function(b,e){var f=d.MEDIADIRECTION.NONE,g=d.MEDIADIRECTION.NONE,h=null,i=function(a,b){switch(a.toUpperCase()){case"SENDONLY":return b?d.MEDIADIRECTION.SENDONLY:d.MEDIADIRECTION.RECVONLY;case"RECVONLY":return b?d.MEDIADIRECTION.RECVONLY:d.MEDIADIRECTION.SENDONLY;case"SENDRECV":return d.MEDIADIRECTION.SENDRECV;case"INACTIVE":return d.MEDIADIRECTION.NONE}};if(b){for(var j=c.getMediaFromSDP(b),k=null,l=/a=rtpmap:(\d*).* opus.*/,m=0,n=0;n<j.length;n++)"audio"===j[n].type.toLowerCase()?g=i(j[n].mode,e):"video"===j[n].type.toLowerCase()?f=i(j[n].mode,e):"application"===j[n].type.toLowerCase()&&(k=[]);var o=b.match(l);if(null!==o&&o.length>1&&""!==o[1]){var p=RegExp("a=fmtp:"+o[1]+".*maxaveragebitrate=(\\d*)"),q=b.match(p);null!==q&&q.length>1&&""!==q[1]&&(m=parseInt(q[1]))}h=new a.CallConfig(g,f,k,m)}return h},c.streamHasMediaTracks=function(a,b){var c=!1;if(null==a||"audio"!==b&&"video"!==b)return c;for(var d=0;d<a.length;d++)if("audio"===b){var e=a[d].getAudioTracks();if(null!=e&&e.length>0){c=!0;break}}else{var f=a[d].getVideoTracks();if(null!=f&&f.length>0){c=!0;break}}return c},c.changeAudioBitrate=function(a,b){function c(a){var b="",c=a.substring(g.length);if(c.length>0){var d=c.split(" ");d.length>0&&(b=d[0].trim())}return b}function d(a){for(var b=[],d=0;d<a.length;d++)if(-1!==a[d].indexOf("opus")&&-1!==a[d].indexOf(g)){var e=c(a[d]);e.length>0&&b.push(e)}return b}function f(a,b){var c=/maxaveragebitrate=\d{1,8}/;return a=-1!==a.indexOf("maxaveragebitrate")?m+" "+a.replace(c,"maxaveragebitrate="+b):m+" maxaveragebitrate="+b+"; "+a}var g="a=rtpmap:",h="a=fmtp:";try{if(b.callConfig.hasMaxBitrate()){for(var i=a.split("\r\n"),j=b.callConfig.maxAudioBitrate,k=d(i),l=0;l<k.length;l++)for(var m=h+k[l],n=0;n<i.length;n++)if(-1!==i[n].indexOf(m)){var o=i[n].substring(m.length).trim();i[n]=f(o,j)}a=i.join("\r\n")}}catch(p){e.error("Failed to set the maxaveragebitrate value: "+p)}return a},c.changeSdpByCallConfig=function(a,b){function e(a){var b=g;switch(a){case d.MEDIADIRECTION.RECVONLY:b=p[1];break;case d.MEDIADIRECTION.SENDONLY:b=p[2];break;case d.MEDIADIRECTION.SENDRECV:b=p[0];break;case d.MEDIADIRECTION.NONE:b=p[3]}return b}function f(c,d,e){if(!(-1>=c)){var f="";m=a.indexOf(j,c+d.length),m>-1?(mPart=a.substring(c,m),f=a.substring(m)):mPart=a.substring(c);for(var g=0;g<p.length;g++){var h=mPart.indexOf(p[g]);h>=0&&(mPart=mPart.replace(p[g],e))}var i=b.pkgInstance.trickleIceMode;("full"==i||"half"==i)&&(mPart.indexOf("ice-options:google-ice")>0?mPart=mPart.replace(/ice-options:google-ice/g,"ice-options:trickle"):mPart.indexOf("ice-options:trickle")<0&&(mPart+="a=ice-options:trickle\r\n")),a=a.substring(0,c)+mPart+f}}var g="a=inactive",h="m=video",i="m=audio",j="m=",k=-1,l=-1,m=-1,n=b.callConfig.audioConfig,o=b.callConfig.videoConfig,p=[];return p[0]="a=sendrecv",p[1]="a=recvonly",p[2]="a=sendonly",p[3]=g,l=a.indexOf(i),l>-1&&f(l,i,e(n)),k=a.indexOf(h),k>-1&&f(k,h,e(o)),a=c.changeAudioBitrate(a,b)},c.getLocalStreams=function(a){if(a.getSenders){var c=new MediaStream;return a.getSenders().forEach(function(a){c.addTrack(a.track)}),[c]}return b.browser.isFirefox?a.localStreams:void 0},c.getRemoteStreams=function(a){if(a.getReceivers){var c=new MediaStream;return a.getReceivers().forEach(function(a){c.addTrack(a.track)}),[c]}return b.browser.isFirefox?a.remoteStreams:void 0},c.invokeCallError=function(b,c,d){if(b.onCallError){var f=new a.ErrorInfo(c,d);try{b.onCallError(f)}catch(g){e.error("The callback function 'Call.onCallError()' exception:"+g)}}},b.rtcHelper=c,a}(wsc||{}),wsc=function(a){function b(a){var b,c,d=a,e=this;this.start=function(){if(d.sessionState===f.SESSIONSTATE.CONNECTED){b&&window.clearTimeout(b);var a=d.lastUnACKedInboundMsg;if(a){var i=a.control.sequence;i&&i!==c&&(typeof a!==g.Message&&(a=new g.Message(a)),a.ack(d),h.debug("PeriodlyACKChecker ack the message in sequence "+i),c=i)}b=window.setTimeout(function(){e.start()},d.ackInterval)}else e.stop()},this.stop=function(){b&&(h.debug("Stop PeriodlyACKChecker"),window.clearTimeout(b))}}function c(a){var b,c,d=a,g=3e3;this.stop=function(){b&&(h.debug("Stop IceServerEnquiry Timer"),window.clearTimeout(b),b=void 0)},this.scheduleIceEnquiry=function(a){b&&window.clearTimeout(b),b=window.setTimeout(function(){h.debug("Enquiring...."),e.sendIceEnquiry(d)},a)},this.doIceEnquiry=function(a){var b=this,f=b.handleIceEnquiry;b.handleIceEnquiry=function(d,e){b.handleIceEnquiry=f,f(d,e),clearTimeout(c),a()},h.debug("Enquiring...."),e.sendIceEnquiry(d),c=setTimeout(function(){h.warn("Timeout of IceServerEnquirer is triggered..."),b.handleIceEnquiry=f,a()},g)},this.handleIceEnquiry=function(a,b){var c=b.control.type;if(c===f.TYPE.RESPONSE){h.debug("Receive Response for ICE-Enquiry "),a.iceServerListFromServer=[];var d=b.payload.iceServers,e=-1;if(d)for(var g=0;g<d.length;g++){var i="",j="",k=-1;if(d[g].username&&(i=d[g].username),d[g].credential&&(j=d[g].credential),d[g].lifetime&&(k=1e3*d[g].lifetime),d[g].urls)for(var l=0;l<d[g].urls.length;l++){var m={urls:d[g].urls[l],username:i,credential:j};h.debug("Retrieve an ICE Server from response: "+JSON.stringify(m)),a.iceServerListFromServer.push(m),k>0&&(e>k||0>=e)&&(e=k)}}0>=e?h.warn("The minimum lifetime retrieved from response is "+e+" ms, so stop ICE Enquiry"):(h.debug("Schedule an ICE Enquiry in "+e+" ms"),a.iceServerEnquirer.scheduleIceEnquiry(e),a.iceServerEnquiryLifetime=e)}else c===f.TYPE.ERROR&&(h.warn("Receive an error for ICE-Enquiry Request"),h.debug("Schedule an ICE Enquiry in "+a.iceServerEnquiryLifetime+" ms"),a.iceServerEnquirer.scheduleIceEnquiry(a.iceServerEnquiryLifetime));if(h.debug("About to test flags "+a.callUpdateOnIceResponse),a.callUpdateOnIceResponse){var n=a.getAllSubSessions();if(n&&n.length>0)for(var g=0;g<n.length;g++){var o=n[g],p=o.peerConnection,q=o.getStreams();if(p)h.debug("Updating the call due to Relay Failure"),a.allowRetry=!0,o.update(o.callConfig);else if(q)for(h.debug("Updating conversation due to Relay Failure"),g=0;g<q.length;g++){var r=q[g];r.update(r.getStreamOptions())}}a.callUpdateOnIceResponse=!1}}}var d=a._private=a._private||{},e={},f=d.wscConst,g=d.wscUtils,h=a.getLogger(),i=function(d,i,k,n,o,p,q,r){"use strict";if(p&&(this.extHeaders=p),o){var s=e.rehydrateSession(d,i,k,n,o,p,q,r);if(null==s){var t="Failed to reload session data.",u=new g.ErrorInfo(f.ERRORCODE.RESTORE_FAILED,t);h.warn(t);try{n&&n(u)}catch(v){h.error("onError callback exception: "+v)}}return s}this.webSocketUri=i,this.hostIPs=[],this.wscWebsocket=null,this.sessionId=null,this.userName=d,this.sessionState=f.SESSIONSTATE.NONE;try{e.collectIPsAndInitWebSocket(this)}catch(v){if(h.error("Websocket initialization exception: "+v),n){var u=new g.ErrorInfo(f.ERRORCODE.WEBSOCKET_ERROR,v);try{n(u)}catch(w){h.error("The callback function 'Session.failureCallback()' returned the exception: "+w)}}}this.subSessionsMap=new a.Map,this.unACKedMsgQueue=new j,this.successCallback=k,this.failureCallback=n,this.lastOutboundSeq=0,this.lastInboundSeq=0,this.lastUnHandledInboundReq=null,this.lastUnACKedInboundMsg=null,this.onSessionStateChange=null,this.packagesMap=new a.Map,this.busyPingInterval=3e3,this.idlePingInterval=1e4,this.pingInterval=this.idlePingInterval,this.reConnectInterval=2e3,this.ackInterval=6e4,this.reConnectTime=6e4,this.retryCount=2,this.retryTimes=0,this.timeToLive=0,this.hibernateSuccessCallback=null,this.hibernateFailureCallback=null,this.onHibernationRequest=null,this.iceServerListFromServer=null,q&&(this.extPayloads=q,this.timeToLive=3600,this.clientCapability=new l),this.sessionTimeOut=null,this.reConnectTimeOut=null,this.pingTimeOut=null,this.periodlyACKChecker=new b(this),this.iceServerEnquirer=new c(this),this.iceServerEnquiryLifetime,this.connectSubSessionId,this.lastActiveTime=null,this.callUpdateOnIceResponse=!1,this.allowRetry=!1,new m(this),this.toJSON=function(){var a={sessionId:this.sessionId,userName:this.userName,unACKedMsgQueue:this.unACKedMsgQueue,lastOutboundSeq:this.lastOutboundSeq,lastInboundSeq:this.lastInboundSeq,lastUnHandledInboundReq:this.lastUnHandledInboundReq,subSessionsMap:this.subSessionsMap,packagesMap:this.packagesMap};return a}};i.prototype={getAllSubSessions:function(){for(var a=new Array,b=this.subSessionsMap.values(),c=0,d=0;d<b.length;d++)for(var e=b[d],f=e.values(),g=0;g<f.length;g++)a[c]=f[g],c++;return a},getSubSessionsByPackageType:function(a){return this.subSessionsMap.get(a)},putSubSession:function(b,c,d){var f=this.subSessionsMap.get(b);f||(f=new a.Map,this.subSessionsMap.put(b,f)),f.put(c,d),e.updateActivityMarker(this),this.pingInterval=this.busyPingInterval,e.schedulePing(this,!1),h.debug("use busyPingInterval "+this.pingInterval)},getSubSession:function(a){"use strict";for(var b=null,c=this.subSessionsMap.values(),d=0;d<c.length&&(b=c[d].get(a),null==b);d++);return b},removeSubSession:function(a){"use strict";for(var b=this.subSessionsMap.values(),c=0;c<b.length;c++)b[c].remove(a);var d=this.getAllSubSessions();d&&0===d.length&&(e.updateActivityMarker(this),this.pingInterval=this.idlePingInterval,h.debug("use idlePingInterval "+this.pingInterval))},saveToStorage:function(){if(this.sessionState!==f.SESSIONSTATE.CLOSED&&this.sessionState!==f.SESSIONSTATE.FAILED&&this.sessionState!==f.SESSIONSTATE.RELOADING)if(d.browser.supportSessionStorage){if(this.sessionId)try{sessionStorage.setItem(this.sessionId,JSON.stringify(this))}catch(b){e.invokeSessionError(this,a.ERRORCODE.SAVE_FAILED,b)}}else h.warn("Sorry, web storage is not supported...");else h.debug("Do not save session data with session state: "+this.sessionState)},setSessionState:function(a){"use strict";this.sessionState=a,null!=this.sessionId&&this.saveToStorage(),this.onSessionStateChange&&this.onSessionStateChange(a)},close:function(){e.clearSession(this),this.wscWebsocket&&(this.wscWebsocket.close(1e3,"Normal close"),this.wscWebsocket=null,h.info("Websocket normally closed")),this.setSessionState(f.SESSIONSTATE.CLOSED)},getPackage:function(a){var b=this.packagesMap.get(a);return b},registerPackage:function(b){var c=b.packageType;if(!c)throw"There is no packageType defined in the package.";try{if(pkgInstance=this.packagesMap.get(c),pkgInstance)throw"Duplicated package type in Session.";this.packagesMap.put(c,b);var d=new a.Map;this.subSessionsMap.put(c,d)}catch(e){h.error("Package registration failed:"+e)}},getUserName:function(){return this.userName},getSessionId:function(){return this.sessionId},getLastOutboundSeq:function(){return this.lastOutboundSeq},setIdlePingInterval:function(a){1e3>a?this.idlePingInterval=1e3:this.idlePingInterval=a},setBusyPingInterval:function(a){1e3>a?this.busyPingInterval=1e3:this.busyPingInterval=a},setReconnectInterval:function(a){this.reConnectInterval=a},setReconnectTime:function(a){this.reConnectTime=a},sendMessage:function(a){"use strict";var b,c=a.control.package_type,d=this.sessionId,e=a.control.type;if(d&&(a.control.session_id=d),a.control.version=f.PROTOCOL_VERSION,a.isReconnect()||e!==f.TYPE.ACK&&(a.control.sequence=this.lastOutboundSeq+1),b=JSON.stringify(a),this.sessionState===f.SESSIONSTATE.CLOSED||this.sessionState===f.SESSIONSTATE.FAILED)throw h.debug("Cannot send message; session state: "+this.sessionState),"Cannot send message; session state: "+this.sessionState;if(this.sessionState===f.SESSIONSTATE.CONNECTED||c===f.PACKAGE.REGISTER)try{this.wscWebsocket.send(b),h.debug("Send message: "+JSON.stringify(a,null,4))}catch(g){h.error("Received an exception when sending message: "+g)}a.isACK()||a.isReconnect()||this.lastOutboundSeq++,this.unACKedMsgQueue.addMessage(a),(a.isFinalResponse()||a.isError()||"complete"===a.header.action)&&(this.lastUnHandledInboundReq&&this.lastUnHandledInboundReq.control.sequence<=a.control.ack_sequence&&(this.lastUnHandledInboundReq=null),this.lastUnACKedInboundMsg&&this.lastUnACKedInboundMsg.control.sequence===a.control.ack_sequence&&(this.lastUnACKedInboundMsg=null)),this.saveToStorage()},reSendMessage:function(a){var b=JSON.stringify(a);try{this.wscWebsocket.send(b),h.debug("Re-send message: "+JSON.stringify(a,null,4))}catch(c){h.error("Received an exception when re-sending message: "+c)}this.unACKedMsgQueue.addMessage(a),this.saveToStorage()},genNewCorrelationId:function(){var a=f.CONSTCS.CLIENT+(this.getLastOutboundSeq()+1);return a},generateSubSessionId:function(){var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=window.crypto.getRandomValues(new Uint8Array(1))[0]%16|0,c="x"===a?b:3&b|8;return c.toString(16)});return a},hibernate:function(b,c,d){var f=this.getAllSubSessions();b&&b>0&&(this.timeToLive=b),this.hibernateSuccessCallback=c,this.hibernateFailureCallback=d,e.updateActivityMarker(this),f&&f.length>0?e.invokeHibernateError(this,a.ERRORCODE.BUSY_EVERYWHERE,"session on busy"):e.sendHibernate(this,b)},setTimeToLive:function(a){a&&a>0&&(this.timeToLive=a)},suspend:function(){return this.wscWebsocket&&(this.wscWebsocket.close(3001,"Abnormal close"),this.wscWebsocket=null,h.info("Websocket abnormal closed")),this.setSessionState(f.SESSIONSTATE.SUSPENDED),d.browser.supportSessionStorage?sessionStorage.getItem(this.sessionId):(h.warn("The browser does not support SessionStorage, there is no stateInfo stored."),null)}},e.handleWsOpen=function(a){e.sendRegister(a,null)},e.collectIPsAndInitWebSocket=function(a){function b(b){h.debug("New IPs: "+b.toString()+", Old IPs: "+a.hostIPs.toString()),0!==a.hostIPs.length&&(f(a.hostIPs,b)?g():a.clientIpNotChangedAfterReconnect=!0),a.hostIPs=b,e.initWebSocket(a)}function c(){h.error("Failed to get host IPs."),g(),e.initWebSocket(a)}function f(a,b){var c=!1;if(b.length!=a.length)c=!0;else for(var d=0;d<b.length;d++){var e=b[d];if(-1===a.indexOf(e)){c=!0;break}}return c}function g(){var b=a.getAllSubSessions();if(b&&b.length>0)for(var c=0;c<b.length;c++){var e=b[c],f=e.peerConnection;if(f){h.debug("Cleanup call between caller ["+e.getCaller()+"] and callee ["+e.getCallee()+"]");var g=i.getLocalStreams(f),j=i.getRemoteStreams(f);if(e.temporarySavedStreams=g,g)for(var c=0;c<g.length;c++)i.removeLocalStream(e,g[c]);if(j)for(var c=0;c<j.length;c++)d.browser.isFirefox||j[c].getTracks().forEach(function(a){var b=f.getSenders().find?f.getSenders().find(function(b){return b.track===a}):null;b&&(f.removeTrack(b),h.debug("removeTrack is done successfully!!!"))});"closed"!==f.iceConnectionState&&(f.close(),e.peerConnection=null)}}}var i=d.rtcHelper;return RTCPeerConnection.prototype.createDataChannel?void i.collectHostIPsByPc(b,c):(h.error("Edge browser doesn't support data channel so we can't get host ips"),void e.initWebSocket(a))},e.handleWsClose=function(b){e.clearWebSocket(b.wscWebsocket),b.wscWebsocket=null,b.sessionState===f.SESSIONSTATE.CONNECTED?(b.periodlyACKChecker.stop(),b.iceServerEnquirer.stop(),b.setSessionState(f.SESSIONSTATE.RECONNECTING),window.clearTimeout(b.pingTimeOut),b.sessionTimeOut=window.setTimeout(function(){h.warn("reconnect timeout."),e.clearSession(b),b.setSessionState(f.SESSIONSTATE.FAILED),window.clearTimeout(b.reConnectTimeOut)},b.reConnectTime),e.reInitWebSocket(b)):(b.sessionState===f.SESSIONSTATE.NONE||b.sessionState===f.SESSIONSTATE.RELOADING)&&(e.clearSession(b),e.invokeSessionError(b,a.ERRORCODE.WEBSOCKET_ERROR,"websocket onerror"))},e.reInitWebSocket=function(a){var b=a.sessionState;b!==f.SESSIONSTATE.CONNECTED&&b!==f.SESSIONSTATE.CLOSED&&(a.reConnectTimeOut&&window.clearTimeout(a.reConnectTimeOut),e.collectIPsAndInitWebSocket(a),a.reConnectTimeOut=window.setTimeout(function(){e.reInitWebSocket(a)},a.reConnectInterval))},e.schedulePing=function(a,b){a.sessionState===f.SESSIONSTATE.CONNECTED&&(a.pingTimeOut&&window.clearTimeout(a.pingTimeOut),b&&e.sendPing(a),a.pingTimeOut=window.setTimeout(function(){e.schedulePing(a,!0)},a.pingInterval))},e.sendPing=function(a){try{null!=a.wscWebsocket&&(a.wscWebsocket.send("ping"),e.isAlive(a))}catch(b){h.debug("can not send ping now: "+b)}},e.isAlive=function(a){var b=Date.now();b>a.lastActiveTime+1.2*a.pingInterval?(a.retryTimes++,h.debug("The ping-pong retryTimes/retryCount: "+a.retryTimes+"/"+a.retryCount),a.retryTimes===a.retryCount&&(a.retryTimes=0,h.warn("Client reconnecting..."),e.handleWsClose(a))):a.retryTimes=0},e.updateActivityMarker=function(a){a.lastActiveTime=Date.now()},e.clearSession=function(a,b){for(var c=1e3,e=a.packagesMap.values(),f=0;f<e.length;f++)e[f].clear&&e[f].clear();b&&(c=b),1e3==c&&d.browser.supportSessionStorage&&sessionStorage&&sessionStorage.removeItem(a.sessionId),a.periodlyACKChecker.stop(),a.iceServerEnquirer.stop(),g.setsessionid("")};var j=function(){var a=null,b=null,c=new g.Queue;this.toJSON=function(){var d={lowerSeq:a,upperSeq:b,msgQueue:c};return d},this.getLowerSeq=function(){return a},this.setLowerSeq=function(b){a=b},this.getUpperSeq=function(){return b},this.setUpperSeq=function(a){b=a},this.getMsgQueue=function(){return c},this.addMessage=function(d){if(!d.isACK()&&!d.isReconnect()){var e=d.control.sequence;null==a&&(a=e),b=e,c.enqueue(d),h.debug("addMessage - cslw: "+this.getLowerSeq()+",csuw: "+this.getUpperSeq())}},this.ackMessages=function(d){if(0!==c.length()&&d>=a&&b>=d){for(var e=c.dequeue(),f=e.control.sequence;e&&d>f;)e=c.dequeue(),f=e.control.sequence;return null==c.peek()?a=b+1:(e=c.peek(),a=e.control.sequence),h.debug("ackMessages - cslw: "+this.getLowerSeq()+",csuw: "+this.getUpperSeq()),!0}return!1},this.reSendMessage=function(d,e){for(var f=c.length(),g=0;g++<f;){var i=c.dequeue(),j=i.control.sequence;j>=e+1?(h.debug("reSend message: "+JSON.stringify(i)),d.reSendMessage(i)):h.debug("skip message: "+JSON.stringify(i))}if(null==c.peek())a=b+1;else{var i=c.peek();a=i.control.sequence}h.debug("reSendMessage - cslw: "+this.getLowerSeq()+",csuw: "+this.getUpperSeq())}};e.handleWsData=function(a,b){"use strict";if(e.updateActivityMarker(b),"pong"===a);else{e.schedulePing(b,!1);var c=null;c="string"==typeof a?JSON.parse(a):a,h.debug("Received data from server: "+JSON.stringify(c,null,4));var d=new g.Message(c),i=null,j=null,k=null,l=null,m=null;if(d&&(i=d.control.sequence,j=d.control.ack_sequence,k=d.control.type,l=d.header.action,m=d.control.package_type),i&&(b.lastInboundSeq=i),j?b.unACKedMsgQueue.ackMessages(j):k===f.TYPE.RESPONSE&&null!=i&&b.unACKedMsgQueue.ackMessages(i),m||(m=f.PACKAGE.REGISTER),k===f.TYPE.REQUEST&&(b.lastUnHandledInboundReq=d),b.lastUnACKedInboundMsg=d,l===f.ACTION.SHUTDOWN&&null!=b.lastUnHandledInboundReq){var n=b.lastUnHandledInboundReq.control.subsession_id,o=d.control.subsession_id;n===o&&(b.lastUnHandledInboundReq=null)}var p=b.getPackage(m);p?p.onMessage(d):h.warn("package_type '"+m+"' is not defined!"),b.saveToStorage()}},e.invokeSessionError=function(b,c,d){if(b.failureCallback){var e=new a.ErrorInfo(c,d);try{b.failureCallback(e)}catch(f){h.error("The callback function 'Session.failureCallback()' returned an exception: "+f)}}},e.invokeHibernateError=function(b,c,d){if(b.hibernateFailureCallback){var e=new a.ErrorInfo(c,d);try{b.hibernateFailureCallback(e)}catch(f){h.error("The callback function 'Session.hibernateFailureCallback()' returned an exception: "+f)}}},e.initWebSocket=function(a){"use strict";if(null==a.wscWebsocket){if(h.debug("creating the websocket..."),a.wscWebsocket=new WebSocket(a.webSocketUri,"webrtc.oracle.com"),null==a.wscWebsocket)throw new Error("sessionHelper.initWebSocket(): new WebSocket() returns null.");a.wscWebsocket.onopen=function(b){h.debug("websocket event handler onopen is invoked."),e.handleWsOpen(a)},a.wscWebsocket.onclose=function(b){h.debug("websocket event handler onclose is invoked."),e.handleWsClose(a)},a.wscWebsocket.onmessage=function(b){b.data&&e.handleWsData(b.data,a)},a.wscWebsocket.onerror=function(a){h.info("websocket onerror")}}},e.clearWebSocket=function(a){null!=a&&(a.onopen=null,a.onclose=null,a.onmessage=null,a.onerror=null)},e.sendRegister=function(a,b){"use strict";var c=new g.Message;if(c.control.type=f.TYPE.REQUEST,c.control.package_type=f.PACKAGE.REGISTER,a.userName&&(c.header.initiator=a.userName,c.header.target=a.userName),c.header.action=f.ACTION.CONNECT,b&&(c.header.authorization=b),a.extHeaders&&c.addExtHeaders(a.extHeaders),a.extPayloads&&c.addExtPayloads(a.extPayloads),a.clientCapability){var d={family:a.clientCapability.family,version:a.clientCapability.version};if(c.payload.capability)for(var e in d){var h=d[e];c.payload.capability[e]||(c.payload.capability[e]=h)}else c.payload.capability=d}a.sessionId?b?a.sendMessage(c):(c.header.cslr=a.lastInboundSeq,c.header.cslw=a.unACKedMsgQueue.getLowerSeq(),c.header.csuw=a.unACKedMsgQueue.getUpperSeq(),a.sendMessage(c)):a.sendMessage(c)},e.sendHibernate=function(a,b){"use strict";var c=new g.Message;c.control.type=f.TYPE.REQUEST,c.control.package_type=f.PACKAGE.REGISTER,c.control.subsession_id=a.generateSubSessionId(),c.control.correlation_id=a.genNewCorrelationId(),c.header.action=f.ACTION.HIBERNATE;var d;d=b&&b>0?{ttl:b}:{ttl:3600},c.addExtHeaders(d),a.sendMessage(c)},e.respondHibernate=function(a,b){"use strict";var c,d=new g.Message;if(a.timeToLive&&a.timeToLive>0){d.control.type=f.TYPE.RESPONSE,d.header.response_code=200,d.control.message_state=f.MESSAGESTATE.FINAL;var e={ttl:a.timeToLive};d.addExtHeaders(e),c=d.header.response_code}else d.control.type=f.TYPE.ERROR,d.header.error_code=f.ERRORCODE.FORBIDDEN,d.header.reason="Not supported",c=d.header.error_code;d.control.package_type=f.PACKAGE.REGISTER,d.control.subsession_id=b.control.subsession_id,d.control.correlation_id=b.control.correlationId,d.control.ack_sequence=a.lastInboundSeq,d.header.action=f.ACTION.HIBERNATE,a.sendMessage(d)},e.sendIceEnquiry=function(a){"use strict";var b=new g.Message;b.control.type=f.TYPE.REQUEST,b.control.package_type=f.PACKAGE.REGISTER,b.control.subsession_id=a.connectSubSessionId,b.control.correlation_id=a.genNewCorrelationId(),b.header.action=f.ACTION.ICE_ENQUIRY,a.sendMessage(b)},e.rehydrateSession=function(a,b,c,g,j,k,m,n){if(n){if(j&&j!==n.sessionId)return h.error("SessionId is inconsistent, sessionId in stateInfo is: "+n.sessionId+", but the given sessionId is: "+j),null;d.browser.supportSessionStorage?sessionStorage.setItem(n.sessionId,JSON.stringify(n)):h.warn("Sorry, web storage is not supported...")}var o=e.getStoredSession(j);if(h.debug("Get stored session: "+JSON.stringify(o)),o){var p=new i(a,b,c,g);p.userName=o.userName,p.sessionId=o.sessionId,p.lastOutboundSeq=o.lastOutboundSeq,p.lastInboundSeq=o.lastInboundSeq,p.lastUnHandledInboundReq=o.lastUnHandledInboundReq,p.extHeaders=k,m&&(p.extPayloads=m,p.timeToLive=3600,p.clientCapability=new l),p.unACKedMsgQueue.setUpperSeq(o.unACKedMsgQueue.upperSeq),p.unACKedMsgQueue.setLowerSeq(o.unACKedMsgQueue.lowerSeq);for(var q=o.unACKedMsgQueue.msgQueue.array,r=0;r<q.length;r++)p.unACKedMsgQueue.getMsgQueue().enqueue(q[r]);return p.rehydrationData={subSessionsMap:o.subSessionsMap,packagesMap:o.packagesMap},p.setSessionState(f.SESSIONSTATE.RELOADING),p}return null},e.getStoredSession=function(a){if(d.browser.supportSessionStorage){var b=sessionStorage.getItem(a);if(b)return JSON.parse(b)}return null},e.removeStoredSession=function(a){d.browser.supportSessionStorage&&sessionStorage.removeItem(a)},e.handleAuthenticateChallenge=function(a,b,c,d){var e=a.authHandler,i=null,j=!0,k=0;if(e&&e.refresh)for(;j&&3>k;)try{k++;var l=b.header.authenticate,m=e.refresh(f.AUTHTYPE.SERVICE,null);if(g.checkAuthInfo(f.AUTHTYPE.SERVICE,m)){l.ha1=g.calcHa1(m,l),l.username=m.username,c(l),j=!1;break}if(null==m||""===m){i="No correct information was returned from the callback function 'AuthHandler.refresh()', or the user canceled the operation.",h.warn(i);break}i="No correct information was returned from the callback function 'AuthHandler.refresh()'. Please try again.",h.warn(i)}catch(n){i="Handle unauthenticated message error:"+n,h.error(i),j=!0}else i="No AuthHandler object was created for this Session or this AuthHandler did not implement the callback function 'AuthHandler.refresh()'!",h.warn(i);j&&d(i)},e.handleConnection=function(a,b){var c=b.control.type,d=b.getExtHeaders();if(c===f.TYPE.RESPONSE){a.sessionId&&a.sessionId!==b.control.session_id&&(e.clearSession(a),a.lastOutboundSeq=1,a.lastUnHandledInboundReq=null,a.lastUnACKedInboundMsg=null,a.sessionState=f.SESSIONSTATE.NONE),a.sessionId=b.control.session_id,a.connectSubSessionId=b.control.subsession_id;var i=function(){var c=a.sessionState;switch(a.setSessionState(f.SESSIONSTATE.CONNECTED),c){case f.SESSIONSTATE.NONE:if(a.userName=b.header.initiator,g.setsessionid(a.sessionId),a.successCallback)try{a.successCallback(d)}catch(i){h.warn("The callback function 'session.successCallback()' exception:"+i)}break;case f.SESSIONSTATE.RECONNECTING:h.info("Session re-connected."),a.sessionTimeOut&&window.clearTimeout(a.sessionTimeOut),a.reConnectTimeOut&&window.clearTimeout(a.reConnectTimeOut);var j=b.header.sslr;a.unACKedMsgQueue.reSendMessage(a,j);var k=a.packagesMap.entry,l=a.subSessionsMap.entry;for(var m in k){var n=a.getPackage(m),o=l[m];if(n&&n.onResurrect)for(var p in o.entry)n.onResurrect(o.get(p))}break;case f.SESSIONSTATE.RELOADING:h.info("Session re-loaded.");var j=b.header.sslr,q=a.rehydrationData;if(q){var k=q.packagesMap.entry,l=q.subSessionsMap.entry;for(var m in k){var n=a.getPackage(m),o=l[m];n&&n.onRehydration&&n.onRehydration(o)}}if(a.successCallback)try{a.successCallback(d)}catch(i){h.warn("The callback function 'session.successCallback()' exception:"+i)}var r=a.lastUnHandledInboundReq;r&&(a.lastOutboundSeq--,e.handleWsData(r,a))}e.updateActivityMarker(a),e.schedulePing(a,!1),a.periodlyACKChecker.start()};a.iceServerEnquirer.doIceEnquiry(i)}else if(c===f.TYPE.ERROR){var j=b.header.error_code,k=b.header.reason,l=new g.ErrorInfo(j,k),m=function(b){b&&(k=k+"("+b+")"),h.warn("Session connect failed:"+k),e.invokeSessionError(a,j,k),a.close()};if(j===f.ERRORCODE.UNAUTHORIZED||j===f.ERRORCODE.PROXYAUTH_REQUIRED){h.debug("Authentication failed: "+l.code);var n=function(b){e.sendRegister(a,b)};e.handleAuthenticateChallenge(a,b,n,m)}else m()}},e.handleHibernation=function(a){e.clearSession(a,3001),a.wscWebsocket&&(a.wscWebsocket.close(3001,"Session hibernated"),a.wscWebsocket=null,h.info("Websocket closed for hibernation")),a.lastUnHandledInboundReq=null,a.lastUnACKedInboundMsg=null,a.pingTimeOut&&window.clearTimeout(a.pingTimeOut),a.reConnectTimeOut&&window.clearTimeout(a.reConnectTimeOut),a.sessionTimeOut&&window.clearTimeout(a.sessionTimeOut),a.setSessionState(f.SESSIONSTATE.HIBERNATED)};var k=function(){};k.prototype={};var l=function(){"use strict";var a,b,c,d=navigator.userAgent,e=navigator.appName,f=""+parseFloat(navigator.appVersion);d&&(-1!=(b=d.indexOf("Opera"))?(e="Opera",f=d.substring(b+6),-1!=(b=d.indexOf("Version"))&&(f=d.substring(b+8))):-1!=(b=d.indexOf("MSIE"))?(e="Microsoft Internet Explorer",f=d.substring(b+5)):-1!=(b=d.indexOf("Chrome"))?(e="Chrome",f=d.substring(b+7)):-1!=(b=d.indexOf("Safari"))?(e="Safari",f=d.substring(b+7),-1!=(b=d.indexOf("Version"))&&(f=d.substring(b+8))):-1!=(b=d.indexOf("Firefox"))?(e="Firefox",f=d.substring(b+8)):(a=d.lastIndexOf(" ")+1)<(b=d.lastIndexOf("/"))&&(e=d.substring(a,b),f=d.substring(b+1),e.toLowerCase()==e.toUpperCase()&&(e=navigator.appName)),-1!=(c=f.indexOf(";"))&&(f=f.substring(0,c)),
-1!=(c=f.indexOf(" "))&&(f=f.substring(0,c))),this.family=e,this.version=f},m=function(a){"use strict";this.session=a,this.packageType=f.PACKAGE.REGISTER,a.packagesMap.put(this.packageType,this)};return m.prototype={toJSON:function(){"use strict";var a={session:""};return g.toJSON(a,this)},onMessage:function(b){"use strict";var c=b.control.type,d=b.header.action;b.getExtHeaders();if(delete a._private,d===f.ACTION.HIBERNATE)if(c===f.TYPE.REQUEST)this.session.onHibernationRequest&&this.session.onHibernationRequest(b),e.respondHibernate(this.session,b),this.session.timeToLive&&this.session.timeToLive>0&&e.handleHibernation(this.session);else{e.handleHibernation(this.session);var g,i;if(c===f.TYPE.RESPONSE?g=b.header.response_code:c===f.TYPE.ERROR&&(g=b.header.error_code),i=b.header.reason,null==g||g>=200&&300>g){if(this.session.hibernateSuccessCallback)try{this.session.hibernateSuccessCallback(g)}catch(j){h.warn("The callback function 'session.successCallback()' exception: "+j)}}else e.invokeHibernateError(this.session,g,i)}else d===f.ACTION.CONNECT?e.handleConnection(this.session,b):d===f.ACTION.ICE_ENQUIRY?this.session.iceServerEnquirer.handleIceEnquiry(this.session,b):d===f.ACTION.RELAY_FAILED?(h.warn("Received relayFailed message: "+b),this.session.callUpdateOnIceResponse=!0,e.sendIceEnquiry(this.session)):h.warn("Receive an unexpected message: "+b)}},d.sessionHelper=e,a.Session=i,a.ExtensibleSession=i,a}(wsc||{}),wsc=function(a){var b,c=a._private=a._private||{},d={},e={},f=c.wscConst,g=c.wscUtils,h=c.rtcHelper,i=a.getLogger();return a.CallState=function(a,b,c){this.state=a,this.status={code:b,reason:c}},a.CallState.prototype={isFinalState:function(){var a=!1;return(this.state===f.CALLSTATE.ENDED||this.state===f.CALLSTATE.FAILED)&&(a=!0),a},is180Ringing:function(){return this.status&&this.state===f.CALLSTATE.RESPONDED&&180===this.status.code?!0:!1},hasEstablished:function(){return this.state===f.CALLSTATE.ESTABLISHED||this.state===f.CALLSTATE.UPDATE_FAILED||this.state===f.CALLSTATE.UPDATED||this.state===f.CALLSTATE.UPDATING?!0:!1}},d.doRequest=function(a,b){function c(){i.debug("=== doStartCallRequest ==="),e.isValidSdp(a,q)?(a.caller=n,a.callee=o,a.setCallState(f.CALLSTATE.STARTED,null,"receive call"),a.subSessionId=p,a.startReqCorrId=m,a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.OFFER_GOT,q),a._template.doStartCallRequest&&a._template.doStartCallRequest(b)):e.sendReject(a,603,"Invalid Sdp")}function d(){i.debug("=== doUpdateCallRequest ==="),a.callState.state===f.CALLSTATE.UPDATING&&(i.debug("Got update message when call state is UPDATING, that is, my offer lost the glare then."),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.OFFER_REJECTED),a._template.rollbackUpdate&&(i.debug("Roll back the update initiated by me and accept the update from the other peer."),a._template.rollbackUpdate())),e.isValidSdp(a,q)?(a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.OFFER_GOT,q),a._template.doUpdateCallRequest&&a._template.doUpdateCallRequest(b)):e.sendReject(a,603,"Invalid Sdp")}function g(){i.debug("=== doUpdateCallReqInEarlyPhase ==="),d(),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.ACK_GOT)}var h=a.callState,j=h.state,k=h.status.code,l=(a.session,b.header.action),m=b.control.correlation_id,n=b.header.initiator,o=b.header.target,p=b.control.subsession_id,q=b.payload.sdp;b.getExtHeaders();switch(m&&(a.lastServerCorrelationId=m),b.payload&&b.payload.sdp&&i.debug("The SDP in the request is :\r\n"+b.payload.sdp),j){case f.CALLSTATE.NONE:switch(l){case f.ACTION.START:c();break;default:e.doUnexpectedMsg(a)}break;case f.CALLSTATE.STARTED:switch(l){case f.ACTION.START:c();break;default:e.doUnexpectedMsg(a)}break;case f.CALLSTATE.RESPONDED:switch(l){case f.ACTION.START:switch(k){case 180:c();break;case 183:g()}break;default:e.doUnexpectedMsg(a)}break;case f.CALLSTATE.ESTABLISHED:case f.CALLSTATE.UPDATED:case f.CALLSTATE.UPDATE_FAILED:case f.CALLSTATE.ERROR:case f.CALLSTATE.UPDATING:switch(l){case f.ACTION.START:d();break;default:e.doUnexpectedMsg(a)}break;default:e.doUnexpectedMsg(a)}},d.doResponse=function(a,b){function c(){v>100&&200>v?b.payload&&b.payload.sdp?b.header.reliable?d():h():b.header.reliable?g():j():v>=200&&300>v&&k()}function d(){i.debug("=== doStartReliableProvRespWithSDP ==="),a.earlyMediaState=f.OFFER_ANSWER_STATE.INITIAL,a.setCallState(f.CALLSTATE.RESPONDED,v,r(v)),a._template.doStartReliableProvRespWithSDP&&a._template.doStartReliableProvRespWithSDP(b)}function g(){i.debug("=== doStartReliableProvRespWithoutSDP ==="),a._template.doStartReliableProvRespWithoutSDP&&a._template.doStartReliableProvRespWithoutSDP(b)}function h(){i.debug("=== doStartUnReliableProvRespWithSDP ==="),a.setCallState(f.CALLSTATE.RESPONDED,v,r(v)),a.gotAnsweredInProvResp=!0,a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.ANSWER_GOT,b.payload.sdp),a._template.doStartUnReliableProvRespWithSDP&&a._template.doStartUnReliableProvRespWithSDP(b)}function j(){i.debug("=== doStartUnReliableProvRespWithoutSDP ==="),a.setCallState(f.CALLSTATE.RESPONDED,v,r(v))}function k(){if(a.earlyMediaState)switch(a.earlyMediaState){case f.OFFER_ANSWER_STATE.ACK_SENT:case f.OFFER_ANSWER_STATE.ACK_GOT:l();break;case f.OFFER_ANSWER_STATE.OFFER_SENT:m()}else n()}function l(){i.debug("=== doStart200RespInEarlyPahse ==="),a._template.doStart200RespInEarlyPhase&&a._template.doStart200RespInEarlyPhase(b)}function m(){i.debug("=== doUpdate200RespInEarlyPhase ==="),a._template.doUpdate200RespInEarlyPhase&&a._template.doUpdate200RespInEarlyPhase(b)}function n(){i.debug("=== doStart2XXResponse ==="),a.extHeaders&&delete a.extHeaders,a.gotAnsweredInProvResp?a.gotAnsweredInProvResp=null:a._template.doStart2XXResponse&&(a._template.doStart2XXResponse(b),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.ANSWER_GOT,b.payload.sdp)),a.setCallState(f.CALLSTATE.RESPONDED,v,"got success response"),p()}function o(){i.debug("=== doUpdate200Response ==="),a.extHeaders&&delete a.extHeaders,a._template.doUpdate200Response&&a._template.doUpdate200Response(b),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.ANSWER_GOT,b.payload.sdp),p()}function p(){b.complete(w),a.callState.state===f.CALLSTATE.UPDATING?a.setCallState(f.CALLSTATE.UPDATED,null,"sent complete"):a.setCallState(f.CALLSTATE.ESTABLISHED,null,"sent complete"),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.ACK_SENT),e.checkResumeState(a)}function q(){i.debug("=== doPrack200Response ==="),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.ACK_SENT)}function r(a){var b="";return 180===a&&(b="Ringing"),181===a&&(b="Call Is Being Forwarded"),182===a&&(b="Queued"),183===a&&(b="Session Progress"),b}var s=a.callState,t=s.state,u=b.header.action,v=b.header.response_code,w=a.session;switch(b.payload&&b.payload.sdp&&i.debug("The SDP in the response is :\r\n"+b.payload.sdp),t){case f.CALLSTATE.NONE:e.doUnexpectedMsg(a);break;case f.CALLSTATE.STARTED:case f.CALLSTATE.RESPONDED:switch(u){case f.ACTION.START:c();break;case f.ACTION.PRACK:q();break;default:e.doUnexpectedMsg(a)}break;case f.CALLSTATE.ESTABLISHED:case f.CALLSTATE.UPDATING:case f.CALLSTATE.UPDATED:case f.CALLSTATE.UPDATE_FAILED:case f.CALLSTATE.ERROR:switch(u){case f.ACTION.START:200===v&&o();break;default:e.doUnexpectedMsg(a)}break;default:e.doUnexpectedMsg(a)}},d.doMessage=function(a,b){function d(){i.debug("=== doCancelCallMessage ==="),a.setCallState(f.CALLSTATE.ENDED,"","cancelled"),a.end()}function g(){i.debug("=== doShutdownMessage ==="),a.setCallState(f.CALLSTATE.ENDED,"","shutdown"),a._template.doShutdownMessage&&a._template.doShutdownMessage()}function h(){i.debug("=== doUpdateShutdownMessage ===");var c=b.header.initiator;"##re-invite_cancel@server##"===c?(a.setCallState(f.CALLSTATE.UPDATE_FAILED,null,"canceled by server"),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.OFFER_REJECT)):g()}function j(){i.debug("=== doCompleteMessage ==="),a.setCallState(f.CALLSTATE.ESTABLISHED,null,"got complete"),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.ACK_GOT)}function k(){i.debug("=== doUpdateComplete ==="),a.setCallState(f.CALLSTATE.UPDATED,null,"got complete"),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.ACK_GOT)}function l(){if(i.debug("=== doTrickleIce ==="),b.payload.candidates&&a.peerConnection){var c,d,e=b.payload.candidates,f=e.split("\r\n");if(f.length>0){c=f.shift();var g=c.split(":");0===c.indexOf("a=mid")&&2==g.length?(d=g[1],m(d,f)):i.warn("invalid trickle ice candidate")}}}function m(b,d){var e={};(null==a.peerConnection.remoteSDP||"undefined"==typeof a.peerConnection.remoteSDP)&&(a.peerConnection.remoteSDP=a.peerConnection.remoteDescription.sdp);for(var f=a.peerConnection.remoteSDP;d.length>0;){var g=d.shift();if(g&&0===g.indexOf("a=mid:")){var h=g.split(":");2==h.length&&(b=h[1])}else if(g&&0===g.indexOf("a=candidate:")){var j={};if(j.candidate=g,j.sdpMid=b,c.browser.isFirefox||c.browser.isIE||c.browser.isSafari){if(void 0===e[b]){var k=f.split("a=mid:"),l=-1;k.length>1&&(k.shift(),k.every(function(a,c){return 0===a.indexOf(b+"\r\n")?(l=c,!1):!0})),e[b]=l}e[b]>-1&&(j.sdpMLineIndex=e[b])}var m=new RTCIceCandidate(j);a.peerConnection.addIceCandidate(m,n.bind(null,m),o.bind(null,m))}else g&&0===g.indexOf("a=end-of-candidates")?i.debug("Get end-of-candidates when handling trickle ice candidate"):""!==g.trim()&&i.debug("Get unknown line of trickle ice candidate: "+g)}}function n(a){i.debug("addIceCandidate succeed, "+JSON.stringify(a))}function o(a,b){i.warn("For candidate: "+JSON.stringify(a)+", addIceCandidate gets error: "+JSON.stringify(b))}var p=a.callState,q=p.state,r=b.header.action;a.session;switch(q){case f.CALLSTATE.NONE:e.doUnexpectedMsg(a);break;case f.CALLSTATE.STARTED:switch(r){case f.ACTION.SHUTDOWN:d();break;default:e.doUnexpectedMsg(a)}break;case f.CALLSTATE.RESPONDED:switch(r){case f.ACTION.SHUTDOWN:d();break;case f.ACTION.COMPLETE:j();break;default:e.doUnexpectedMsg(a)}break;case f.CALLSTATE.ESTABLISHED:case f.CALLSTATE.UPDATED:case f.CALLSTATE.UPDATE_FAILED:case f.CALLSTATE.ERROR:switch(r){case f.ACTION.SHUTDOWN:g();break;case f.ACTION.COMPLETE:j();break;case f.ACTION.TRICKLE:l();break;default:e.doUnexpectedMsg(a)}break;case f.CALLSTATE.UPDATING:switch(r){case f.ACTION.SHUTDOWN:h();break;case f.ACTION.COMPLETE:k();break;case f.ACTION.TRICKLE:l();break;default:e.doUnexpectedMsg(a)}break;default:r===f.ACTION.TRICKLE?l():e.doUnexpectedMsg(a)}},d.doError=function(a,b){function c(){if(i.debug("=== doErrorMessage ==="),b.ack(o),errorObj=new g.ErrorInfo(m,n),o.sessionState===f.SESSIONSTATE.CONNECTED)a.callState.state!==f.CALLSTATE.NONE&&(k.hasEstablished()?d():h());else try{o.failureCallback(errorObj)}catch(c){i.error("Excepton in Session failureCallback: "+c)}}function d(){if(i.debug("=== doUpdateCallError ==="),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.OFFER_REJECTED),a.callState.state===f.CALLSTATE.UPDATING&&a.setCallState(f.CALLSTATE.UPDATE_FAILED,m,n),a._template.rollbackUpdate&&a._template.rollbackUpdate(),a.session.allowRetry){i.debug("Retry update due to Relay failure");var b=Math.floor(500*Math.random());window.setTimeout(a.update(a.callConfig),b)}a.session.allowRetry=!1,e.checkResumeState(a)}function h(){i.debug("=== doStartCallError ==="),a.setCallState(f.CALLSTATE.FAILED,m,n),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.OFFER_REJECTED),a._template.doStartCallError&&a._template.doStartCallError()}function j(){i.debug("=== doAuthentication ===");var c,d=(new g.ErrorInfo(m,n),!0),e=0,h=a.session.authHandler,j=b.header.authenticate;if(h&&h.refresh)for(;d&&3>e;){e++;try{if(c=h.refresh(f.AUTHTYPE.SERVICE,null),g.checkAuthInfo(f.AUTHTYPE.SERVICE,c))j.ha1=g.calcHa1(c,j),j.username=c.username,a.authInfo=j,a._template.sendOffer(),d=!1;else{if(null==c||""===c){i.warn("No valid authentication information");break}i.warn("No valid authentication information")}}catch(k){i.error("Got exception: "+k),d=!0}}else i.warn("No AuthHuandler for this Session");d===!0&&(a.setCallState(f.CALLSTATE.FAILED,m,n),a._template.clearCall())}var k=a.callState,l=(k.state,b.header.action),m=b.header.error_code,n=b.header.reason,o=a.session;switch(l){case f.ACTION.START:switch(m){case 401:case 407:j();break;case 491:i.debug("Got 491, ACK and do nothing."),b.ack(o);break;default:c()}break;default:e.doUnexpectedMsg(a)}},b=function(b){var c=f.OFFER_ANSWER_STATE.INITIAL,d=f.OFFER_ANSWER_STATE.INITIAL,g=b,j="",k="",l="";this.trickledCandidatesMap=new a.Map,this.getMasterState=function(){return c},this.getSlaveState=function(){return d},this.updateCallRemoteMedias=function(a){g.remoteMedias=h.getMediaFromSDP(a)},this.updateState=function(a,b){switch(i.debug("Trying to update offer-answer state to : "+a),a){case f.OFFER_ANSWER_STATE.OFFER_SENT:k=b,c=a;break;case f.OFFER_ANSWER_STATE.OFFER_GOT:j=b,d=a;break;case f.OFFER_ANSWER_STATE.ANSWER_SENT:d=a,k=b,l=j,this.updateCallRemoteMedias(l);break;case f.OFFER_ANSWER_STATE.ANSWER_GOT:c=a,l=b,this.updateCallRemoteMedias(l);break;case f.OFFER_ANSWER_STATE.ACK_SENT:c=a,b&&(k=b),e.sendTrickledCandidates(g);break;case f.OFFER_ANSWER_STATE.ACK_GOT:d=a,e.sendTrickledCandidates(g);break;case f.OFFER_ANSWER_STATE.OFFER_REJECTED:c=a;break;case f.OFFER_ANSWER_STATE.OFFER_REJECT:d=a}g.offerAnswerManager.masterState=c,g.offerAnswerManager.slaveState=d,g.earlyMediaState&&(g.earlyMediaState=a)},this.canSendOffer=function(){var a=!1;if(g.callState){var b=g.callState.state;(b===f.CALLSTATE.END||b===f.CALLSTATE.FAILED)&&(a=!0)}var e=!(c!==f.OFFER_ANSWER_STATE.ACK_SENT&&c!==f.OFFER_ANSWER_STATE.INITIAL&&c!==f.OFFER_ANSWER_STATE.OFFER_REJECTED||d!==f.OFFER_ANSWER_STATE.ACK_GOT&&d!==f.OFFER_ANSWER_STATE.OFFER_REJECT&&d!==f.OFFER_ANSWER_STATE.INITIAL||a);return i.debug((e?"Can":"Cannot")+" send offer now. The offer-answer master/slave state is: "+g.offerAnswerManager.getMasterState()+" / "+g.offerAnswerManager.getSlaveState()+", call State: "+g.callState.state+", session State: "+g.session.sessionState),e},this.reset=function(){c=f.OFFER_ANSWER_STATE.INITIAL,d=f.OFFER_ANSWER_STATE.INITIAL,j=""},this.getLatestActiveRemoteSdp=function(){return l},this.getLatestActiveLocalSdp=function(){return k}},e.isValidSdp=function(a,b){var c=!1;return c=b.indexOf("a=")<0&&b.indexOf("m=")<0?!1:!0},e.getInitiator=function(a){return a.session.userName},e.getTarget=function(a){var b,c=a.session.userName;return b=c===a.caller?a.callee:a.caller},e.send180Ringing=function(a){var b=e.createResponse(a);b.control.message_state=f.MESSAGESTATE.SUBSEQUENT,b.header.action=f.ACTION.START,a.session.sendMessage(b),a.setCallState(f.CALLSTATE.RESPONDED,180,"Ringing")},e.sendReject=function(a,b,c,d){var g=e.createError(a),h=f.ERRORCODE.DECLINED;b?g.header.error_code=b:g.header.error_code=h,c&&(g.header.reason=c),g.header.action=f.ACTION.START,d&&g.addExtHeaders(d),a.session.sendMessage(g),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.OFFER_REJECT)},e.sendPrack=function(a){var b=e.createRequest(a),c=a.lastServerCorrelationId;b.control.correlation_id=c,b.header.action=f.ACTION.PRACK,a.session.sendMessage(b)},e.createRequest=function(a){var b=new g.Message,c=a.session.lastInboundSeq,d=e.getInitiator(a),h=e.getTarget(a);return b.control.type=f.TYPE.REQUEST,b.control.subsession_id=a.subSessionId,b.control.package_type=a.pkgInstance.packageType,b.control.ack_sequence=c,b.header.initiator=d,b.header.target=h,b},e.createResponse=function(a){var b=new g.Message,c=a.lastServerCorrelationId,d=a.session.lastInboundSeq,e=a.caller,h=a.callee,i=a.subSessionId;return b.control.type=f.TYPE.RESPONSE,b.control.subsession_id=i,b.control.package_type=a.pkgInstance.packageType,b.control.correlation_id=c,b.control.ack_sequence=d,b.header.initiator=e,b.header.target=h,b},e.createError=function(a){var b=e.createResponse(a);return b.control.type=f.TYPE.ERROR,b},e.createMessage=function(a){var b=new g.Message,c=a.session.lastInboundSeq,d=e.getInitiator(a),h=e.getTarget(a),i=a.subSessionId;return b.control.type=f.TYPE.MESSAGE,b.control.subsession_id=i,b.control.package_type=a.pkgInstance.packageType,b.control.ack_sequence=c,b.header.initiator=d,b.header.target=h,b},e.sendTrickledCandidates=function(a){var b=a.offerAnswerManager.trickledCandidatesMap,c="";if(b.size()>0){for(var d=b.keys();d.length>0;){var f=d.shift();c+=f;for(var g=b.get(f);g.length>0;){var h=g.shift(),i=/^a=.*\r\n$/i;c+=h.match(i)?h:"a="+h+"\r\n"}}e.sendTrickleMessage(a,c)}},e.sendTrickleMessage=function(a,b){var c=e.createMessage(a);c.header.action=f.ACTION.TRICKLE,c.payload={candidates:b},a.session.sendMessage(c),b.indexOf("end-of-candidates")>-1&&a.offerAnswerManager.trickledCandidatesMap.clear()},e.checkResumeState=function(a){if(a.resumeState)switch(a.resumeState){case f.RESUME_STATE.waittingFinalResp:a.resumeState=null,a.resume();break;case f.RESUME_STATE.reStartingCall:a.resumeSuccessCallback&&(a.resumeSuccessCallback(),a.resumeState=null)}},e.setCallState=function(a,b,c,d){"use strict";var e=a.callState,g=e.state;if(!e.isFinalState()&&(!e.hasEstablished()||b!==f.CALLSTATE.NONE&&b!==f.CALLSTATE.STARTED&&b!==f.CALLSTATE.RESPONDED)){var h=e.status.code;if(g!==b||g===b&&h!==c){a.callState.state=b,a.callState.status.code=c,a.callState.status.reason=d;try{if(a.onCallStateChange)if(a.lastServerExtHeader){var j=a.lastServerExtHeader;a.onCallStateChange(a.callState,j),delete a.lastServerExtHeader}else a.onCallStateChange(a.callState);else if(a.onStateChange)if(a.lastServerExtHeader){var j=a.lastServerExtHeader;a.onStateChange(a.callState,j),delete a.lastServerExtHeader}else a.onStateChange(a.callState)}catch(k){i.warn("The callback function 'Call.onCallStateChange()' exception: "+k)}a.session.saveToStorage()}}},e.onMessage=function(a,b){if(a.isEnquiry()){if(!b.capabilityExchange){var c="No CapabilityExchange registered with Chat";throw i.error(c),c}b.capabilityExchange.onMessage(a)}else a.isRequest()?d.doRequest(b,a):a.isResponse()?d.doResponse(b,a):a.isMessage()?d.doMessage(b,a):a.isACK()?d.doACK(b,a):a.isError()&&d.doError(b,a)},e.clearMsrpSubSession=function(a){a.session.removeSubSession(a.subSessionId),a.msrpSession&&a.msrpSession.close()},e.msrpSubSessionDecline=function(a,b,c,d){var g,h;g=b?b:f.ERRORCODE.DECLINED,h=c?c:"Decline",a.callState.state===f.CALLSTATE.UPDATING?a.setCallState(f.CALLSTATE.UPDATE_FAILED,g,h):(e.clearMsrpSubSession(a),a.setCallState(f.CALLSTATE.FAILED,g,h)),e.sendReject(a,g,h,d)},e.sendAcceptResponse=function(a,b,c,d){var g=e.createResponse(a);g.control.message_state=f.MESSAGESTATE.FINAL,g.header.action=f.ACTION.START,g.control.correlation_id=b,d&&g.addExtHeaders(d),g.payload={sdp:c},a.session.sendMessage(g)},e.addParticipants2MsrpSubSession=function(a,b){if(b.callState.state!==f.CALLSTATE.NONE)throw{name:"IllegalStateException",message:"Cannot add participants at subSession state: "+b.callState.state};if(!(a instanceof Array))throw{name:"IllegalArgumentException",message:"parameter participants is not array type"};b.participants=a},e.doUnexpectedMsg=function(a){a.setCallState(f.CALLSTATE.ERROR,null,"unexpected message.")},a._private.CallStateMachine=d,a._private.offerAnswerManager=b,a._private.CallCommonUtils=e,a}(wsc||{});
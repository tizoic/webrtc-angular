/*! wsc Built on: 2020-09-03 */
var wsc=function(a){var b=a._private=a._private||{},c=b.browser,d=a.getLogger(),e=function(){this.dataChannel=null,this.origDataChannel=null,this.state="none",this.label=null,this.onOpen=null,this.onClose=null,this.onError=null,this.dataSender=null,this.dataReceiver=null;var a=this,b=function(){a.dataSender=new f(a.dataChannel),d.info("Sender of DataTransfer created.")},e=function(){a.dataReceiver=new g,d.info("Receiver of DataTransfer created.")},h=function(b){d.debug("DataTransfer: Received data:"+b.data),a.dataReceiver?a.dataReceiver.onMessage(b):d.warn("The default data receiver is still initialized to receive data.")},i=function(c){a.origDataChannel&&(a.origDataChannel=null),a.state="open",b(),e();var f=a.dataChannel.readyState;null==a.label&&(a.label=a.dataChannel.label),d.debug('Data Channel "'+a.dataChannel.label+'" is open; current readyState: '+f),a.dataChannel.disabled=!1,a.dataChannel.onmessage=h,a.onOpen&&a.onOpen(c)},j=function(b){if(a.origDataChannel&&b.target&&a.origDataChannel.id!=b.target.id)return a.dataChannel=a.origDataChannel,void(a.origDataChannel=null);a.state="closed";var c=a.dataChannel.readyState;null==a.label&&(a.label=a.dataChannel.label),d.debug('Data Channel "'+a.dataChannel.label+'" is closing; current readyState is: '+c),a.dataChannel.disabled=!0,a.onClose&&a.onClose(b)},k=function(b){d.debug("Received dataChannel error event for DataTransfer: "+a.dataChannel.label),a.onError&&a.onError(b)};this.initDataChannel=function(b,e){if(d.debug("DataTransfer object initialized by the dataChannel."),e&&(a.origDataChannel=a.dataChannel),a.dataChannel=b,a.state="starting",a.label=b.label,a.dataChannel)try{a.dataChannel.onopen=i,(c.isIE||c.isSafari)&&"open"==a.dataChannel.readyState&&setTimeout(function(){var b=null;try{b=new Event("open")}catch(c){b=document.createEvent("Event"),b.initEvent("open",!1,!1)}i.call(a.dataChannel,b)},0),a.dataChannel.onerror=k,a.dataChannel.onclose=j}catch(f){d.error("Exception occured when initializing the callback functions of the data channel: "+f)}else d.error("Could not initialize the data channel with null.")},this.clear=function(){try{null!=a.dataChannel&&(a.dataChannel.close(),a.dataChannel.disabled=!0,d.info("DataTransfer closed its data channel; current readyState is: "+a.dataChannel.readyState)),d.info("DataTransfer object cleared")}catch(b){d.error("Recieved an exception when cleaning the DataTransfer object: "+b)}},this.toJSON=function(){var a={},b={session:"",pkgInstance:""};for(var c in this)c in b||(a[c]=this[c]);return a}};e.prototype={getState:function(){return this.state},getSender:function(){return this.dataSender},getReceiver:function(){return this.dataReceiver}};var f=function(a){this.dataChannel=a};f.prototype={send:function(a){if(null!=this.dataChannel&&"open"===this.dataChannel.readyState)try{this.dataChannel.send(a)}catch(b){throw d.debug("Exception when sending data by dataChannel: "+b),b}else d.error("Error when sending data. The dataChannel is not in a valid state.")}};var g=function(){this.onMessage=function(a){d.info("onMessage function is not overridden by the application. New received data is handle by the default DataReceiver object."+a.data)}};return g.prototype={},b.DataTransfer=e,b.DataSender=f,b.DataReceiver=g,a}(wsc||{}),wsc=function(a){function b(a){const b=3;var c=0,d=function(d){if(d&&(null===a.peerConnection||void 0===a.peerConnection))return j.debug("call.peerConnection: "+a.peerConnection+", the call may need to be updated."),!0;var e=a.peerConnection.iceConnectionState;return"connected"===e&&c>0&&(j.debug("ICE connection state gets to 'connected', reset the counter to 0."),c=0),c>=b?(j.debug("No more updating. Have updated call to restore ICE failure for "+c+" times."),a.setCallState(h.CALLSTATE.ERROR,"","ICE failure"),!1):"failed"===e||d&&"closed"===e},e=function(){var b=a.callState;return b.state===h.CALLSTATE.ESTABLISHED||b.state===h.CALLSTATE.UPDATE_FAILED||b.state===h.CALLSTATE.UPDATED},f=function(){var b="Call state: "+a.callState.state+", ICE connectionstate: "+(a.peerConnection?a.peerConnection.iceConnectionState:"peerConnection is null")+", Retry number: "+(c+1);e()&&d(!0)?(c+=1,j.debug("Do call update to fix the ICE failure. "+b),a.update(a.callConfig)):j.debug("No update is needed to fix the ICE failure. "+b)},g=function(b){var c=a.session.lastActiveTime,d=function(){c!=a.session.lastActiveTime?(j.debug("Waiting for receiving any message from session web socket... Done"),b()):setTimeout(function(){d()},50)};d()};this.updateIceConnectionState=function(b){return b.target!==a.peerConnection?void j.debug("Target PeerConnection is not for this call!"):void(d()&&e()&&(j.debug("Waiting for receiving any message from session web socket... "),g(function(){var b=a.session.sessionState;if(b===h.SESSIONSTATE.CONNECTED)f();else{j.debug("Session state: "+b+", waiting for session state CONNECTED.");var c=a.session.setSessionState.bind(a.session);a.session.setSessionState=function(b){return b===h.SESSIONSTATE.CONNECTED&&(a.session.setSessionState=c,f()),c(b)}}})))}}var c=a._private=a._private||{},d={},e=c.CallStateMachine,f=c.CallCommonUtils,g=c.rtcHelper,h=c.wscConst,i=(c.wscUtils,c.DataTransfer),j=a.getLogger(),k=(a.getLogLevel(),new WeakMap),l=function(a,b){"use strict";if(!a){var c="The parameter 'session' cannot be null!";throw j.error(c),c}b?this.packageType=b:this.packageType=h.PACKAGE.CALL,a.registerPackage(this),this.session=a,this.trickleIceMode="off",this.ipv6=!1,this.dscp=!1,this.onIncomingCall=null,this.onResurrect=null};l.prototype={getCalls:function(){"use strict";var a=[],b=this.session.getSubSessionsByPackageType(this.packageType),c=null;if(b){c=b.values();for(var d=0;d<c.length;d++)a[d]=c[d]}return a},createCall:function(a,b,c){"use strict";var d,e,f=this.session,g=this.session.userName;if(null==a||""===a)throw e="The callee cannot be empty!",j.warn(e),"CallPackage.createCall(): Empty callee exception.";return d=this.prepareCall(f,b,g,a),d.subSessionId=f.generateSubSessionId(),d.onCallError=c,d.pkgInstance=this,this.putCall(d.subSessionId,d),d},close:function(){"use strict";for(var a=this.getCalls(),b=0;b<a.length;b++){var c=a[b];c.end(),c=null}},clear:function(){for(var a=this.getCalls(),b=0;b<a.length;b++){var c=a[b];d.clearCall(c),c=null}},onMessage:function(a){"use strict";var b=this.session,c=a.control.subsession_id,d=this.session.getSubSession(c),e=a.getExtHeaders();null==d&&(d=this.prepareCall(b),d.pkgInstance=this),e&&(d.lastServerExtHeader=e),d.onMessage(a)},onRehydration:function(b){"use strict";for(var c in b.entry){var d=b.entry[c],e=d.caller,f=d.callee,g=d.callConfig,h=new m(g.audioConfig,g.videoConfig,g.dataChannelConfig),i=this.prepareCall(this.session,h,e,f);i.pkgInstance=this,i.callState=new a.CallState(d.callState.state,d.callState.status.code,d.callState.status.reason),i.earlyMediaState=d.earlyMediaState,i.subSessionId=d.subSessionId;var j;if(d.remoteMedias&&d.remoteMedias.length){j=[];for(var k=0;k<d.remoteMedias.length;k++){var l=d.remoteMedias[k],n=new Media(l.mode,l.port,l.type);j[k]=n}}i.remoteMedias=j,i.offerAnswerManager.updateState(d.offerAnswerManager.masterState),i.offerAnswerManager.updateState(d.offerAnswerManager.slaveState),i.iceTimeout=d.iceTimeout,this.putCall(c,i),this.onResurrect(i)}},prepareCall:function(a,b,c,d){"use strict";return new n(a,b,c,d)},putCall:function(a,b){this.session.putSubSession(this.packageType,a,b)},setTrickleIceMode:function(a){this.trickleIceMode=a},setIPv6:function(a){this.ipv6=a},setDSCP:function(a){this.dscp=a},toJSON:function(){var a={},b={session:""};for(var c in this)c in b||(a[c]=this[c]);return a}};var m=function(a,b,c,d){"use strict";this.audioConfig=a,this.videoConfig=b,this.dataChannelConfig=c,this.maxAudioBitrate=d,this.hasAudio=function(){return null!=this.audioConfig&&(this.audioConfig===h.MEDIADIRECTION.SENDRECV||this.audioConfig===h.MEDIADIRECTION.SENDONLY)},this.hasVideo=function(){return null!=this.videoConfig&&(this.videoConfig===h.MEDIADIRECTION.SENDRECV||this.videoConfig===h.MEDIADIRECTION.SENDONLY)},this.shouldSendAudio=function(){return null!=this.audioConfig&&(this.audioConfig===h.MEDIADIRECTION.SENDRECV||this.audioConfig===h.MEDIADIRECTION.SENDONLY)},this.shouldSendVideo=function(){return null!=this.videoConfig&&(this.videoConfig===h.MEDIADIRECTION.SENDRECV||this.videoConfig===h.MEDIADIRECTION.SENDONLY)},this.shouldReceiveAudio=function(){return null!=this.audioConfig&&(this.audioConfig===h.MEDIADIRECTION.SENDRECV||this.audioConfig===h.MEDIADIRECTION.RECVONLY)},this.shouldReceiveVideo=function(){return null!=this.videoConfig&&(this.videoConfig===h.MEDIADIRECTION.SENDRECV||this.videoConfig===h.MEDIADIRECTION.RECVONLY)},this.hasMaxBitrate=function(){return"undefined"!=typeof this.maxAudioBitrate&&null!==this.maxAudioBitrate&&this.maxAudioBitrate>0}},n=function(e,i,j,l){this.session=e,this.caller=j,this.callee=l,this.callConfig=i,this.dataTransfers=new a.Map,this.lastCallConfig=null,this.callState=new a.CallState(h.CALLSTATE.NONE,null,""),this.earlyMediaState=null,this.resumeState=null,this.peerConnection=null,this.onMediaStreamEvent=null,this.onCallStateChange=null,this.onDataTransfer=null,this.onUpdate=null,this.onCallError=null,this.streamAddTimes=0,this.hungupCallback=null,this.subSessionId=null,this.startReqCorrId=null,this.newRemoteSDP=null,this.newRemoteMedias=null,this.remoteMedias=null,this.localMediaStreams=[],this.temporarySavedStreams=[],this.offerAnswerManager=new c.offerAnswerManager(this);var m=2e3;this.setIceCheckInterval=function(a){if(0>=a)throw{name:"IllegalArgumentError",message:"The ICE check Interval must be greater than zero."};m=a},this.getIceCheckInterval=function(){return m},this.setCapabilityExchange=function(a){this.capabilityExchange=a},this._template={doStartCallRequest:function(a){var b=a.payload.sdp,c=g.getCallConfigFromRemoteSDP(b,!1),d=g.getCallConfigFromRemoteSDP(b,!0),e=this.parent.callState,h=a.control.subsession_id,i=a.getExtHeaders();this.parent.callConfig=c,this.parent.newRemoteSDP=a.payload,this.parent.newRemoteMedias=g.getMediaFromSDP(b),this.parent.pkgInstance.putCall(h,this.parent),e.is180Ringing()||f.send180Ringing(this.parent);var j=this.parent.pkgInstance.onIncomingCall;j&&j(this.parent,d,i)},doUpdateCallRequest:function(a){var b=a.payload.sdp,c=this.parent,e=g.getCallConfigFromRemoteSDP(b),f=a.getExtHeaders();c.lastCallConfig=c.callConfig,c.callConfig=e,c.newRemoteMedias=g.getMediaFromSDP(b),c.newRemoteSDP=a.payload,d.handleUpdateCallRequest(c,f)},doStartUnReliableProvRespWithSDP:function(a){d.handleAnswer(this.parent,a.payload)},doStart2XXResponse:function(a){d.handleAnswer(this.parent,a.payload)},doUpdate200Response:function(a){d.handleAnswer(this.parent,a.payload)},doShutdownMessage:function(){d.clearCall(this.parent)},clearCall:function(){d.clearCall(this.parent)},rollbackUpdate:function(){d.rollbackUpdate(this.parent)},doStartCallError:function(){d.clearCall(this.parent)},doStartReliableProvRespWithSDP:function(a){var b=a.payload,c=this.parent;b.type="answer";var e=c.offerAnswerManager.getMasterState();if(e===h.OFFER_ANSWER_STATE.OFFER_SENT){var i=function(){c.offerAnswerManager.updateState(h.OFFER_ANSWER_STATE.ANSWER_GOT,b.sdp),c.lastServerCorrelationId=a.control.correlation_id,f.sendPrack(c),c.offerAnswerManager.updateState(h.OFFER_ANSWER_STATE.ACK_SENT)};g.setRemoteDescription(c,new RTCSessionDescription(b),i,d.srdError(c))}},doStartReliableProvRespWithoutSDP:function(a){var b=(a.payload,this.parent);b.lastServerCorrelationId=a.control.correlation_id,f.sendPrack(b)},doStart200RespInEarlyPhase:function(a){var b=this.parent;b.earlyMediaState=null,b.setCallState(h.CALLSTATE.RESPONDED,200,"got success response"),a.complete(e),b.setCallState(h.CALLSTATE.ESTABLISHED,null,"sent complete"),f.checkResumeState(b)},doUpdate200RespInEarlyPhase:function(a){var b=this.parent;d.handleAnswer(b,a.payload),b.offerAnswerManager.updateState(h.OFFER_ANSWER_STATE.ANSWER_GOT,a.payload.sdp),a.complete(b.session),b.offerAnswerManager.updateState(h.OFFER_ANSWER_STATE.ACK_SENT),f.checkResumeState(b)},sendOffer:function(){d.sendOfferImpl(this.parent)}},this._template.parent=this;var n={iceFailureHandler:new b(this)};k.set(this,n)};return n.prototype={start:function(b,c){function e(a){f([a])}function f(b){try{k.callConfig.dataChannelConfig&&d.initDataTransfers(k),d.initOfferCtx(k,b,c)}catch(e){k.onCallError?g.invokeCallError(k,a.ERRORCODE.PEERCONNECTION_ERROR,e):j.error("Start exception: "+e)}}function i(a){j.error("Cannot get local stream... ",a),k.fireMediaStreamEvent(h.MEDIASTREAMEVENT.LOCAL_STREAM_ERROR,null)}var k=this;if(k.callState.state!==h.CALLSTATE.NONE&&k.resumeState!==h.RESUME_STATE.reStartingCall)throw"The call has already been started";c&&(k.extHeaders=c);var l=k.callConfig.shouldSendAudio(),m=k.callConfig.shouldSendVideo();l||m?b&&b.length>0?f(b):d.initUserMedia(k,e,i):f(b)},getDataTransfer:function(a){return this.dataTransfers.get(a)},getCaller:function(){return this.caller},getCallee:function(){return this.callee},getCallState:function(){return this.callState},getCallConfig:function(){return this.callConfig?new m(this.callConfig.audioConfig,this.callConfig.videoConfig,this.callConfig.dataChannelConfig):null},getPeerConnection:function(){return this.peerConnection},toJSON:function(){var a=this.callConfig;this.lastCallConfig&&(a=this.lastCallConfig);var b={caller:this.caller,callee:this.callee,callConfig:a,callState:this.callState,earlyMediaState:this.earlyMediaState,subSessionId:this.subSessionId,remoteMedias:this.remoteMedias,offerAnswerManager:this.offerAnswerManager,iceTimeout:this.iceTimeout,onDataTransfer:this.onDataTransfer};return b},setCallState:function(a,b,c){f.setCallState(this,a,b,c)},fireMediaStreamEvent:function(a,b){"use strict";if(this.onMediaStreamEvent)try{if(this.lastServerExtHeader){var c=this.lastServerExtHeader;this.onMediaStreamEvent(a,b,c),delete this.lastServerExtHeader}else this.onMediaStreamEvent(a,b)}catch(d){j.warn("The callback function 'Call.onMediaStreamEvent()' exception:"+d)}},decline:function(a,b){"use strict";try{null==a&&(a=h.ERRORCODE.DECLINED),this.callState.state===h.CALLSTATE.UPDATING?(this.callConfig=this.lastCallConfig,this.setCallState(h.CALLSTATE.UPDATE_FAILED,a,"Decline")):(g.clearPeerConnection(this),this.peerConnection=null,this.session.removeSubSession(this.subSessionId),this.setCallState(h.CALLSTATE.FAILED,a,"Decline")),f.sendReject(this,a,null,b),j.info("decline call."),this.callState.state!==h.CALLSTATE.UPDATE_FAILED||this.peerConnection||(j.info("Peer connection is null, restart the call."),this.resumeState=h.RESUME_STATE.reStartingCall,this.start())}catch(c){j.error("answer error: "+c)}},accept:function(b,c,e){"use strict";function f(a){k([a])}function i(a){j.error("Cannot get local stream... ",a),l.fireMediaStreamEvent(h.MEDIASTREAMEVENT.LOCAL_STREAM_ERROR,null),l.decline()}function k(b){try{d.initAnswerCtx(l,b,e)}catch(c){l.onCallError&&g.invokeCallError(l,a.ERRORCODE.PEERCONNECTION_ERROR,c),j.error("Got exception when accept the call: "+c)}}var l=this;b||(b=this.callConfig);try{this.setCallState(h.CALLSTATE.STARTED,null,"receive call");var m=d.isValidAnswerCallConfig(this.callConfig,b);if(!m)throw{name:"InvalidCallConfig",message:"The parameter 'callConfig' is invalid."};if(this.callState.state===h.CALLSTATE.UPDATING&&null!=this.peerConnection)d.onUpdateCall(this,b,c,e);else{b&&(this.callConfig=b);var n=b.shouldSendAudio(),o=b.shouldSendVideo();n||o?c?k(c):d.initUserMedia(l,f,i):k()}j.debug("accept call")}catch(p){throw j.error("answer error: "+p),p}},end:function(a){"use strict";var b=f.createMessage(this),c="cancelled";b.header.action=h.ACTION.SHUTDOWN,b.addExtHeaders(a),this.callState.state===h.CALLSTATE.NONE||this.callState.isFinalState()||(this.callState.hasEstablished()?(b.control.correlation_id=this.session.genNewCorrelationId(),c="shutdown"):(b.control.correlation_id=this.startReqCorrId,c="cancelled"),this.session.sendMessage(b)),d.clearCall(this),this.setCallState(h.CALLSTATE.ENDED,"",c)},update:function(a,b,c){"use strict";this.setCallState(h.CALLSTATE.UPDATING,"","update"),d.updateCall(this,a,b,c)},resume:function(a,b){j.info("Begin to resume call");var c=this,d=c.temporarySavedStreams;if(c.resumeSuccessCallback=a,c.resumeFailureCallback=b,c.session.clientIpNotChangedAfterReconnect)return c.session.clientIpNotChangedAfterReconnect=!1,j.debug("Client network was not changed, no further action needed."),void(c.resumeSuccessCallback&&c.resumeSuccessCallback());var e=c.offerAnswerManager.getMasterState(),f=c.offerAnswerManager.getSlaveState(),g=h.OFFER_ANSWER_STATE;switch(j.debug("The m/s offer-answer states are: "+e+"/"+f),e){case g.INITIAL:switch(f){case g.OFFER_REJECT:case g.INITIAL:c.resumeSuccessCallback&&c.resumeSuccessCallback();break;case g.OFFER_GOT:c.resumeSuccessCallback&&c.resumeSuccessCallback();break;case g.ANSWER_SENT:c.resumeState=h.RESUME_STATE.reStartingCall,c.start(d);break;case g.ACK_GOT:c.resumeState=h.RESUME_STATE.reStartingCall,c.start(d)}break;case g.OFFER_SENT:switch(f){case g.OFFER_REJECT:case g.INITIAL:case g.OFFER_GOT:case g.ACK_GOT:c.resumeState=h.RESUME_STATE.waittingFinalResp,c.resumeSuccessCallback&&c.resumeSuccessCallback()}break;case g.ANSWER_GOT:switch(f){case g.OFFER_REJECT:case g.INITIAL:case g.OFFER_GOT:case g.GLARE:case g.ACK_GOT:case g.ANSWER_SENT:c.resumeState=h.RESUME_STATE.reStartingCall,c.start(d)}break;case g.ACK_SENT:switch(f){case g.OFFER_GOT:c.resumeSuccessCallback&&c.resumeSuccessCallback();break;case g.ANSWER_SENT:c.resumeState=h.RESUME_STATE.reStartingCall,c.start(d);break;case g.INITIAL:case g.OFFER_REJECT:case g.ACK_GOT:c.resumeState=h.RESUME_STATE.reStartingCall,c.start(d)}break;case g.OFFER_REJECTED:switch(f){case g.OFFER_REJECT:case g.INITIAL:case g.ACK_GOT:c.resumeState=h.RESUME_STATE.reStartingCall,c.start(d);break;case g.OFFER_GOT:c.resumeSuccessCallback&&c.resumeSuccessCallback();break;case g.ANSWER_SENT:c.resumeState=h.RESUME_STATE.reStartingCall,c.start(d)}}},onMessage:function(a){if(a.isEnquiry()){if(!this.capabilityExchange){var b="No CapabilityExchange registered with this call";throw j.error(b),b}this.capabilityExchange.onMessage(a)}else a.isRequest()?e.doRequest(this,a):a.isResponse()?e.doResponse(this,a):a.isMessage()?e.doMessage(this,a):a.isError()?e.doError(this,a):f.doUnexpectedMsg(this)}},d.sendOffer=function(a,b){a.offerAnswerManager.canSendOffer()&&a.peerConnection&&a.peerConnection.localDescription&&a.peerConnection.localDescription.sdp&&d.sendOfferImpl(a,b)},d.sendOfferImpl=function(a,b){if(a.callState.state===h.CALLSTATE.ENDED||a.callState.state===h.CALLSTATE.FAILED)j.warn("Call has ended while sending offer, clear the call."),d.clearCall(a);else{var c,e=f.createRequest(a),g=a.session.genNewCorrelationId();if(!a.peerConnection)return void j.warn("The peerConnection of the call is null");c=a.peerConnection.localDescription.sdp,e.header.action=h.ACTION.START,e.control.correlation_id=g,e.payload={sdp:c},b?e.addExtHeaders(b):a.extHeaders&&(e.addExtHeaders(a.extHeaders),a.extHeaders=null);var i=!1;a.authInfo&&(e.header.authorization=a.authInfo,i=!0,a.authInfo=null);try{a.session.sendMessage(e),a.startReqCorrId=e.control.correlation_id,a.offerAnswerManager.updateState(h.OFFER_ANSWER_STATE.OFFER_SENT,c),a.callState.state===h.CALLSTATE.NONE&&a.setCallState(h.CALLSTATE.STARTED,null,"start call")}catch(k){}}},d.sendAnswer=function(a,b){if(a.callState.state===h.CALLSTATE.ENDED||a.callState.state===h.CALLSTATE.FAILED)j.warn("Call has ended while sending answer, clear the call."),d.clearCall(a);else if(a&&a.peerConnection&&a.peerConnection.localDescription&&a.peerConnection.localDescription.sdp){var c=f.createResponse(a),e=a.peerConnection.localDescription.sdp,i=a.lastServerCorrelationId;c.control.message_state=h.MESSAGESTATE.FINAL,c.header.action=h.ACTION.START,c.control.correlation_id=i,b&&c.addExtHeaders(b),a.callConfig.hasMaxBitrate()&&(e=g.changeAudioBitrate(e,a)),c.payload={sdp:e},a.session.sendMessage(c),j.debug("Answer is sent...\r\n"+e),a.setCallState(h.CALLSTATE.RESPONDED,200,"sent success response"),a.offerAnswerManager.updateState(h.OFFER_ANSWER_STATE.ANSWER_SENT,e)}},d.sendAnswerInComplete=function(a,b){var c=a.peerConnection.localDescription.sdp,d=f.createMessage(a);d.header.action=h.ACTION.COMPLETE,d.control.correlation_id=a.startReqCorrId,d.payload={sdp:c},b&&d.addExtHeaders(b),a.session.sendMessage(d),a.offerAnswerManager.updateState(h.OFFER_ANSWER_STATE.ACK_SENT,c),a.setCallState(h.CALLSTATE.ESTABLISHED,null,"sent complete")},d.initOfferCtx=function(b,c,e){"use strict";var f=b.peerConnection,h=function(){d.sendOffer(b,e)};null==b.peerConnection&&(g.createPeerConnection(b,c),f=b.peerConnection),b.callConfig.dataChannelConfig&&d.initDataChannel(b);var i=function(c){j.error("Offer error:"+c),g.invokeCallError(b,a.ERRORCODE.PEERCONNECTION_ERROR,c)},k=function(a){var c=g.changeSdpByCallConfig(a.sdp,b),e=function(){d.bindIceHandler(b,h,!0)};g.setLocalDescription(b,new RTCSessionDescription({type:"offer",sdp:c}),e)},l={offerToReceiveAudio:b.callConfig.shouldReceiveAudio()?1:0,offerToReceiveVideo:b.callConfig.shouldReceiveVideo()?1:0};f.createOffer(k,i,l),b.peerConnection=f},d.initAnswerCtx=function(b,c,e){"use strict";var f=b.peerConnection;null==b.peerConnection&&(g.createPeerConnection(b,c),f=b.peerConnection),b.callConfig.dataChannelConfig&&d.initReceivedDataChannel(b);var h=function(){var c=function(){d.sendAnswer(b,e)},h=function(e){var f=g.changeSdpByCallConfig(e.sdp,b),h=function(){d.bindIceHandler(b,c,!1)},i=function(c){j.warn("Set localDescription failed!"),g.invokeCallError(b,a.ERRORCODE.PEERCONNECTION_ERROR,c)};g.setLocalDescription(b,new RTCSessionDescription({type:"answer",sdp:f}),h,i)},i=function(c){j.error("Answer error:"+c),g.invokeCallError(b,a.ERRORCODE.PEERCONNECTION_ERROR,c)};f.createAnswer(h,i)},i=b.newRemoteSDP;i.type="offer";var k=d.modifyFirefoxSdpFromME(b,b.newRemoteSDP.sdp);i.sdp=k;var l=new RTCSessionDescription(i);g.setRemoteDescription(b,l,h,d.srdError(b))},d.clearCall=function(a){"use strict";a&&d.clearDataTransfers(a.dataTransfers);try{g.clearPeerConnection(a),a.peerConnection=null}catch(b){j.error("clear call error: "+b)}for(var c=a.localMediaStreams,e=0;e<c.length;e++){var f=c[e];j.debug("Media stream "+e+": used by "+f.peerConnectionNum+" peer connections."),f&&(null==f.peerConnectionNum||f.peerConnectionNum<=0)&&(j.debug("Stop this media stream: [video tracks: "+f.getVideoTracks().length+", audio tracks: "+f.getAudioTracks().length+"]"),f.getTracks().forEach(function(a){a.stop()}))}a.session.removeSubSession(a.subSessionId)},d.clearDataTransfers=function(a){"use strict";if(a&&0!==a.size())for(var b=a.values(),c=null,d=0;d<b.length;d++)c=b[d],c.clear()},d.rollbackUpdate=function(a){"use strict";if(a&&a.peerConnection){var b=a.peerConnection.remoteDescription;b&&(b.type="answer",g.setRemoteDescription(a,b)),a.lastCallConfig&&(a.callConfig=a.lastCallConfig)}},d.updateCall=function(a,b,c,e){a.lastCallConfig=a.callConfig,a.callConfig=b;var f=function(b,c,d){a.peerConnection.createOffer(b,c,d)},g=function(){var b=function(){d.sendOffer(a,e)};d.bindIceHandler(a,b,!0)},h=function(){};d.doUpdate(a,b,c,f,h,g,!0)},d.closePcForUpdate=function(a,b){for(var c=g.getLocalStreams(a),d=0;d<c.length;d++){var e=c[d];e.peerConnectionNum&&e.peerConnectionNum--}a.close()},d.handleMediaStreamForUpdate=function(a,b,c,d){var e=!1,f=!1,h=(a.peerConnection,a.localMediaStreams),i=!1,j=function(b,c,d){for(var e=!1,f=0;f<b.length;f++){var h=b[f],i=h.getAudioTracks(),j=h.getVideoTracks(),k=i&&i.length>0,l=j&&j.length>0;c===k&&d===l&&(g.addLocalStream(a,h),e=!0)}return e};return b&&(i=j(b,c,d)),!i&&h&&(i=j(h,c,d)),c&&!d?e=!i:!c&&d?f=!i:c&&d&&(i||(e=f=!0,b&&(e=!j(b,!0,!1),f=!j(b,!1,!0)),(e||f)&&h&&(e&&(e=!j(h,!0,!1)),f&&(f=!j(h,!1,!0))))),{needNewAudioStream:e,needNewVideoStream:f}},d.initUserMedia=function(b,c,d,e){"use strict";var f=function(a){if(b.callState){var d=b.callState.state;if(d===h.CALLSTATE.END||d===h.CALLSTATE.FAILED)return void j.debug("Got media stream, but the call state is failed or end. So do nothing then.")}c(a)},i=function(c){if(j.error("Failed to get access to local media. Error name was "+c.name),b.callState){var e=b.callState.state;if(e===h.CALLSTATE.END||e===h.CALLSTATE.FAILED)return void j.debug("Failed to get access to local media, but the call state is failed or end. So do nothing then.")}g.invokeCallError(b,a.ERRORCODE.MEDIA_ERROR,c.name+": "+c.message),d&&d(c)};e||(e={audio:b.callConfig.shouldSendAudio(),video:b.callConfig.shouldSendVideo()});try{navigator.getUserMedia(e,f,i)}catch(k){throw j.error("The callConfig is invalid, cause initialize user media exception:"+k),k}},d.handleUpdateCallRequest=function(a,b){"use strict";var c=a.offerAnswerManager.getLatestActiveRemoteSdp();j.debug("The latest active remote SDP is: "+c),j.debug("The latest active remote medias is: "+a.remoteMedias);var e=g.isMediaChanged(a.newRemoteMedias,a.remoteMedias);e?(a.setCallState(h.CALLSTATE.UPDATING,null,"onUpdate"),a.onUpdate?a.onUpdate(a.callConfig,b):j.warn("No callback for update call request")):null==a.peerConnection||null==a.peerConnection.localDescription?(j.info("Client is not ready. Reject incoming call."),f.sendReject(a)):(g.createNewPeerConnection(a),a.offerAnswerManager.reset(),a.offerAnswerManager.updateState(h.OFFER_ANSWER_STATE.OFFER_GOT,a.newRemoteSDP.sdp),d.initAnswerCtx(a))},d.handleAnswer=function(a,b){"use strict";b.type="answer";var c=d.modifyFirefoxSdpFromME(a,b.sdp);if(b.sdp=c,a.peerConnection){var e=function(){a&&a.peerConnection&&a.peerConnection.remoteDescription};g.setRemoteDescription(a,new RTCSessionDescription(b),e)}},d.onUpdateCall=function(a,b,c,e){var f=function(){a.decline()},h=function(b,c,e){var f=new RTCSessionDescription({type:"offer",sdp:a.newRemoteSDP.sdp}),h=function(){j.debug("[UPDATE] offer is set as remote description...\r\n"+a.newRemoteSDP.sdp);var d=function(b){c(b),a.decline()};a.peerConnection.createAnswer(b,d)};g.setRemoteDescription(a,f,h,d.srdError(a))},i=function(){var b=function(){d.sendAnswer(a,e)};d.bindIceHandler(a,b,!1)};d.doUpdate(a,b,c,h,f,i,!1)},d.doUpdate=function(b,c,e,f,i,k,l){"use strict";var m=c,n=!1,o=!1,p=!1,q=!1,r=b.peerConnection;d.rollbackUpdate=function(a){var b=a.peerConnection;a.peerConnection=r,d.closePcForUpdate(b,a),a.lastCallConfig&&(a.callConfig=a.lastCallConfig)};var s=b.temporarySavedStreams;b.temporarySavedStreams=[],g.createPeerConnection(b),b.callConfig.dataChannelConfig&&(l?(d.initDataTransfers(b),d.initDataChannel(b)):d.initReceivedDataChannel(b)),b.temporarySavedStreams=s,(m.audioConfig===h.MEDIADIRECTION.SENDONLY||m.audioConfig===h.MEDIADIRECTION.SENDRECV)&&(n=!0),(m.videoConfig===h.MEDIADIRECTION.SENDONLY||m.videoConfig===h.MEDIADIRECTION.SENDRECV)&&(o=!0),(m.audioConfig===h.MEDIADIRECTION.RECVONLY||m.audioConfig===h.MEDIADIRECTION.SENDRECV)&&(p=!0),(m.videoConfig===h.MEDIADIRECTION.RECVONLY||m.videoConfig===h.MEDIADIRECTION.SENDRECV)&&(q=!0);var t=b.peerConnection,u=t.onsignalingstatechange;t.onsignalingstatechange=function(a){j.debug("signalingState: ",t.signalingState),"function"==typeof u&&u(a),"stable"===t.signalingState&&(d.closePcForUpdate(r,b),j.debug("Upgrade: the old peer connection is closed.",r),t.onsignalingstatechange=u)};var v=d.handleMediaStreamForUpdate(b,e,n,o),w=function(){if(!b.peerConnection)throw j.error("Peer connection of the call is null."),{name:"Error",message:"Peer connection of the call is null."};var c={offerToReceiveAudio:p?1:0,offerToReceiveVideo:q?1:0},e=function(a){j.debug("Updating call: "+a.type+" created... "+a.sdp);var c=g.changeSdpByCallConfig(a.sdp,b);a=new RTCSessionDescription({type:a.type,sdp:c}),g.setLocalDescription(b,a,k)},i=function(c){j.error("Browser failed to create sdp! The error is: ",c),b.setCallState(h.CALLSTATE.UPDATE_FAILED,a.ERRORCODE.PEERCONNECTION_ERROR,c),d.rollbackUpdate(b)};f(e,i,c)},x=function(c){var d=a.getLogLevel();d===h.LOGLEVEL.DEBUG?j.debug("[UPDATE] got local stream..."+c):d<=h.LOGLEVEL.INFO&&j.info("[UPDATE] got local stream..."),g.addLocalStream(b,c),w()},y=function(a){j.error("[Update] Cannot get local stream... ",a),b.fireMediaStreamEvent(h.MEDIASTREAMEVENT.LOCAL_STREAM_ERROR,null),i&&i(),d.rollbackUpdate(b)};if(v.needNewAudioStream||v.needNewVideoStream){var z={audio:v.needNewAudioStream,video:v.needNewVideoStream};d.initUserMedia(b,x,y,z)}else w()},d.initDataTransfers=function(a){var b,c=a.callConfig.dataChannelConfig;if(0!==c.length)for(b in c){var d=c[b],e=a.dataTransfers.get(d.label);e||(e=new i,a.dataTransfers.put(d.label,e));try{a.onDataTransfer?a.onDataTransfer(e):j.warn("The onDataTransfer() callback function is not set when starting.")}catch(f){j.warn("The callback function 'Call.onDataTransfer()' encountered an exception: "+f)}}},d.initDataChannel=function(a){var b,c=a.peerConnection,d=a.callConfig.dataChannelConfig;if(0!==d.length)for(b in d){var e=d[b],f=JSON.parse(JSON.stringify(e));delete f.label,null==f.maxPacketLifeTime&&null==f.maxRetransmits&&(delete f.maxPacketLifeTime,delete f.maxRetransmits);for(var g in f)f.hasOwnProperty(g)&&-1===f[g]&&delete f[g];var i=c.createDataChannel(e.label,f),k=a.dataTransfers.get(e.label);k.initDataChannel(i,a.callState.state==h.CALLSTATE.UPDATING)}j.debug("DataChannel is initiated")},d.initReceivedDataChannel=function(a){a.peerConnection.ondatachannel=function(b){j.debug("Data channel is received");for(var c=b.channel.label,d=!1,e=0;e<a.callConfig.dataChannelConfig.length;e++)c===a.callConfig.dataChannelConfig[e]&&(d=!0);d||a.callConfig.dataChannelConfig.push({label:c,ordered:b.channel.ordered,maxPacketLifeTime:b.channel.maxPacketLifeTime,maxRetransmits:b.channel.maxRetransmits,protocol:b.channel.protocol,negotiated:b.channel.negotiated,id:b.channel.id});var f=a.getDataTransfer(c);f?j.debug("Data channel is updating."):(f=new i,j.debug("The dataTransfer object with label "+c+" is created"),a.dataTransfers.put(c,f));var g=b.channel;f.initDataChannel(g,!1);try{a.onDataTransfer?a.onDataTransfer(f):j.warn("The onDataTransfer() callback function is not set.")}catch(h){j.warn("The callback function 'Call.onDataTransfer()' exception: "+h)}a.session.saveToStorage()}},d.bindIceHandler=function(a,b,c){function d(){r.onicecandidate=i}function e(){a.peerConnection.onicecandidate=h,b()}function h(a){var b=a.candidate,c=n(b);c&&b||(c?(j.debug("handleNewIceCandidate: got 'end of candidates' event."),p()):(j.debug("handleNewIceCandidate: candidate- "+JSON.stringify(b)),o(b)))}function i(a){var c=a.candidate;j.debug("ICE gathering state: "+r.iceGatheringState),c?j.debug("handleEndOfCandidate: candidate- "+JSON.stringify(c)):(j.debug("handleEndOfCandidate: got 'end of candidates' event."),b(),r&&(r.onicecandidate=m))}function l(a){j.debug("ICE connection state: "+a.target.iceConnectionState)}function m(a){var b=a.candidate;b?j.debug("logIceCandidates : candidate- "+JSON.stringify(a.candidate)):j.debug("logIceCandidates : end of candidates.")}function n(a){var b=!1;return a?(null!=a&&a.candidate.length>0?(j.debug("CandidateGatheringFinished : Valid candidate"),b=!1):null!=a&&0==a.candidate.length&&(j.debug("CandidateGatheringFinished : Blank candidate received"),b=!0),b):b=!0}function o(b){function c(){var a=h.get(d);a?a.push(e):(a=[],a.push(e),h.put(d,a))}var d,e,h=a.offerAnswerManager.trickledCandidatesMap;if(b.sdpMid)d="a=mid:"+b.sdpMid+"\r\n";else{if(null===b.sdpMLineIndex)return void j.warn("ICE Candidate is invalid, ignore it!");var i=a.offerAnswerManager.getLatestActiveLocalSdp();if(i){var k=g.getMediaFromSDP(i);if(k.length>0){var l=k[b.sdpMLineIndex];d=l.mid+"\r\n"}}}b.candidate&&(e=b.candidate),c(),a.offerAnswerManager.canSendOffer()&&f.sendTrickledCandidates(a)}function p(){for(var b=a.offerAnswerManager.trickledCandidatesMap,c=b.keys();c.length>0;){var d=c.shift(),e=b.get(d);e.push("end-of-candidates")}a.offerAnswerManager.canSendOffer()&&f.sendTrickledCandidates(a)}function q(a){return a.indexOf("a=ice-options:trickle")>-1?!0:!1}var r=(a.offerAnswerManager,a.peerConnection);if(!r)throw{name:"IllegalStateError",
message:"There is no peerConnection in the call, cannot bind."};switch(a.pkgInstance.trickleIceMode){case"off":d();break;case"half":c?d():q(a.newRemoteSDP.sdp)?e():d();break;case"full":c||q(a.newRemoteSDP.sdp)?e():d();break;default:d()}r.oniceconnectionstatechange=function(b){l(b),k.get(a).iceFailureHandler.updateIceConnectionState(b)}},d.isValidAnswerCallConfig=function(a,b){var c={SENDRECV:6,SENDONLY:4,RECVONLY:2,NONE:1},d=b.audioConfig,e=(b.videoConfig,a.audioConfig),f=(a.videoConfig,!1);return e===h.MEDIADIRECTION.SENDONLY||e===h.MEDIADIRECTION.RECVONLY||e===h.MEDIADIRECTION.NONE?(e===d||d===h.MEDIADIRECTION.NONE)&&(f=!0):c[d]<=c[e]&&(f=!0),f},d.srdError=function(b){return function(c){j.warn("Error when set remote description: "+c),g.invokeCallError(b,a.ERRORCODE.PEERCONNECTION_ERROR,c)}},d.modifyFirefoxSdpFromME=function(a,b){if(a.callConfig.dataChannelConfig&&navigator.mozGetUserMedia){var c="a=rtcp:",d=-1,e="a=sctp",f=-1,g="a=msid-semantic:",h=-1;if(d=b.indexOf(c),d>-1){for(var i=d+7;"\n"!=b.charAt(i);i++);b=b.substring(0,d-1)+b.substring(i)}f=b.indexOf(e),-1==f&&(b+="a=sctp-port:5000\r\n"),h=b.indexOf(g),-1==h&&(b+="a=msid-semantic:WMS *")}return b},a.CallConfig=m,a.Call=n,a.CallPackage=l,console.log("wsc-call initialized."),a}(wsc||{});
/*! wsc Built on: 2020-09-03 */
var wsc=function(a){"use strict";var b=a._private=a._private||{},c=b.wscConst,d=b.wscUtils,e=b.sessionHelper,f=a.getLogger(),g=function(a){if(!a){var b="The session parameter cannot be null!";throw f.error(b),b}this.packageType=c.PACKAGE.MESSAGE_NOTIFICATION,a.registerPackage(this),this.session=a,this.subscriptionMap=a.getSubSessionsByPackageType(c.PACKAGE.MESSAGE_NOTIFICATION),this.putSubscription=function(a,b){null!==a&&null!==b&&this.subscriptionMap.put(a,b)},this.setExpiryValue=function(a,b){a.expiry=b},this.removeSubscriptionBysubsessionId=function(a){this.subscriptionMap.remove(a)},this.getSubscriptionByKey=function(a){return this.subscriptionMap.get(a)},this.getSubscriptions=function(){var a=[],b=null;if(this.subscriptionMap){b=this.subscriptionMap.values();for(var c=0;c<b.length;c++)a[c]=b[c]}return a},this.onRehydration=function(a){for(var b in a.entry){var c=a.entry[b],d=new h(c.target,c.subscriber);this.setExpiryValue(d,c.expiry),d.valid=c.valid,d.subSessionId=c.subSessionId,d.session=this.session,d.setLatestMsgNotify(new j(c.latestNotification)),this.putSubscription(b,d),this.onResurrect&&this.onResurrect(d)}},this.onResurrect=null,this.toJSON=function(){var a={session:""};return d.toJSON(a,this)}};g.prototype={createNewSubscription:function(a,b,c,d,e,g,i){var j=new h(a,b,c,d,e,g);return j.session=this.session,f.debug("Start subscription executed!"),j.subscribe(i),this.putSubscription(j.subSessionId,j),j},onMessage:function(a){var b=(this.session,a.header.action),g=a.control.type,h=a.control.subsession_id,k=this.getSubscriptionByKey(h);if(null===k)return void f.warn("No Subscription object is created, so do nothing when receives message.");if("response"===g&&b===c.ACTION.START)k.extHeaders&&delete k.extHeaders,this.setExpiryValue(k,a.header.expiry),k.onSuccess(k.target);else if("error"===g&&b===c.ACTION.START){f.debug("Subscription error. The error code is: "+a.header.error_code);var l=a.header.reason,m=a.header.error_code,n=new d.ErrorInfo(m,l);if(m===c.ERRORCODE.UNAUTHORIZED||m===c.ERRORCODE.PROXYAUTH_REQUIRED){var o=this,p=function(a){k.authInfo=a,k.subscribe()},q=function(a){a&&(l=l+"--"+a),f.warn("Start subscription failed: "+l),n=new d.ErrorInfo(m,l),k.onError&&k.onError(n),o.removeSubscriptionBysubsessionId(k.subSessionId)};e.handleAuthenticateChallenge(this.session,a,p,q)}else k.onError&&k.onError(n)}else if("message"===g&&b===c.ACTION.SHUTDOWN)f.debug("Subscription end received from server."),k.valid=!1,this.removeSubscriptionBysubsessionId(k.subSessionId),k.subSessionId=null,k.onEnd();else if("message"===g&&b===c.ACTION.NOTIFY){var r,s=a.payload;f.debug("Message notification received, payload: "+JSON.stringify(s)),r=s.messages_waiting?new j(a.header.initiator,a.header.target,s):new i(a.header.initiator,a.header.target,s),k.valid!==!0&&(k.valid=!0),k.setLatestMsgNotify(r),k.onNotification(r)}this.session.saveToStorage()}};var h=function(a,b,e,g,h,i){this.session=null,this.target=a,this.subscriber=b,this.subSessionId=null,this.latestNotification=null,this.getNotifier=function(){return this.target},this.getSubscriber=function(){return this.subscriber},this.onSuccess=function(a){f.debug("Calling 'Subscription.onSuccess' of the subscription for:"+a),this.valid=!0,e&&e(a)},this.onError=g,this.onNotification=h,this.onEnd=i,this.valid=!1,this.setLatestMsgNotify=function(a){this.latestNotification=a},this.subscribe=function(b){var e=this.session.genNewCorrelationId(),f=this.session.lastServerSequence;this.correlationId=e,null==this.subSessionId&&(this.subSessionId=c.CONSTCS.CLIENT+(this.session.getLastOutboundSeq()+1));var g=new d.Message;g.control.type=c.TYPE.REQUEST,g.control.subsession_id=this.subSessionId,g.control.correlation_id=e,g.control.ack_sequence=f,g.control.package_type=c.PACKAGE.MESSAGE_NOTIFICATION,g.header.initiator=this.session.userName,g.header.target=a,g.header.action=c.ACTION.START,b&&g.addExtHeaders(b),this.authInfo&&(g.header.authorization=this.authInfo,this.authInfo=null),this.session.sendMessage(g)}};h.prototype={toJSON:function(){var a={session:""};return d.toJSON(a,this)},end:function(a){f.info("Subscription is ended by user");var b=new d.Message;b.control.type=c.TYPE.MESSAGE,b.control.subsession_id=this.subSessionId,b.control.correlation_id=this.correlationId,b.control.ack_sequence=this.session.lastServerSequence,b.control.package_type=c.PACKAGE.MESSAGE_NOTIFICATION,b.header.initiator=this.session.userName,b.header.target=this.target,b.header.action=c.ACTION.SHUTDOWN,a&&b.addExtHeaders(a),this.session.removeSubSession(this.subSessionId),this.session.sendMessage(b),this.valid=!1},isValid:function(){return this.valid}};var i=function(a,b,c){this.sender=a,this.receiver=b,this.msgContent=c,1==arguments.length&&(this.sender=arguments[0].sender,this.receiver=arguments[0].receiver,this.msgContent=arguments[0].msgContent),this.setSender=function(a){this.sender=a},this.setReceiver=function(a){this.receiver=a},this.setContent=function(a){this.msgContent=a},this.getSender=function(){return this.sender},this.getReceiver=function(){return this.receiver},this.getContent=function(){return this.msgContent}};i.prototype={getSender:function(){return this.getSender()},getReceiver:function(){return this.getReceiver()},getContent:function(){return this.getContent()}};var j=function(){j.superclass.constructor.apply(this,arguments)};d.extend(j,i),j.prototype={getMessageCounts:function(a){var b=this.msgContent[a];return null==b?(f.error("Failed to obtain message summary content. The parameter: "+a+" may be incorrect."),null):new k(b)},getMessageAccount:function(){return this.getContent().message_account},isMessageWaiting:function(){return"yes"===this.getContent().messages_waiting}};var k=function(a){var b,c,d,e;if(null!=a){var f=a,g=f.split("(");b=parseInt(g[0].split("/")[0]),c=parseInt(g[0].split("/")[1]),d=parseInt(g[1].split("/")[0]),e=parseInt(g[1].split("/")[1])}this.getNew=function(){return b},this.getOld=function(){return c},this.getUrgentNew=function(){return d},this.getUrgentOld=function(){return e}};return a.MessageAlertPackage=g,a.Subscription=h,a.Notification=i,a.MessageSummary=j,a.MessageCounts=k,console.log("wsc-msgalert initialized."),a}(wsc||{});
/*! wsc Built on: 2020-09-03 */
var wsc=function(a){var b=a._private=a._private||{};a.getLogger();return b.FileProps=function(){this.name="",this.size=0,this.type="",this.hashes={},this.fileTransferId="",this.disposition="",this.description="",this.creationTime="",this.modificationTime="",this.readTime="",this.icon="",this.startOffset="",this.stopOffset="",this.direction=""},a}(wsc||{}),wsc=function(a){"use strict";function b(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")}var c=a._private=a._private||{},d="\r\n",e="-------";return c.MsrpMessage=function(){this.messageId=null,this.transactionId=null,this.toPath=[],this.fromPath=[],this.headers={},this.flag=c.MsrpMessage.Flag.END},c.MsrpMessage.Flag={CONTINUE:"+",END:"$",ABORT:"#"},c.MsrpMessage.Status={OK:200,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,TIMEOUT:408,STOP_SENDING:413,UNKNOWN_MEDIA:415,OUT_OF_BOUNDS:423,SESSION_NOT_EXIST:481,UNKNOWN_METHOD:501,WRONG_CONNECTION:506},c.MsrpMessage.Reason={200:"OK",400:"Bad Request",401:"Unauthorized",403:"Forbidden",408:"Request Timeout",413:"Stop Sending Message",415:"Unsupported Media Type",423:"Interval Out-of-Bounds",481:"Session Does Not Exist",501:"Not Implemented",506:"Wrong Connection"},c.MsrpMessage.ByteRange=function(){this.start=null,this.end=null,this.total=null,this.init=function(a,b,c){this.start=a,this.end=b,this.total=c},this.build=function(){var a="";return this.start&&(a=a.concat(this.start,"-",this.end,"/",this.total)),a},this.parse=function(a){if(a){var c=a.split("-");this.start=b(c[0]),c=c[1].split("/"),this.end=b(c[0]),this.total=b(c[1])}}},c.MsrpMessage.generateId=function(a){var b="",c=8;return"number"==typeof a&&a>0&&(c=a),b=window.crypto.getRandomValues(new Uint32Array(1))[0].toString(36)},c.MsrpMessage.createIndication=function(a,b,d){var e="",f=0,g=null,h=null;return h=new c.MsrpRequest("SEND",c.MsrpMessage.generateId(),a,b,!0),e=e.concat('<?xml version="1.0" encoding="UTF-8"?>',"\r\n"),e=e.concat('<isComposing xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="urn:ietf:params:xml:ns:im-iscomposing">',"\r\n"),d?(e=e.concat("  <state>active</state>","\r\n"),e=e.concat("  <refresh>60</refresh>","\r\n")):e=e.concat("  <state>idle</state>","\r\n"),e=e.concat("  <contenttype>text/plain</contenttype>","\r\n"),e=e.concat("</isComposing>","\r\n"),g=new c.MsrpMessage.ByteRange,f=new Blob([e]).size,g.init(1,f,f),h.setByteRange(g),h.setTextContent(e),h},c.MsrpMessage.splitArrayBufferData=function(a){var b,c,d,e,f,g,h,i=new Uint8Array(a),j=i.length,k=a.contentEndIdx;for(b=0;j-1>b;b++){if(13==i[b]&&10==i[b+1]){e=b+2;break}c=(c||"").concat(String.fromCharCode(i[b]))}for(b=e;j-1>b;b++){if(13==i[b]&&10==i[b+1]&&13==i[b+2]&&10==i[b+3]){f=b+4,g=i.subarray(f,k);break}d=(d||"").concat(String.fromCharCode(i[b]))}if(!g){var l=d.length-(j-k)+2;d=d.substring(0,l)}j>=3&&(h=String.fromCharCode(i[j-3]));var m={startLine:c,header:d,content:g,flag:h};return m},c.MsrpMessage.splitStringData=function(a){var b,c,d,e,f,g,h,i=a.lastIndexOf("\r\n"),j=String.fromCharCode(a.charAt(a.length-3));for(b=0;i>b;b++)if("\r"==a.charAt(b)&&"\n"==a.charAt(b+1)){c=a.substring(0,b),e=b+2;break}for(b=e;i>b;b++)if(13==a.charAt(b)&&10==a.charAt(b+1)&&13==a.charAt(b+2)&&10==a.charAt(b+3)){d=a.substring(e,b),f=b+4;break}for(var b=i-1;b>=0;b--)if(10==a.charAt(b)&&13==a.charAt(b-1)){g=b-1;break}d?h=a.substring(f,f):d=a.substring(e,f);var k={startLine:c,header:d,content:h,flag:j};return k},c.MsrpMessage.parseMessage=function(a){var d,e,f=null,g=null,h=null,i=null;if(a instanceof ArrayBuffer)e=c.MsrpMessage.splitArrayBufferData(a);else{if(!(a instanceof String||"string"==typeof a))return null;e=c.MsrpMessage.splitStringData(a)}if(e.startLine&&e.header&&e.flag){var j=e.startLine,k=j.split(" ");if(k.length>=3&&"MSRP"==k[0]){f=k[1],(d=parseInt(k[2]))?(i=new c.MsrpResponse(f,d,[],[],!1),k.length>3&&(i.reason=k.slice(3).join(" "))):(g=k[2],i=new c.MsrpRequest(g,h,[],[],!1),i.transactionId=f);for(var l=e.header.split("\r\n"),m=0;m<l.length;m++){var n=l[m].indexOf(":");if(n>-1){var o=b(l[m].substring(0,n)),p=b(l[m].substring(n+1));i.addHeader(o,p)}}i.content=e.content,i.flag=e.flag}}return i},c.MsrpMessage.prototype.getEndLine=function(){return this.getEndLineNoFlag()+this.flag+d},c.MsrpMessage.prototype.getEndLineNoFlag=function(){return e+this.transactionId},c.MsrpMessage.prototype.addHeader=function(a,b){switch(a){case"To-Path":return void(this.toPath=b.split(" "));case"From-Path":return void(this.fromPath=b.split(" "));case"Content-Type":return void(this.contentType=b);case"Byte-Range":return void this.setByteRange(b);case"Message-ID":return void(this.messageId=b);case"Status":var c=b.split(" ");this.reportStatus=parseInt(c[1]),this.reportReason=c.slice(2).join(" ")}this.headers[a]?this.headers[a].push(b):this.headers[a]=[b]},c.MsrpMessage.prototype.getHeader=function(a){var b=null;return a in this.headers&&(b=this.headers[a].length>1?this.headers[a]:this.headers[a][0]),b},c.MsrpMessage.prototype.setContent=function(a,b){this.content=a,this.contentType=b},c.MsrpMessage.prototype.setTextContent=function(a){this.setContent(a,"text/plain")},c.MsrpMessage.prototype.setByteRange=function(a){a instanceof c.MsrpMessage.ByteRange?this.byteRange=a:(a instanceof String||"string"==typeof a)&&(this.byteRange=new c.MsrpMessage.ByteRange,this.byteRange.parse(a))},c.MsrpRequest=function(a,b,d,e,f){this.method=a,this.messageId=b,this.fromPath=d,this.toPath=e,this.byteRange=null,this.flag=c.MsrpMessage.Flag.END,f?this.transactionId=c.MsrpMessage.generateId(5):this.transactionId=null,this.content=null,this.contentType=null,this.isCancelled=!1,this.isEnd=!1,this.reportStatus=c.MsrpMessage.Status.OK,this.reportReason=null,this.headers=[]},c.MsrpRequest.prototype=new c.MsrpMessage,c.MsrpRequest.prototype.setEnd=function(a){this.isEnd=a,a?this.flag=c.MsrpMessage.Flag.END:this.flag=c.MsrpMessage.Flag.CONTINUE},c.MsrpRequest.prototype.setCancelled=function(a){this.isCancelled=a,a&&(this.flag=c.MsrpMessage.Flag.ABORT)},c.MsrpRequest.prototype.build=function(){var a="";a=a.concat("MSRP ",this.transactionId," ",this.method,d),a=a.concat("To-Path: ",this.toPath.join(" "),d),a=a.concat("From-Path: ",this.fromPath.join(" "),d),this.messageId&&(a=a.concat("Message-ID: ",this.messageId,d)),this.byteRange&&(a=a.concat("Byte-Range: ",this.byteRange.build(),d));for(var b in this.headers)a=a.concat(b,": ",this.headers[b].join(" "),d);return this.contentType&&this.content?(a=a.concat("Content-Type: ",this.contentType,d),a+=d,a=this.content instanceof String||"string"==typeof this.content?a.concat(this.content,d,this.getEndLine()):new Blob([a,this.content,d,this.getEndLine()])):a+=this.getEndLine(),a},c.MsrpResponse=function(a,b,d,e,f){this.transactionId=a,this.status=b,this.fromPath=d,this.toPath=e,this.byteRange=null,this.isOutgoing=f,this.reason=c.MsrpMessage.Reason[b]||"Unkown Error",this.request=null,this.headers=[]},c.MsrpResponse.prototype=new c.MsrpMessage,c.MsrpResponse.prototype.build=function(){var a,b="";b=b.concat("MSRP ",this.transactionId," ",this.status," ",this.reason,d),b=b.concat("To-Path: ",this.toPath.join(" "),d),b=b.concat("From-Path: ",this.fromPath.join(" "),d),this.byteRange&&(b=b.concat("Byte-Range: ",this.byteRange.build(),d));for(a in this.headers)b=b.concat(a,": ",this.headers[a].join(" "),d);return b+=this.getEndLine()},a}(wsc||{}),wsc=function(a){function b(a){var b=null;if(a instanceof String||"string"==typeof a)b=(new d.SDP).parse(a);else{if(!(a instanceof d.SDP))throw{name:"Error",message:"The given offer is invalid."};b=a}return b}function c(a){var b=new d.SDP;return b.origin.username=a.originUsername,b.origin.sessId=d.MsrpPeerConnection.Util.generateId(),b.origin.sessVersion=b.origin.sessId,b}var d=a._private=a._private||{},e=a.getLogger();return d.MsrpPeerConnection=function(){this.secure=!0,this.originUsername="-",this.acceptTypes=["text/plain"],this.acceptWrappedTypes=[],this.onSession=null,this.localDescription=null,this.remoteDescription=null,this._localUris=[],this._host="wscAddress.invalid",this._port=2855,this.remoteUri=null,this.fileConfigArray=null,this.ftIdToSessions={},this.wsPath=null},d.MsrpPeerConnection.prototype.createOffer=function(a){var b,c,e;return b=new d.SDP,b.origin.username=this.originUsername,b.origin.sessId=d.MsrpPeerConnection.Util.generateId(),b.origin.sessVersion=b.origin.sessId,c=new d.SDP.Media(this.secure),c.port=this._port,d.MsrpPeerConnection.Util.addConfigToMedia(c,a),e=this.generateMsrpUri(),this._localUris=[],this._localUris.push(e),c.addAttribute("path",e),b.mediaArray.push(c),this.localDescription={type:"offer",sdp:b},b.toString()},d.MsrpPeerConnection.prototype.acceptOffer=function(a,e){var f,g,h,i,j,k,l,m;for(f=b(a),this.remoteDescription={type:"offer",sdp:f},g=c(this),h=f.mediaArray,this._localUris=[],i=0;i<h.length;i++)j=h[i],this.secure="TCP/TLS/MSRP"===j.proto,this.remoteUri=(new d.MsrpUri).parse(j.getAttribute("path")[0].split(" ")[0]),k=new d.SDP.Media(this.secure),e&&d.MsrpPeerConnection.Util.addConfigToMedia(k,e),m=this.generateMsrpUri(),this._localUris[i]=m,k.addAttribute("path",m),"message"===j.media&&0!==j.port&&j.hasAttribute("path")&&j.hasAttribute("accept-types")?(k.port=this._port,this.wsPath=j.getAttribute("ws-resource-path")[0],l=k.getAttribute("accept-types")[0].split(" "),this.createSession(l,i,!1)):this.onSession({session:null,info:{mediaIdx:i,reason:"port is 0, or invalid media description"}}),g.mediaArray.push(k);return this.localDescription={type:"answer",sdp:g},g.toString()},d.MsrpPeerConnection.prototype.createSession=function(a,b,c,f,g,h,i){var j,k,l,m=this.remoteUri,n=this.secure?"wss://":"ws://";if(j=n+m.host+(m.port?":"+m.port:"")+this.wsPath,k="msrp",e.debug("Create a websocket to: "+j),l=new WebSocket(j,k)){var o=new d.MsrpSession(l,this,a,c,g,f,this._localUris[b],h,i);this.onSession(o)}},d.MsrpPeerConnection.prototype.processAnswer=function(a){var c,e,f,g,h;for(c=b(a),this.remoteDescription={type:"answer",sdp:c},e=c.mediaArray,f=0;f<e.length;f++)g=e[f],this.remoteUri=(new d.MsrpUri).parse(g.getAttribute("path")[0].split(" ")[0]),"message"===g.media&&0!==g.port&&g.hasAttribute("path")&&g.hasAttribute("accept-types")?(this.wsPath=g.getAttribute("ws-resource-path")[0],h=g.getAttribute("accept-types")[0].split(" "),this.createSession(h,f,!0)):this.onSession({session:null,info:{mediaIdx:f,reason:"port is 0, or invalid media description"}})},d.MsrpPeerConnection.prototype.createFtOffer=function(a){var b,c,e,f,g,h,i,j,k;for(this.fileConfigArray=a,b=new d.SDP,b.origin.username=this.originUsername,b.origin.sessId=d.MsrpPeerConnection.Util.generateId(),b.origin.sessVersion=b.origin.sessId,g=0;g<a.length;g++)if(h=a[g].props,i=a[g].file,h||i instanceof File){h=h||new d.FileProps,c=new d.SDP.Media(this.secure),c.port=this._port,e=this.acceptTypes.join(" "),c.addAttribute("accept-types",e),this.acceptWrappedTypes&&this.acceptWrappedTypes.length>0&&(f=this.acceptWrappedTypes.join(" "),c.addAttribute("accept-wrapped-types",f)),k=this.generateMsrpUri(),this._localUris[g]=k,c.addAttribute("path",k),i instanceof File&&(h.name||(h.name=i.name),h.size||(h.size=i.size),h.type||(h.type=i.type));do j=d.MsrpPeerConnection.Util.generateId()+d.MsrpPeerConnection.Util.generateSessionID()+d.MsrpPeerConnection.Util.generateSessionID()+d.MsrpPeerConnection.Util.generateSessionID(),h.fileTransferId=j.slice(2,34);while(this.ftIdToSessions[h.fileTransferId]);c.setFileProps(h),this.fileConfigArray[g].props=h,b.mediaArray.push(c)}return this.localDescription={type:"offer",sdp:b},b.toString()},d.MsrpPeerConnection.prototype.acceptFtOffer=function(a,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;for(f=b(a),this.remoteDescription={type:"offer",sdp:f},g=c(this),h=f.mediaArray,i=0;i<h.length;i++){for(k=h[i],this.secure="TCP/TLS/MSRP"===k.proto,l=new d.SDP.Media(this.secure),m=k.getAttribute("accept-types"),j=0;j<m.length;j++)l.addAttribute("accept-types",m[j]);for(m=k.getAttribute("accept-wrapped-types"),j=0;j<m.length;j++)l.addAttribute("accept-wrapped-types",m[j]);if(u=this.generateMsrpUri(),this._localUris[i]=u,l.addAttribute("path",u),o=k.hasAttribute("recvonly"),this.remoteUri=(new d.MsrpUri).parse(k.getAttribute("path")[0].split(" ")[0]),q=k.getFileProps(),o&&!e)throw{name:"IllegalArgumentException",filsTransferId:q.fileTransferId,message:"parameter fileConfig is required."};if(e&&!e[i]||o&&!(e&&e[i].file instanceof File)||"message"!==k.media||!k.hasAttribute("path")||!k.hasAttribute("accept-types"))throw{name:"IllegalArgumentException",filsTransferId:q.fileTransferId,message:"Illegal argument fileConfig or incorrect offer media."};s=e&&e[i]&&e[i].props||new d.FileProps,r=new d.FileProps,o?(r.hashes=s.hashes,r.fileTransferId=q.fileTransferId,r.startOffset=q.startOffset,r.stopOffset=q.stopOffset,r.type=s.type,r.icon=s.icon,r.disposition=s.disposition,r.name=s.name||e[i].file.name,r.size=s.size||e[i].file.size):(r=q,r.icon="",r.disposition="",r.creationTime="",r.modificationTime="",r.readTime=""),r.direction=o?"send":"receive",l.setFileProps(r),n=q.fileTransferId,0===k.port?(l.port=0,this.ftIdToSessions[n]?this.ftIdToSessions[n].cancel():this.onSession({session:null,info:{mediaIdx:i,reason:"port is 0"}})):(l.port=this._port,this.ftIdToSessions[n]||(p=o&&e&&e[i].file?e[i].file:null,this.wsPath=k.getAttribute("ws-resource-path")[0],t=l.getAttribute("accept-types")[0].split(" "),this.createSession(t,i,!1,n,p,q,r))),g.mediaArray.push(l)}return this.localDescription={type:"answer",sdp:g},g.toString()},d.MsrpPeerConnection.prototype.processFtAnswer=function(a){var c,f,g,h,i,j,k,l=null;for(c=b(a),this.remoteDescription={type:"answer",sdp:c},f=c.mediaArray,g=0;g<f.length;g++)h=f[g],this.remoteUri=(new d.MsrpUri).parse(h.getAttribute("path")[0].split(" ")[0]),k=(h.getFileProps()||this.fileConfigArray[g].props).fileTransferId,"message"===h.media&&h.hasAttribute("path")&&h.hasAttribute("accept-types")&&(0===h.port?this.ftIdToSessions[k]||(e.info(this.fileConfigArray[g].props.name+": "+this.fileConfigArray[g].props.fileTransferId+" sending request is rejected."),this.onSession({session:null,info:{mediaIdx:g,reason:"port is 0, or invalid media description"}})):this.ftIdToSessions[k]||(j=h.hasAttribute("recvonly"),this.fileConfigArray&&this.fileConfigArray[g]&&(l=this.fileConfigArray[g].file),this.wsPath=h.getAttribute("ws-resource-path")[0],i=h.getAttribute("accept-types")[0].split(" "),this.createSession(i,g,!0,k,l,this.fileConfigArray[g].props,h.getFileProps())))},d.MsrpPeerConnection.prototype.abortFt=function(a){if(this.localDescription&&this.localDescription.sdp){for(var b=this.localDescription.sdp,c=b.mediaArray,d=0,e=c.length;e>d;d++){var f=c[d],g=f.getFileProps().fileTransferId;-1!==a.indexOf(g)&&(f.port=0,this.ftIdToSessions[g].cancel())}return this.localDescription.type="offer",b.toString()}return null},d.MsrpPeerConnection.prototype.generateMsrpUri=function(){var a=new d.MsrpUri;return a.scheme=this.secure?"msrps":"msrp",a.host=this._host,a.port=this._port,a.sessionId=d.MsrpPeerConnection.Util.generateSessionID(),a.transport="ws",a},d.MsrpPeerConnection.Util={generateId:function(){return(new Date).getTime()},generateSessionID:function(){return window.crypto.getRandomValues(new Uint32Array(1))[0].toString(36)},addConfigToMedia:function(a,b){if(b){if(b.acceptTypes){if(!(b.acceptTypes instanceof Array))throw{message:"Invalid argument.",description:"chatConfig.acceptTypes"};var c=b.acceptTypes.join(" ");a.addAttribute("accept-types",c)}if(b.acceptWrappedTypes){if(!(b.acceptWrappedTypes instanceof Array))throw{message:"Invalid argument.",description:"chatConfig.acceptWrappedTypes"};var d=b.acceptWrappedTypes.join(" ");a.addAttribute("accept-wrapped-types",d)}b.selfMaxSize&&a.addAttribute("max-size",b.selfMaxSize)}else a.addAttribute("accept-types","text/plain")},encode:function(a){return a.replace(/%/g,"%25").replace(/\0/g,"%00").replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},decode:function(a){return a.replace(/%00/g,"\x00").replace(/%0A/gi,"\n").replace(/%0D/gi,"\r").replace(/%22/g,'"').replace(/%25/g,"%")},leftTrim:function(a){return a="".trimLeft?a.trimLeft():a.replace(/^\s+/,"")}},a}(wsc||{}),wsc=function(a){"use strict";function b(a,b,c){var d=new Uint8Array(a),e=new Uint8Array(c),f=[];if(c.byteLength<=a.byteLength-b)d.set(e,b),f.push(d.buffer);else{var g=c.slice(0,a.byteLength-b),h=c.slice(a.byteLength-b);c=h,d.set(new Uint8Array(g),b),f.push(d.buffer),f.push(h)}return f}var c=a._private=a._private||{};c.wscUtils=c.wscUtils||{},a.getLogger();return c.MsrpReceiver=function(a){this.session=a,this.contentType=null,this.totalSize=0,this.currentChunk=null,this.nextStartIndex=1,this.byteRangeList=[],this.cachedChunks={},this.cachedChunksArray=[],this.cachedChunksNum=2,this.dataBuffer=[],this.textMessage="",this.canceled=!1,this.maxCacheSize=16,this.getMessageCallback=null,this.getByteContentCallback=null,this.wholeMessageReceived=null,this.onReceiveProgress=null},c.MsrpReceiver.prototype.cancel=function(){return this.currentChunk?void("no"!==this.currentChunk.getHeader("Failure-Report")&&(this.canceled=!0,this.dataBuffer=[],this.currentChunk=null)):null},c.MsrpReceiver.prototype.onReceived=function(a){var b=null,d=a.byteRange;if(null==this.contentType&&(this.contentType=a.contentType,null!=d&&(this.totalSize=parseInt(d.total))),this.currentChunk=a,this.byteRangeList.length>this.maxCacheSize)return void this.cancel();if(this.canceled&&a.flag!==c.MsrpMessage.Flag.ABORT)return b=new c.MsrpResponse(this.currentChunk.transactionId,c.MsrpMessage.Status.STOP_SENDING,this.currentChunk.toPath,this.currentChunk.fromPath,!0),void this.session.webSocket.send(b.build());if(b=new c.MsrpResponse(a.transactionId,c.MsrpMessage.Status.OK,a.toPath,a.fromPath,!0),a.byteRange)b.addHeader("Byte-Range",a.byteRange);else if(this.session.isFile()&&0==this.session.offerFileProps.size){var e=new c.MsrpMessage.ByteRange;e.parse("1-0/0"),b.addHeader("Byte-Range",e)}if(this.session.webSocket.send(b.build()),0===this.totalSize&&this.session.isFile()&&0==this.session.offerFileProps.size&&this.wholeMessageReceived(this.session.fileTransferId),0!==this.totalSize&&a.flag!==c.MsrpMessage.Flag.ABORT&&("*"===d.end&&(d.end=parseInt(d.start)+new Blob([a.content]).size-1),this.cachedChunks[d]=a,this.byteRangeList.push(d),this.byteRangeList.sort(function(a,b){return parseInt(a.start)-parseInt(b.start)}),this.processIncomingChunk(),!this.session.isFile()&&this.nextStartIndex>this.totalSize)){if(0===this.textMessage.length&&this.dataBuffer.length>0){var f=String.fromCharCode.apply(null,this.dataBuffer);this.textMessage=decodeURIComponent(encodeURI(f))}this.getMessageCallback&&this.textMessage.length>0&&this.getMessageCallback({contentType:this.contentType,content:this.textMessage})}},c.MsrpReceiver.prototype.processIncomingChunk=function(){function a(a){if(a.content instanceof String||"string"==typeof a.content?i.session.isFile()?e=a.content:(i.textMessage=i.textMessage.concat(a.content),e=null):e=a.content,!i.session.isFile()&&e)for(var b=0;b<e.length;b++)i.dataBuffer.push(e[b]);else i.getByteContentCallback&&i.getByteContentCallback({fileTransferId:i.session.fileTransferId,range:{start:a.byteRange.start,end:a.byteRange.end,total:a.byteRange.total},content:e}),i.onReceiveProgress&&i.onReceiveProgress({fileTransferId:i.session.fileTransferId,range:{start:a.byteRange.start,end:a.byteRange.end,total:a.byteRange.total}});a.flag===c.MsrpMessage.Flag.END&&i.wholeMessageReceived&&(i.session.fileTransferId?i.wholeMessageReceived(i.session.fileTransferId):i.wholeMessageReceived(a.messageId))}var d=null,e=null,f=null,g=0,h=[],i=this;for(g=0;g<this.byteRangeList.length;g++)if(f=this.byteRangeList[g],d=this.cachedChunks[f],parseInt(f.start)>this.nextStartIndex)h.push(f);else if(parseInt(f.start)<this.nextStartIndex){var j=this.cachedChunksArray.length;if(0===j)this.cachedChunksArray.push(d);else{for(var k in this.cachedChunksArray){var l=this.cachedChunksArray[k],m=this.cachedChunksArray[k].byteRange.start,n=this.cachedChunksArray[k].byteRange.end;if(parseInt(f.start)>=m&&parseInt(f.start)<=n)if(parseInt(f.end)<=n){var o=b(l.content,parseInt(f.start)-m,d.content);o[0]&&(l.content=o[0]),d=null}else if(parseInt(f.end)>n){var o=b(l.content,parseInt(f.start)-m,d.content);o[0]&&(l.content=o[0]),o[1]&&(d.content=o[1]),d.byteRange.start=n+1}}d&&(this.cachedChunksArray.push(d),this.nextStartIndex=parseInt(d.byteRange.end)+1),this.cachedChunksArray.length>this.cachedChunksNum&&a(this.cachedChunksArray.shift())}delete this.cachedChunks[f]}else d=this.cachedChunks[f],d&&(this.cachedChunksArray.push(d),this.nextStartIndex=parseInt(d.byteRange.end)+1),this.cachedChunksArray.length>this.cachedChunksNum&&a(this.cachedChunksArray.shift()),delete this.cachedChunks[f];if(this.nextStartIndex>this.totalSize)for(;0!==this.cachedChunksArray.length;)a(this.cachedChunksArray.shift());this.byteRangeList=h},a}(wsc||{}),wsc=function(a){function b(a){for(var b=0;b<this.attributes.length;b++)if(this.attributes[b].n===a)return!0;return!1}function c(a){for(var b=[],c=0;c<this.attributes.length;c++)this.attributes[c].n===a&&b.push(this.attributes[c].v);return b}var d=a._private=a._private||{},e=a.getLogger(),f="\r\n";return d.SDP=function(){this.version=0,this.origin=new d.SDP.Origin,this.sessionName=" ",this.sessionInfo=null,this.uri=null,this.email=null,this.phone=null,this.connectionData=new d.SDP.ConnectionData,this.bandwidth=[],this.timeDesp="t=0 0",this.timeZones=null,this.encryptionKeys=null,this.attributes=[],this.mediaArray=[]},d.SDP.prototype.addAttribute=function(a,b){this.attributes.push({n:a,v:b})},d.SDP.prototype.hasAttribute=b,d.SDP.prototype.getAttribute=c,d.SDP.prototype.parse=function(a){var b,c,g,h,i,j,k;if(c=a.split(f),""===c[c.length-1]&&c.pop(),c.length<4)return e.error("Invalid SDP lines number: "+c.length),null;if(b=c.shift(),"v=0"!==b)return e.error("Invalid SDP version: "+b),null;if(b=c.shift(),"o="!==b.slice(0,2)&&(this.origin=(new d.SDP.Origin).parse(b.slice(2)),!this.origin))return e.error("Invalid SDP origin: "+b),null;if(b=c.shift(),"s="!==b.slice(0,2))return e.error("A session name line is expected, but get: "+b),null;for(this.sessionName=b.slice(2);c.length>0&&"t"!==c[0].charAt(0);)b=c.shift(),g=b.slice(0,2),h=b.slice(2),"i="===g?this.sessionInfo=h:"u="===g?this.uri=h:"e="===g?this.email=h:"p="===g?this.phone=h:"c="===g?this.connectionData=(new d.SDP.ConnectionData).parse(h):"b="===g?this.bandwidth.push(h):e.error("Unknown SDP line before time description: "+b);if(0===c.length)return e.error("Invalid SDP: end of SDP before time description"),null;for(this.timeDesp="";c.length>0&&"t"===c[0].charAt(0);)for(b=c.shift(),this.timeDesp=this.timeDesp+b+f;c.length>0&&"r"===c[0].charAt(0);)b=c.shift(),this.timeDesp=this.timeDesp+b+f;for(;c.length>0&&"m"!==c[0].charAt(0);)b=lines.shift(),g=b.slice(0,2),h=b.slice(2),"z="===g?this.timeZones=h:"k="===g?this.key=h:"a="===g?(i=h.split(":"),this.addAttribute(i[0],i[1])):e.error("Unknown SDP line before media description: "+b);for(;c.length>0&&"m"===c[0].charAt(0);){for(j="",b=c.shift(),j=b.slice(2);c.length>0&&"m"!==c[0].charAt(0);)b=c.shift(),j=j+f+b;k=(new d.SDP.Media).parse(j),k&&this.mediaArray.push(k)}return this},d.SDP.prototype.toString=function(){var a,b,c,d,e,g="";g=g+"v="+this.version+f,g=g+"o="+this.origin+f,g=g+"s="+this.sessionName+f,this.sessionInfo&&(g=g+"i="+this.sessionInfo+f),this.uri&&(g=g+"u="+this.uri+f),this.email&&(g=g+"e="+this.email+f),this.phone&&(g=g+"p="+this.phone+f),this.connectionData&&(g=g+"c="+this.connectionData+f);for(a in this.bandwidth)g=g+"b="+this.bandwidth[a]+f;for(g=g+this.timeDesp+f,this.timeZones&&(g=g+"z="+this.timeZones+f),this.key&&(g=g+"k="+this.key+f),e=this.attributes.length,d=0;e>d;d++)b=this.attributes[d].n,c=this.attributes[d].v,g=g+"a="+b,c&&(g=g+":"+c),g+=f;for(e=this.mediaArray.length,d=0;e>d;d++)g=g+"m="+this.mediaArray[d]+f;return g},d.SDP.Origin=function(){this.username="-",this.sessId=null,this.sessVersion=null,this.netType="IN",this.addrType="IP4",this.unicastAddr="wscAddress.invalid"},d.SDP.Origin.prototype.parse=function(a){var b=a.split(" ");return 6!==b.length?(e.error("Invalid o line: "+a),null):(this.username=b[0],this.sessId=b[1],this.version=b[2],this.netType=b[3],this.addrType=b[4],this.unicastAddr=b[5],this)},d.SDP.Origin.prototype.toString=function(){var a="";return a=a+this.username+" ",a=a+this.sessId+" ",a=a+this.sessVersion+" ",a=a+this.netType+" ",a=a+this.addrType+" ",a+=this.unicastAddr},d.SDP.ConnectionData=function(){this.netType="IN",this.addrType="IP4",this.connectionAddr="wscAddress.invalid"},d.SDP.ConnectionData.prototype.parse=function(a){var b=a.split(" ");return 3!==b.length?(e.error("Invalid c line: "+a),null):(this.netType=b[0],this.addrType=b[1],this.connectionAddr=b[2],this)},d.SDP.ConnectionData.prototype.toString=function(a){var b="";return b=b+this.netType+" ",b=b+this.addrType+" ",b+=this.connectionAddr},d.SDP.Media=function(a){this.media="message",this.port=2855,this.proto="TCP/MSRP",a&&(this.proto="TCP/TLS/MSRP"),this.fmt=["*"],this.title=null,this.connectionData=null,this.bandwidth=[],this.key=null,this.attributes=[]},d.SDP.Media.prototype.addAttribute=function(a,b){this.attributes.push({n:a,v:b})},d.SDP.Media.prototype.hasAttribute=b,d.SDP.Media.prototype.getAttribute=c,d.SDP.Media.prototype.getSingleAttribute=function(a){var b=this.getAttribute(a),c=null;return b.length>0&&(c=b[0]),c},d.SDP.Media.prototype.getSingleAttributeList=function(a){var b,c=this.getAttribute(a),d=null;return c.length>0&&(b=c[0],d=b.split(" ")),d},d.SDP.Media.prototype.parse=function(a){var b,c,g,h,i,j,k,l;if(b=a.split(f),c=b.shift(),g=c.split(" "),g.length<4)return e.error("Invalid media line: "+c),null;for(this.media=g.shift(),this.port=parseInt(g.shift(),10),this.proto=g.shift(),this.fmt=g,i=b.length,h=0;i>h;h++)c=b[h],j=c.slice(0,2),k=c.slice(2),"i="===j?this.title=k:"c="===j?this.connectionData=(new d.SDP.ConnectionData).parse(k):"b="===j?this.bandwidth.push(k):"a="===j?(l=k.indexOf(":"),-1===l?this.addAttribute(k,null):this.addAttribute(k.slice(0,l),k.slice(l+1))):e.error("Unknown SDP line within a media description: "+c);return this},d.SDP.Media.prototype.toString=function(){var a,b,c,d,e="";for(e=e+this.media+" ",e=e+this.port+" ",e=e+this.proto+" ",e+=this.fmt.join(" "),this.title&&(e=e+f+"i="+this.title),this.connection&&(e=e+f+"c="+this.connection),a=this.bandwidth.length,b=0;a>b;b++)e=e+f+"b="+this.bandwidth[b];for(this.key&&(e=e+f+"k="+this.key),a=this.attributes.length,b=0;a>b;b++)c=this.attributes[b].n,d=this.attributes[b].v,e=e+f+"a="+c,d&&(e=e+":"+d);return e},d.SDP.Media.prototype.setFileProps=function(a){var b,c,e="",f=" ";if(a.name&&(e='name:"'+d.MsrpPeerConnection.Util.encode(a.name)+'"'),a.size&&(e=e+f+"size:"+a.size),a.type&&(e=e+f+"type:"+a.type),a.hashes)for(var g in a.hashes)e=e+f+"hash:"+g+":"+a.hashes[g];if(e=d.MsrpPeerConnection.Util.leftTrim(e),this.addAttribute("file-selector",e),a.fileTransferId){var h=a.fileTransferId;this.addAttribute("file-transfer-id",h)}(a.creationTime||a.modificationTime||a.readTime)&&(b="",a.creationTime&&(b=b+'creation:"'+a.creationTime+'" '),a.modificationTime&&(b=b+'modification:"'+a.modificationTime+'" '),a.readTime&&(b=b+'read:"'+a.readTime+'" '),b=b.slice(0,b.length-1),this.addAttribute("file-date",b)),a.disposition&&this.addAttribute("file-disposition",a.disposition),a.icon&&this.addAttribute("file-icon",a.icon),a.startOffset&&a.stopOffset&&(c=a.startOffset+"-"+a.stopOffset,this.addAttribute("file-range",c)),"receive"===a.direction?this.addAttribute("recvonly",null):this.addAttribute("sendonly",null),a.description&&(this.title=a.description)},d.SDP.Media.prototype.getFileProps=function(){var a,b,c,f,g,h,i,j,k,l,m,n,o=null,p=0;if(a=this.getAttribute("file-selector"),a.length>0&&(c=a[0]),c){if(o=new d.FileProps,a=this.getAttribute("file-transfer-id"),a.length>0&&(o.fileTransferId=a[0]),a=this.getAttribute("file-disposition"),a.length>0&&(o.disposition=a[0]),a=this.getAttribute("file-icon"),a.length>0&&(o.icon=a[0]),a=this.getAttribute("sendonly"),a.length>0&&(o.direction="send"),a=this.getAttribute("recvonly"),a.length>0&&(o.direction="receive"),this.title&&(o.description=this.title),b=this.getSingleAttribute("file-date"))for(l=b.length,p=0;l>p;){if(f=b.indexOf(":",p),-1===f){e.error("At least one colon is expected in file date attribute, but there is none.");break}if(h=b.slice(p,f).trim(),p=f+1,'"'!==b.charAt(p)){e.error("date-time is expected surrounded by double quote.");break}if(p+=1,f=b.indexOf('"',p),-1===f){e.error("date-time is expected surrounded by double quote.");break}if(i=b.slice(p,f),p=f+1,"creation"===h)o.creationTime=i;else if("modification"===h)o.modificationTime=i;else{if("read"!==h){e.error("Unknown file date param: "+h);continue}o.readTime=i}}for(b=this.getSingleAttribute("file-range"),b&&(p=0,f=b.indexOf("-"),-1===f?e.error('"-" is expected in file rage, but there is none.'):(o.startOffset=parseInt(b.slice(p,f).trim(),10),j=b.slice(f+1).trim(),"*"===j?o.stopOffset=j:o.stopOffset=parseInt(j,10))),l=c.length,p=0;l>p;)if(" "!==c.charAt(p)){if(f=c.indexOf(":",p),-1===f)break;if(h=c.slice(p,f),p=f+1,"type"===h){for(f=p,k=!1;(k||" "!==c.charAt(f))&&l>f;)'"'===c.charAt(f)&&(k=!k),f+=1;i=(new d.SDP.FileType).parse(c.slice(p,f)),o.type=i,p=f+1}else if("name"===h){if('"'!==c.charAt(p)){e.error("Start double quote is expected for value of filename-selector.");break}if(p+=1,f=c.indexOf('"',p),-1===f){e.error("End double quote is expected for value of filename-selector.");break}i=c.slice(p,f),o.name=d.MsrpPeerConnection.Util.decode(i),p=f+1}else f=c.indexOf(" ",p),-1===f&&(f=l),i=c.slice(p,f),"size"===h&&(o.size=parseInt(i,10)),"hash"===h&&(o.hashes=o.hashes||{},g=i.indexOf(":"),m=i.slice(0,g),n=i.slice(g+1),o.hashes[m]=n),p=f+1}else p+=1}return o},d.SDP.FileType=function(){this.type="",this.subType="",this.params={}},d.SDP.FileType.prototype.parse=function(a){var b,c,e,f=0;if(b=a.indexOf("/"),-1===b)return null;if(this.type=a.slice(f,b),f=b+1,b=a.indexOf(";"),-1===b)return this.subType=a.slice(f),this;for(this.subType=a.slice(f,b),f=b+1,this.params={};";"===a.charAt(b);){if(b=a.indexOf("=",f),-1===b)return this;if(c=a.slice(f,b),f=b+1,'"'!==a.charAt(f))return this;if(f+=1,b=a.indexOf('"',f),-1===b)return this;e=a.slice(f,b),e=d.MsrpPeerConnection.Util.decode(e),this.params[c]=e,b+=1,f=b+1}return this},d.SDP.FileType.prototype.toString=function(){var a,b,c="";c=c+this.type+"/"+this.subType;for(a in this.params)b=this.params[a],c=c+";"+a+'="'+b+'"';return c},a}(wsc||{}),wsc=function(a){"use strict";var b=a._private=a._private||{},c=a.getLogger();return b.MsrpSender=function(a,c){this.session=a,c?"string"==typeof c||c instanceof String?(this.content=new Blob([c]),this.contentType=a.contentType||"text/plain"):(this.content=new Blob([c]),this.content.size>0?this.contentType=a.contentType||"application/octet-stream":this.contentType=null):(this.content=new Blob,this.contentType=null),this.messageId=b.MsrpMessage.generateId(),this.sentBytes=0,this.ackedBytes=0,this.chunkSize=2048,this.totalBytes=this.content.size,this.cancelled=!1,this.remoteCancelled=!1,this.cachedReports={}},b.MsrpSender.prototype.setChunkSize=function(a){this.chunkSize=parseInt(a)},b.MsrpSender.prototype.cancel=function(){this.cancelled=!0},b.MsrpSender.prototype.processReport=function(a){var d,e=!0;if(a.reportStatus!==b.MsrpMessage.Status.OK)c.warn("Received Failure REPORT, this means peer stops receiving further chunks."),this.remoteCancelled=!0,this.cancel();else{if(!(parseInt(a.byteRange.start)<=this.ackedBytes+1))return void(this.cachedReports[a.byteRange.start]=parseInt(a.byteRange.end));for(parseInt(a.byteRange.end)>this.ackedBytes?this.ackedBytes=parseInt(a.byteRange.end):this.cachedReports[a.byteRange.start]=parseInt(a.byteRange.end);e;){e=!1;for(d in this.cachedReports)d<=this.ackedBytes+1&&(this.cachedReports[d]>this.ackedBytes&&(this.ackedBytes=this.cachedReports[d]),delete this.cachedReports[d],e=!0)}}this.isFinished()&&(c.debug("All the chunks have been acked, so clear REPORT timer."),
this.content=null,this.cachedReports={})},b.MsrpSender.prototype.createNextChunk=function(){var a=this.sentBytes+1,c=Math.min(this.sentBytes+this.chunkSize,this.totalBytes),d=this.buildByteRange(a,c,this.totalBytes),e=this.content.slice(this.sentBytes,c),f=null;return f=new b.MsrpRequest("SEND",this.messageId,[this.session.localUri],this.session.remoteUri,!0),this.sentBytes=c,f.setContent(e,this.contentType),f.setByteRange(d),f.setEnd(this.sentBytes>=this.totalBytes),f.setCancelled(this.cancelled||this.remoteCancelled),f},b.MsrpSender.prototype.hasMoreChunk=function(){var a=this.totalBytes>0&&this.sentBytes<this.totalBytes;return a},b.MsrpSender.prototype.isLastChunk=function(){return this.sentBytes>=this.totalBytes},b.MsrpSender.prototype.isFinished=function(){return this.cancelled||this.ackedBytes>=this.totalBytes},b.MsrpSender.prototype.buildByteRange=function(a,c,d){var e=new b.MsrpMessage.ByteRange;return a?(0===parseInt(d)?c=0:c||(c="*"),e.init(a,c,d),e):null},a}(wsc||{}),wsc=function(a){"use strict";function b(a,b){var c=0,d=0;a&&(c=a.byteLength),b&&(d=b.byteLength);var e=new Uint8Array(c+d);return a&&e.set(new Uint8Array(a),0),b&&e.set(new Uint8Array(b),c),e.buffer}var c=a._private=a._private||{},d=a.getLogger(),e={INIT:"init",ESTABLISHED:"established",ERROR:"error",CLOSED:"closed"};c.MsrpSession=function(a,b,c,d,f,g,h,i,j){this.state=e.INIT,this.webSocket=a,this.initWebSocket(),this.localUri=h,b.remoteUri instanceof Array?this.remoteUri=b.remoteUri:(this.remoteUri=[],this.remoteUri[0]=b.remoteUri),this.contentType=c,this.isActive=d,this.file=f,this.fileTransferId=g,this.msrpPeerConnection=b,this.offerFileProps=i,this.answerFileProps=j,this.activeInterval=12e4,this.activeTimer=null,this.messageId=null,this.messageIdForActiveSend=null,this.chunkSize=2048,this.senders={},this.receivers={},this.transactions={},this.scheduledSenders=[],this.outgoingSendCounts=0,this.isReadyToClose=!1,this.transactionIdForCancelSend=null,this.sessionCloseTimer=null,this.onMessageSendSuccess=null,this.onMessageReceiveSuccess=null,this.onMessageSendFailure=null,this.getMessageCallback=null,this.getByteContentCallback=null,this.onMessageTyping=null,this.onMessageTypingStop=null,this.onSessionStateChange=null,this.sendStatusCallback=null,this.receiveStatusCallback=null},c.MsrpSession.prototype.changeState=function(a,b){this.state=a,this.onSessionStateChange&&(this.fileTransferId?this.onSessionStateChange({fileTransferId:this.fileTransferId,state:a,description:b}):this.onSessionStateChange({state:a,description:b})),a===e.ESTABLISHED&&(this.msrpPeerConnection.ftIdToSessions[this.fileTransferId]=this,this.isActive&&(this.messageIdForActiveSend=this.send(null)),this.file&&this.file instanceof File&&this.file.size>0&&this.send(this.file))},c.MsrpSession.prototype.isFile=function(){return this.fileTransferId?!0:!1},c.MsrpSession.prototype.initWebSocket=function(){var a=this;this.webSocket.onopen=function(b){d.debug("MSRP WebSocket onopen() is invoked."),a.changeState(e.ESTABLISHED,"MSRP Session established"),this.binaryType="arraybuffer"},this.webSocket.onclose=function(b){d.debug("MSRP WebSocket onclose() is invoked. "+a.fileTransferId||""),a.webSocket=null,a.close()},this.webSocket.onmessage=function(b){var c=b.data;c&&a.onMessage(c)},this.webSocket.onerror=function(b){d.debug("MSRP WebSocket onerror() is invoked."),a.cleanUp(),a.changeState(e.ERROR,"MSRP WebSocket error happens.")}},c.MsrpSession.prototype.assertEstablished=function(){if(this.state!==e.ESTABLISHED){var a="Session state is not ESTABLISHED, cannot execute the task now ! ";throw d.error(a),a}},c.MsrpSession.prototype.send=function(a){this.assertEstablished();var b=null,e=null;return a&&(a instanceof File?(d.debug("Send a file ..."),e=a):a.contentType&&(this.contentType=a.contentType,e=a.content)),b=new c.MsrpSender(this,e),b.setChunkSize(this.chunkSize),this.messageId=b.messageId,this.senders[b.messageId]=b,this.scheduledSenders.push(b),d.debug("Schedule sender task, put it to scheduledSenders list, messageId = ["+b.messageId+"]"),this.executeScheduledTask(),this.messageId},c.MsrpSession.prototype.executeScheduledTask=function(){for(var a=0,b=null,c=null,e=null;this.scheduledSenders.length>0&&this.outgoingSendCounts<16&&2>a;)b=this.scheduledSenders[0],c=b.createNextChunk(),e=c.build(),this.webSocket.send(e),(b.cancelled||b.remoteCancelled)&&(this.scheduledSenders.shift(),this.transactionIdForCancelSend=c.transactionId),this.sendStatusCallback&&this.sendStatusCallback({fileTransferId:this.fileTransferId,range:{start:c.byteRange.start,end:c.byteRange.end,total:c.byteRange.total}}),this.transactions[c.transactionId]=c,this.outgoingSendCounts++,a++,b.isLastChunk()&&(d.debug("Sender ["+b.messageId+"] completes sending data, remove it from scheduledSenders list."),this.scheduledSenders.shift())},c.MsrpSession.prototype.cancel=function(){this.assertEstablished();var a=this.senders[this.messageId],b=this.receivers[this.messageId];a?a.cancel():b?b.cancel():d.warn("No MsrpSender or MsrpReceiver is found, nothing is done !")};var f="",g=null;return c.MsrpSession.prototype.isEndOfChunk=function(a){var b=/(-{7}.*[\$#+])/g,c=!1;if(a instanceof ArrayBuffer){var d,e=new Uint8Array(a),f=e.length;if(f>0&&(d=e[f-1],10==d)){var h,i=0;for(h=f-2;h>=0&&(13!=e[h]||2!=++i);h--);var j=e.subarray(h);b.exec(String.fromCharCode.apply(null,j))&&(c=!0,g.contentEndIdx=h)}}else(a instanceof String||"string"==typeof a)&&b.exec(a)&&(c=!0);return c},c.MsrpSession.prototype.onMessage=function(a){this.assertEstablished(),a instanceof ArrayBuffer?g=b(g,a):(a instanceof String||"string"==typeof a)&&(f=f.concat(a));var e;if(g?this.isEndOfChunk(g)&&(e=c.MsrpMessage.parseMessage(g),g=null):this.isEndOfChunk(f)&&(e=c.MsrpMessage.parseMessage(f),f=""),e)if(e instanceof c.MsrpRequest)switch(e.method){case"SEND":this.messageId=e.messageId,this.onIncomingSend(e);break;case"REPORT":this.onIncomingReport(e)}else e instanceof c.MsrpResponse?this.onIncomingResponse(e):d.warn("MsrpSession received unkown message, ignore it. message = "+a)},c.MsrpSession.prototype.indicateComposing=function(a){var b=c.MsrpMessage.createIndication([this.localUri],this.remoteUri,a);this.webSocket.send(b.build())},c.MsrpSession.prototype.processIndicationMessage=function(a){var b=null,e=null,f=null;if(!this.isFile()&&a.content&&(a.content instanceof Uint8Array?b=String.fromCharCode.apply(null,a.content):(a.content instanceof String||"string"==typeof a.content)&&(b=a.content),b&&b.indexOf("</isComposing>")>-1&&(d.debug("Receive Indication message, content = ["+b+"]"),window.DOMParser?(e=new DOMParser,f=e.parseFromString(b,"text/xml")):(f=new ActiveXObject("Microsoft.XMLDOM"),f.async=!1,f.loadXML(b)))),f){var g=null,h=this,i=f.getElementsByTagName("state")[0].textContent,j=f.getElementsByTagName("refresh");return g=new c.MsrpResponse(a.transactionId,c.MsrpMessage.Status.OK,a.toPath,a.fromPath,!0),this.webSocket.send(g.build()),"active"===i&&this.onMessageTyping?(this.onMessageTyping(),j&&(this.activeInterval=1e3*parseInt(j[0].textContent)),h.onMessageTypingStop&&(this.activeTimer&&this.clearActiveTimer(),this.activeTimer=setTimeout(function(){h.onMessageTypingStop(),h.activeTimer=null},h.activeInterval))):"idle"===i&&this.onMessageTypingStop&&(this.onMessageTypingStop(),this.clearActiveTimer()),!0}return this.activeTimer&&(this.clearActiveTimer(),this.onMessageTypingStop&&this.onMessageTypingStop()),!1},c.MsrpSession.prototype.clearActiveTimer=function(){this.activeTimer&&(clearTimeout(this.activeTimer),this.activeTimer=null)},c.MsrpSession.prototype.onIncomingSend=function(a){if(!this.processIndicationMessage(a)){this.clearActiveTimer();var b=a.messageId,e=this.receivers[b];null==e&&(d.debug("There is no receiver for message - ["+b+"], so create a new one and cache it."),e=new c.MsrpReceiver(this),this.getMessageCallback&&(e.getMessageCallback=this.getMessageCallback),this.getByteContentCallback&&(e.getByteContentCallback=this.getByteContentCallback),e.wholeMessageReceived=this.onMessageReceiveSuccess,e.onReceiveProgress=this.receiveStatusCallback,this.receivers[b]=e),e.onReceived(a),"yes"===a.getHeader("Success-Report")&&this.sendReport(a),a.flag===c.MsrpMessage.Flag.ABORT&&this.isReadyToClose&&(this.doClose(),this.sessionCloseTimer&&(clearTimeout(this.sessionCloseTimer),this.sessionCloseTimer=null))}},c.MsrpSession.prototype.onIncomingReport=function(a){var b,e=a.messageId,f=null,g=null;return f=this.senders[e],null==f?void d.warn("There is no cached MsrpSender for REPORT - ["+e+"]."):(g=new c.MsrpResponse(a.transactionId,c.MsrpMessage.Status.OK,a.toPath,a.fromPath,!0),g.reason="Report received",g.addHeader("Byte-Range",a.byteRange),b=g.build(),this.webSocket.send(b),f.processReport(a),void(f.isFinished()&&(d.debug("MsrpSender - ["+e+"] is finished, so delete it from cache map."),delete this.senders[e],a.reportStatus===c.MsrpMessage.Status.OK?null!==this.onMessageSendSuccess&&(d.debug("Received Success REPORT, then inform application that message is sent sccessfully."),this.fileTransferId?this.onMessageSendSuccess(this.fileTransferId):this.onMessageSendSuccess(e)):null!==this.onMessageSendFailure&&(d.warn("Received Failure REPORT, then inform application that message is sent failed."),this.fileTransferId?this.onMessageSendFailure(this.fileTransferId,a.reportStatus,a.reportReason):this.onMessageSendFailure(e,a.reportStatus,a.reportReason)))))},c.MsrpSession.prototype.onIncomingResponse=function(a){var b=null,d=null,e=null;return this.transactionIdForCancelSend&&this.transactionIdForCancelSend===a.transactionId&&this.isReadyToClose?(this.doClose(),void(this.sessionCloseTimer&&(clearTimeout(this.sessionCloseTimer),this.sessionCloseTimer=null))):(b=this.transactions[a.transactionId],void(null!=b&&("REPORT"===b.method||"SEND"===b.method&&(this.outgoingSendCounts--,d=b.messageId,e=this.senders[d],a.status===c.MsrpMessage.Status.OK?b.flag===c.MsrpMessage.Flag.END&&this.onMessageSendSuccess&&(d!==this.messageIdForActiveSend||this.file&&0===this.file.size)&&(this.fileTransferId?this.onMessageSendSuccess(this.fileTransferId):this.onMessageSendSuccess(d)):(e&&(e.remoteCancelled=!0,e.cancel(),delete this.senders[d]),null!==this.onMessageSendFailure&&d!==this.messageIdForActiveSend&&(this.fileTransferId?this.onMessageSendFailure(this.fileTransferId,a.status,a.reason):this.onMessageSendFailure(d,a.status,a.reason))),this.executeScheduledTask()),delete this.transactions[a.transactionId])))},c.MsrpSession.prototype.sendReport=function(a){var b=null,d=null;b=new c.MsrpRequest("REPORT",a.messageId,a.toPath,a.fromPath,!0),b.setByteRange(a.byteRange),b.addHeader("Status","000 200 OK"),this.transactions[b.transactionId]=b,d=b.build(),this.webSocket.send(d)},c.MsrpSession.prototype.close=function(){var a=this;return this.state===e.CLOSED?null:(this.isReadyToClose=!0,void(this.sessionCloseTimer=setTimeout(function(){a.doClose(),a.sessionCloseTimer=null},3e3)))},c.MsrpSession.prototype.doClose=function(){this.webSocket&&(d.debug("MsrpSession close is invoked, so close WebSocket normally."),this.webSocket.close(1e3,"Normal close"),this.webSocket=null),this.cleanUp(),this.changeState(e.CLOSED,"Msrp Session closed.")},c.MsrpSession.prototype.cleanUp=function(){this.localUri=null,this.remoteUri=null,this.senders=null,this.receivers=null,this.transactions=null,this.scheduledSenders=null,this.outgoingSendCounts=0,d.debug("Clean up resources when close MsrpSession.")},a}(wsc||{}),wsc=function(a){var b=a._private=a._private||{},c=a.getLogger();return b.MsrpUri=function(){this.scheme="msrp",this.userInfo=null,this.host="",this.port=null,this.sessionId=null,this.transport="ws"},b.MsrpUri.prototype.isSecure=function(){return"msrps"===this.scheme.toLowerCase()?!0:!1},b.MsrpUri.prototype.parse=function(a){var b,d,e,f,g,h;return b=a.split("://"),b.length<2?(c.error("Invalid MSRP URI: "+a),null):(this.scheme=b[0],"msrp"!==this.scheme&&"msrps"!==this.scheme?(c.error("Unknown scheme for MSRP URI: "+this.scheme),null):(d=b[1],f=d.indexOf("/"),0===f?(c.error("Invalid MSRP URI, no authority: "+a),null):(g=d.indexOf(";"),0===g?(c.error("Invalid MSRP URI, no authority: "+a),null):-1===g?(c.error("Invalid MSRP URI, no transport: "+a),null):(-1===f?h=d.slice(0,g):(h=d.slice(0,f),this.sessionId=d.slice(f+1,g)),this.transport=d.slice(g+1),""===this.transport?(c.error("Invalid MSRP URI, no transport: "+a),null):(e=h.indexOf("@"),-1!==e?(this.userInfo=h.slice(0,e),d=h.slice(e+1)):d=h,e=d.indexOf(":"),-1!==e?(this.host=d.slice(0,e),this.port=d.slice(e+1)):this.host=d,""===this.host?(c.error("Invalid MSRP URI, no host: "+a),null):this)))))},b.MsrpUri.prototype.toString=function(){var a="",b="";return this.userInfo&&(b=this.userInfo+"@"),b+=this.host,this.port&&(b=b+":"+this.port),a=a+this.scheme+"://"+b,this.sessionId&&(a=a+"/"+this.sessionId),a=a+";"+this.transport},a}(wsc||{}),wsc=function(a){"use strict";var b=a._private=a._private||{},c=b.MsrpPeerConnection,d=b.SDP,e=(b.CallStateMachine,b.CallCommonUtils),f=b.offerAnswerManager,g={},h=b.wscConst,i=b.wscUtils,j=a.getLogger();return a.FileTransferPackage=function(a,b){this.session=a,this.packageType=null,b?this.packageType=b:this.packageType=h.PACKAGE.FILE_TRANSFER,a.registerPackage(this),this.onFileTransfer=null},a.FileTransferPackage.prototype.createFileTransfer=function(a){var b;if(null==a||""===a)throw"target can not be empty";return b=this.prepareFileTransfer(this.session,a),b.subSessionId=this.session.generateSubSessionId(),b.pkgInstance=this,this.put(b.subSessionId,b),b},a.FileTransferPackage.prototype.put=function(a,b){this.session.putSubSession(this.packageType,a,b)},a.FileTransferPackage.prototype.getFileTransfers=function(){var a=this.session.getSubSessionsByPackageType(this.packageType),b=a.values();return b},a.FileTransferPackage.prototype.close=function(){for(var a=this.getFileTransfers(),b=0;b<a.length;b++){var c=a[b];c.abort(),c=null}},a.FileTransferPackage.prototype.clear=function(){for(var a=this.getFileTransfers(),b=0;b<a.length;b++){var c=a[b];e.clearMsrpSubSession(c)}},a.FileTransferPackage.prototype.toJSON=function(){var a={session:""};return i.toJSON(a,this)},a.FileTransferPackage.prototype.prepareFileTransfer=function(b,c){return new a.FileTransfer(b,c)},a.FileTransferPackage.prototype.onMessage=function(a){var b=a.control.subsession_id,c=this.session.getSubSession(b),d=a.getExtHeaders();null==c&&(c=this.prepareFileTransfer(this.session,this.session.userName),c.pkgInstance=this),d&&(c.lastServerExtHeader=d),c.onMessage(a)},a.FileTransfer=function(b,d){this.session=b,this.subSessionId=b.generateSubSessionId(),this.caller=b.getUserName(),this.callee=d,this.callState=new a.CallState(h.CALLSTATE.NONE),this.msrpPeerConnection=new c,this.msrpSession=null,this.fileConfigs=[],this.offerAnswerManager=new f(this),this.participants=null,this._private={},this.onStateChange=null,this.onConnectionStateChange=null,this.onFileData=null,this.onProgress=null,this.onFileTransferSuccess=null,this.onFileTransferFailure=null,g.initMsrpPeerConnection(this),this._template={doStartCallRequest:function(a){var b=a.control.subsession_id,c=a.payload.sdp,d=a.getExtHeaders(),e=g.getFileConfigsFromOffer(c);this.parent.setFileConfigs(e),this.parent.pkgInstance.put(b,this.parent),this.parent._private.remoteSdp=c;var f=this.parent.pkgInstance.onFileTransfer;f?f(this.parent,d):j.warn("No onFileTransfer callback.")},doUpdateCallRequest:function(a){var b=(a.control.subsession_id,a.payload.sdp),c=a.getExtHeaders(),d=g.getFileConfigsFromOffer(b);this.parent.setFileConfigs(d),this.parent._private.remoteSdp=b,this.parent.accept(d,c)},doStart2XXResponse:function(a){var b=a.payload.sdp,c=g.getFileConfigsFromAnswer(this.parent,b);this.parent.setFileConfigs(c),this.parent.msrpPeerConnection.processFtAnswer(b)},doUpdate200Response:function(a){var b=a.payload.sdp,c=g.getFileConfigsFromAnswer(this.parent,b);this.parent.setFileConfigs(c),this.parent.msrpPeerConnection.processFtAnswer(b)}},this._template.parent=this},a.FileTransfer.prototype.addParticipants=function(a){e.addParticipants2MsrpSubSession(a,this)},a.FileTransfer.prototype.start=function(a,b){g.sendStartRequest(this,a,b)},a.FileTransfer.prototype.accept=function(a,b){if(this.callState.isFinalState())e.clearMsrpSubSession(this);else{a&&(a instanceof Array||(a=[a]));var c,d=this.lastServerCorrelationId;try{c=this.msrpPeerConnection.acceptFtOffer(this._private.remoteSdp,a)}catch(f){return j.debug("Accept file transfer offer exception: "+f.message),void this.setCallState(h.CALLSTATE.FAILED,null,f.message)}e.sendAcceptResponse(this,d,c,b),j.debug("Sending answer sdp\r\n"+c),a&&this.setFileConfigs(a),this.setCallState(h.CALLSTATE.RESPONDED,200,"sent success response"),this.offerAnswerManager.updateState(h.OFFER_ANSWER_STATE.ANSWER_SENT,c)}},a.FileTransfer.prototype.decline=function(a,b,c){e.msrpSubSessionDecline(this,a,b,c)},a.FileTransfer.prototype.abort=function(a){!a||a instanceof Array||(a=[a]);var b=g.getFileIdsFromConfig(a),c=g.getFileIdsFromConfig(this.fileConfigs);b&&g.ensureFileIdsValid(b,c);var d;a&&b&&b.length<c.length?(d=this.msrpPeerConnection.abortFt(b),null!=d&&""!=d.trim()&&g.sendUpdateRequest(this,d)):(d=this.msrpPeerConnection.abortFt(c),g.sendShutdown(this))},a.FileTransfer.prototype.setCallState=function(a,b,c){e.setCallState(this,a,b,c)},a.FileTransfer.prototype.getInitiator=function(){return this.caller},a.FileTransfer.prototype.getTarget=function(){return this.callee},a.FileTransfer.prototype.onMessage=function(a){e.onMessage(a,this)},a.FileTransfer.prototype.getFileConfigs=function(){return this.fileConfigs},a.FileTransfer.prototype.setFileConfigs=function(a){this.fileConfigs=a},a.FileTransfer.prototype.setSecure=function(a){this.msrpPeerConnection.secure=a},a.FileTransfer.prototype.setChunkSize=function(a){if(!(a&&a>0))throw{name:"IllegalArgumentException",message:"chunk size can only be positive number."};this.chunkSize=a},a.FileTransfer.prototype.getState=function(){return this.callState},a.FileTransfer.prototype.toJSON=function(){var a={caller:this.caller,callee:this.callee,callState:this.callState,subSessionId:this.subSessionId};return a},g.initMsrpPeerConnection=function(a){var b=a.msrpPeerConnection;b.onSession=function(b){j.debug("Get MsrpPeerConnection onSession event."),b?(a.msrpSession=b,a.chunkSize&&(b.chunkSize=a.chunkSize),a.msrpSession.onSessionStateChange=function(b){a.onConnectionStateChange&&a.onConnectionStateChange(b),"established"===b&&g.initFileTransferCallback(a)},g.initFileTransferCallback(a)):j.error("Get NULL MsrpPeerConnection.")}},g.initFileTransferCallback=function(a){a.msrpSession.onSessionStateChange=a.onConnectionStateChange,a.msrpSession.getByteContentCallback=a.onFileData,a.msrpSession.sendStatusCallback=a.msrpSession.receiveStatusCallback=a.onProgress,a.msrpSession.onMessageSendSuccess=function(b){a.onFileTransferSuccess&&a.onFileTransferSuccess(b),a._private.sendSuccessCount=a._private.sendSuccessCount=a._private.sendSuccessCount+1||1,a._private.sendSuccessCount===a.getFileConfigs().length&&g.sendShutdown(a)},a.msrpSession.onMessageReceiveSuccess=a.onFileTransferSuccess,a.msrpSession.onMessageSendFailure=a.onFileTransferFailure,a.msrpSession.onMessageReceiveFailure=a.onFileTransferFailure},g.sendStartRequest=function(a,b,c){if(a.callState.state!==h.CALLSTATE.NONE)throw{name:"IllegalStateException",message:"FileTransfer has already started."};if(!b)throw{name:"IllegalArgumentException",message:"fileConfigs can not be empty."};b instanceof Array||(b=[b]);var d=e.createRequest(a),f=a.session.genNewCorrelationId(),g=a.msrpPeerConnection.createFtOffer(b);d.header.action=h.ACTION.START,d.control.correlation_id=f,d.payload={sdp:g},c&&d.addExtHeaders(c),a.participants&&d.addExtHeaders({participants:a.participants.join()}),a.authInfo&&(d.header.authorization=a.authInfo,a.authInfo=null),a.session.sendMessage(d),a.startReqCorrId=d.control.correlation_id,a.setFileConfigs(b),j.debug("Sending offer sdp\r\n"+g),a.offerAnswerManager.updateState(h.OFFER_ANSWER_STATE.OFFER_SENT,g),a.callState.state===h.CALLSTATE.NONE&&a.setCallState(h.CALLSTATE.STARTED,null,"start")},g.sendUpdateRequest=function(a,b,c){if(a.callState.state!==h.CALLSTATE.ESTABLISHED)throw{name:"IllegalStateException",message:"Cannot update the FileTransfer now."};var d=e.createRequest(a),f=a.session.genNewCorrelationId();d.header.action=h.ACTION.START,d.control.correlation_id=f,d.payload={sdp:b},c&&d.addExtHeaders(c),a.authInfo&&(d.header.authorization=a.authInfo,a.authInfo=null),a.session.sendMessage(d),a.startReqCorrId=d.control.correlation_id,j.debug("Sending offer sdp\r\n"+b),a.offerAnswerManager.updateState(h.OFFER_ANSWER_STATE.OFFER_SENT,b)},g.sendShutdown=function(a,b){var c=e.createMessage(a);c.header.action=h.ACTION.SHUTDOWN,c.addExtHeaders(b),a.callState.state===h.CALLSTATE.NONE||a.callState.isFinalState()||(a.callState.hasEstablished()?c.control.correlation_id=a.session.genNewCorrelationId():c.control.correlation_id=a.startReqCorrId,a.session.sendMessage(c)),e.clearMsrpSubSession(a),a.setCallState(h.CALLSTATE.ENDED,null,"")},g.getFileConfigsFromOffer=function(a){var b,c,e=(new d).parse(a),f=e.mediaArray,g=[];if(f)for(var h=0;h<f.length;h++)b=f[h],0!==b.port&&(c=b.getFileProps(),g.push({props:c}));return g},g.getFileConfigsFromAnswer=function(a,b){var c,e=(new d).parse(b),f=e.mediaArray,g=[],h=a.getFileConfigs();if(f)for(var i=0;i<f.length;i++)c=f[i],0!==c.port&&g.push(h[i]);return g},g.getFileIdsFromConfig=function(a){if(a&&a instanceof Array){for(var b=[],c=0;c<a.length;c++)b.push(a[c].props.fileTransferId);return b}return null},g.ensureFileIdsValid=function(a,b){for(var c=0;c<a.length;c++)if(-1===b.indexOf(a[c]))throw{name:"IllegalArgumentException",message:"Invalid file transfer id: "+a[c]}},a}(wsc||{});